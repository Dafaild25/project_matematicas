{% extends template_base|default:"plantillas/MasterEstudiante.html" %}
{% load static %}
{% block title %}
    {% if es_docente %}
        Docente - Probando {{nivel.niv_nombre}}
    {% else %}
        Estudiantes_Modulos
    {% endif %}
{% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/Modulo-1/primer-nivel.css' %}">
<style>
        body {
            background: linear-gradient(-45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #ffa726, #ef5350);
            background-size: 400% 400%;
            animation: rainbowShift 8s ease infinite;
            min-height: 100vh;
            font-family: 'Comic Sans MS', cursive, sans-serif;
            overflow-x: hidden;
        }

        @keyframes rainbowShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .main-container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

         .card-header {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            color: white;
            padding: 25px;
            text-align: center;
        }

        .card-header h2 {
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin: 0;
        }

        .header-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            text-align: center;
            animation: bounceIn 1s ease-out;
            border: 5px solid #ff6b6b;
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }

        .header-card h1 {
            color: #ff6b6b;
            font-size: 3rem;
            font-weight: 900;
            margin-bottom: 15px;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.3);
            animation: wiggle 2s ease-in-out infinite;
        }

        @keyframes wiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(1deg); }
            75% { transform: rotate(-1deg); }
        }

        .header-card p {
            color: #333;
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .game-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            border: 5px solid #4ecdc4;
            animation: slideInUp 1s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(100px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .instruction-card {
            background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 100%);
            color: white;
            padding: 25px;
            border-radius: 25px;
            margin-bottom: 30px;
            text-align: center;
            font-size: 1.8rem;
            font-weight: 800;
            box-shadow: 0 15px 30px rgba(255, 107, 107, 0.4);
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { box-shadow: 0 15px 30px rgba(255, 107, 107, 0.4); }
            to { box-shadow: 0 15px 30px rgba(255, 107, 107, 0.8); }
        }

        .numbers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .number-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 100%);
            border: none;
            border-radius: 25px;
            padding: 30px 20px;
            font-size: 2.5rem;
            font-weight: 900;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 15px 30px rgba(255, 107, 107, 0.4);
            position: relative;
            overflow: hidden;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            animation: numberFloat 4s ease-in-out infinite;
        }

        @keyframes numberFloat {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            25% { transform: translateY(-5px) rotate(1deg); }
            75% { transform: translateY(5px) rotate(-1deg); }
        }

        .number-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.6s;
        }

        .number-btn:hover::before {
            left: 100%;
        }

        .number-btn:hover {
            transform: scale(1.2) translateY(-10px) rotate(5deg);
            box-shadow: 0 25px 50px rgba(255, 107, 107, 0.6);
            animation-play-state: paused;
        }

        .number-btn:active {
            transform: scale(1.1) translateY(-5px);
        }

        .number-btn.selected {
            background: linear-gradient(135deg, #ffa726 0%, #ff9800 100%);
            box-shadow: 0 15px 30px rgba(255, 167, 38, 0.6);
            transform: scale(1.1);
            border: 4px solid #fff;
        }

        .number-btn.correct-answer {
            background: linear-gradient(135deg, #96ceb4 0%, #45b7d1 100%);
            box-shadow: 0 15px 30px rgba(150, 206, 180, 0.6);
            animation: correctCelebration 1s ease;
        }

        .number-btn.incorrect-answer {
            background: linear-gradient(135deg, #ef5350 0%, #ffa726 100%);
            box-shadow: 0 15px 30px rgba(239, 83, 80, 0.6);
            animation: incorrectShake 0.6s ease;
        }

        @keyframes correctCelebration {
            0% { transform: scale(1); }
            25% { transform: scale(1.3) rotate(10deg); }
            50% { transform: scale(1.4) rotate(-10deg); }
            75% { transform: scale(1.3) rotate(10deg); }
            100% { transform: scale(1.2); }
        }

        @keyframes incorrectShake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-15px) rotate(-5deg); }
            20%, 40%, 60%, 80% { transform: translateX(15px) rotate(5deg); }
        }

        .answer-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 100%);
            color: white;
            border: none;
            padding: 20px 50px;
            border-radius: 50px;
            font-size: 1.8rem;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 15px 30px rgba(255, 107, 107, 0.4);
            display: block;
            margin: 0 auto;
            animation: rainbow 3s ease-in-out infinite;
        }

        @keyframes rainbow {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }

        .answer-btn:hover {
            transform: scale(1.1) translateY(-5px);
            box-shadow: 0 20px 40px rgba(255, 107, 107, 0.6);
        }

        .answer-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            animation: none;
        }

        .floating-elements {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .floating-element {
            position: absolute;
            font-size: 2rem;
            animation: floatAround 8s infinite ease-in-out;
            opacity: 0.7;
        }

        @keyframes floatAround {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.7; }
            25% { transform: translateY(-30px) rotate(90deg); opacity: 1; }
            50% { transform: translateY(-20px) rotate(180deg); opacity: 0.8; }
            75% { transform: translateY(-40px) rotate(270deg); opacity: 1; }
        }

        .confetti {
            position: fixed;
            top: -10px;
            background-color: #f0f0f0;
            width: 10px;
            height: 10px;
            animation: confetti 3s ease-in-out infinite;
            pointer-events: none;
            z-index: 1000;
        }

        @keyframes confetti {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .question-counter {
            background: linear-gradient(135deg, #45b7d1 0%, #96ceb4 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 20px;
            text-align: center;
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 20px;
            box-shadow: 0 10px 20px rgba(69, 183, 209, 0.3);
        }

        /* Estilo para la tabla de opciones m√∫ltiples */
        .multiple-choice-table {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .multiple-choice-table h3 {
            color: #ff6b6b;
            text-align: center;
            font-size: 1.8rem;
            margin-bottom: 20px;
            font-weight: 800;
        }

        .choice-row {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.7);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 3px solid transparent;
        }

        .choice-row:hover {
            background: rgba(255, 107, 107, 0.1);
            transform: translateX(10px);
        }

        .choice-row.selected {
            background: rgba(255, 167, 38, 0.2);
            border-color: #ffa726;
            transform: translateX(10px);
        }

        .choice-label {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
            margin-right: 20px;
            min-width: 200px;
        }

        .choice-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .choice-option {
            background: linear-gradient(135deg, #4ecdc4 0%, #45b7d1 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 15px;
            font-size: 1.3rem;
            font-weight: 700;
            min-width: 60px;
            text-align: center;
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .choice-option:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 16px rgba(78, 205, 196, 0.4);
        }

        .choice-option.selected {
            background: linear-gradient(135deg, #ffa726 0%, #ff9800 100%);
            border-color: #fff;
            transform: scale(1.1);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-card h1 { font-size: 2.5rem; }
            .header-card p { font-size: 1.5rem; }
            .numbers-grid { grid-template-columns: repeat(2, 1fr); gap: 20px; }
            .number-btn { font-size: 2rem; padding: 25px 15px; }
            .main-container { padding: 15px; }
            .choice-row { flex-direction: column; align-items: flex-start; }
            .choice-label { margin-bottom: 10px; min-width: auto; }
        }

        @media (max-width: 480px) {
            .header-card h1 { font-size: 2rem; }
            .header-card p { font-size: 1.3rem; }
            .number-btn { font-size: 1.8rem; padding: 20px 12px; }
            .instruction-card { font-size: 1.5rem; }
        }

        /* Estilos para drag and drop */
        .drag-drop-question {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .drag-numbers-to-sort {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .drag-sortable-number {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: grab;
            font-weight: bold;
            font-size: 18px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            user-select: none;
        }

        .drag-sortable-number:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .drag-sortable-number.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
            cursor: grabbing;
        }

        .drag-drop-zone {
            background: #f1f3f4;
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            min-height: 80px;
            align-items: center;
            flex-wrap: wrap;
        }

        .drag-drop-slot {
            width: 80px;
            height: 60px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            background: white;
            transition: all 0.3s ease;
        }

        .drag-drop-slot::before {
            content: attr(data-position);
            position: absolute;
            top: -25px;
            font-size: 12px;
            color: #666;
            font-weight: bold;
        }

        .drag-drop-slot.drag-over {
            border-color: #4CAF50;
            background: #e8f5e8;
            transform: scale(1.05);
        }

        .drag-drop-slot.filled {
            border-color: #4CAF50;
            background: #e8f5e8;
        }

        .drag-dropped-number {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
            padding: 10px;
            border-radius: 6px;
            font-weight: bold;
            cursor: grab;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
        }


        
        /* Estilos para la pregunta de unir con l√≠neas */
        .matching-question {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .matching-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 40px;
            margin-top: 30px;
        }

        .matching-left-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
            flex: 0 0 200px;
        }

        .matching-right-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            flex: 1;
        }

        .matching-number {
            background: white;
            border: 4px solid #ddd;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 2rem;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .matching-number:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .matching-number.selected {
            border-width: 6px;
            transform: scale(1.05);
        }

        /* Colores para cada n√∫mero */
        .matching-number[data-number="15"] {
            color: #e74c3c;
        }
        .matching-number[data-number="15"].selected {
            border-color: #e74c3c;
            background: #ffe6e6;
        }

        .matching-number[data-number="23"] {
            color: #3498db;
        }
        .matching-number[data-number="23"].selected {
            border-color: #3498db;
            background: #e6f3ff;
        }

        .matching-number[data-number="31"] {
            color: #27ae60;
        }
        .matching-number[data-number="31"].selected {
            border-color: #27ae60;
            background: #e6ffe6;
        }

        .matching-number[data-number="47"] {
            color: #f39c12;
        }
        .matching-number[data-number="47"].selected {
            border-color: #f39c12;
            background: #fff8e6;
        }

        .matching-dots {
            background: white;
            border: 4px solid #ddd;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .matching-dots:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .matching-dots.matched-15 {
            border-color: #e74c3c;
            background: #ffe6e6;
        }

        .matching-dots.matched-23 {
            border-color: #3498db;
            background: #e6f3ff;
        }

        .matching-dots.matched-31 {
            border-color: #27ae60;
            background: #e6ffe6;
        }

        .matching-dots.matched-47 {
            border-color: #f39c12;
            background: #fff8e6;
        }

        .dots-container {
            text-align: center;
        }

        .emoji-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 3px;
            max-width: 200px;
        }

        .emoji {
            font-size: 1.2rem;
            line-height: 1;
        }

        .quantity-label {
            font-size: 1.5rem;
            font-weight: bold;
            color: #666;
            margin-bottom: 10px;
        }

        .instruction {
            text-align: center;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 1.1rem;
            color: #444;
        }

        .reset-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .reset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* Estilos para hacer el ejercicio m√°s atractivo para ni√±os */
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One:wght@400&family=Nunito:wght@400;600;700&display=swap');

        .number-write-question {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            border-radius: 25px !important;
            padding: 30px !important;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15) !important;
            margin: 20px 0 !important;
            position: relative;
            overflow: hidden;
        }

        .number-write-question::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: sparkle 4s ease-in-out infinite;
            z-index: 0;
        }

        @keyframes sparkle {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(3deg); }
        }

        .number-write-question h3 {
            font-family: 'Fredoka One', cursive !important;
            font-size: 2.2rem !important;
            text-align: center !important;
            margin-bottom: 25px !important;
            color: white !important;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3) !important;
            position: relative;
            z-index: 1;
            animation: bounce 2s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-8px); }
            60% { transform: translateY(-4px); }
        }

        .write-row {
            display: flex !important;
            align-items: center !important;
            margin-bottom: 20px !important;
            padding: 18px !important;
            background: white !important;
            border-radius: 20px !important;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
            transition: all 0.3s ease !important;
            position: relative;
            z-index: 1;
        }

        .write-row:hover {
            transform: translateY(-3px) scale(1.02) !important;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2) !important;
        }

        .write-row:nth-child(2) {
            background: linear-gradient(135deg, #ffeaa7, #fab1a0) !important;
        }

        .write-row:nth-child(3) {
            background: linear-gradient(135deg, #a8e6cf, #88d8a3) !important;
        }

        .write-row:nth-child(4) {
            background: linear-gradient(135deg, #ffd3a5, #fd9853) !important;
        }

        .write-row:nth-child(5) {
            background: linear-gradient(135deg, #d1c4e9, #b39ddb) !important;
        }

        .write-row:nth-child(6) {
            background: linear-gradient(135deg, #ffcdd2, #f8bbd9) !important;
        }

        .emoji-display {
            flex: 1 !important;
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            margin-right: 25px !important;
        }

        .emoji-number {
            font-size: 3.5rem !important;
            margin-bottom: 8px !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            animation: gentle-bounce 3s ease-in-out infinite !important;
        }

        .emoji-number:hover {
            transform: scale(1.2) rotate(5deg) !important;
            animation: wiggle 0.6s ease-in-out !important;
        }

        @keyframes gentle-bounce {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }

        @keyframes wiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-8deg) scale(1.1); }
            75% { transform: rotate(8deg) scale(1.1); }
        }

        .emoji-label {
            font-family: 'Nunito', sans-serif !important;
            font-weight: 700 !important;
            font-size: 1.1rem !important;
            color: #333 !important;
            text-align: center !important;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.8) !important;
        }

        .write-input {
            width: 120px !important;
            height: 60px !important;
            border: 3px solid #ff6b6b !important;
            border-radius: 15px !important;
            font-size: 2.2rem !important;
            font-weight: bold !important;
            text-align: center !important;
            background: rgba(255,255,255,0.95) !important;
            color: #333 !important;
            transition: all 0.3s ease !important;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1), 0 5px 15px rgba(0,0,0,0.1) !important;
            font-family: 'Nunito', sans-serif !important;
        }

        .write-input:focus {
            outline: none !important;
            border-color: #4ecdc4 !important;
            transform: scale(1.1) !important;
            box-shadow: 0 0 25px rgba(78, 205, 196, 0.4), inset 0 2px 5px rgba(0,0,0,0.1) !important;
            background: white !important;
        }

        .write-input::placeholder {
            color: #bbb !important;
            font-size: 1.4rem !important;
        }

        /* Animaciones adicionales para hacer m√°s din√°mico */
        .write-row:nth-child(2) .emoji-number { animation-delay: 0.2s; }
        .write-row:nth-child(3) .emoji-number { animation-delay: 0.4s; }
        .write-row:nth-child(4) .emoji-number { animation-delay: 0.6s; }
        .write-row:nth-child(5) .emoji-number { animation-delay: 0.8s; }
        .write-row:nth-child(6) .emoji-number { animation-delay: 1s; }

        /* Efectos de validaci√≥n */
        .write-input:valid {
            border-color: #00b894 !important;
            background: #d1f2eb !important;
        }

        .write-input:invalid:not(:placeholder-shown) {
            border-color: #e17055 !important;
            background: #ffeaa7 !important;
        }

        /* Responsive para m√≥viles */
        @media (max-width: 600px) {
            .number-write-question {
                padding: 20px !important;
                margin: 10px !important;
            }
            
            .number-write-question h3 {
                font-size: 1.8rem !important;
            }
            
            .write-row {
                flex-direction: column !important;
                text-align: center !important;
                padding: 15px !important;
            }
            
            .emoji-display {
                margin-right: 0 !important;
                margin-bottom: 15px !important;
            }
            
            .emoji-number {
                font-size: 3rem !important;
            }
            
            .write-input {
                width: 100px !important;
                height: 50px !important;
                font-size: 2rem !important;
            }
        }

        .option-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .option-btn.selected {
            background: #ffeaa7 !important;
            color: #2d3436 !important;
            transform: scale(1.1);
        }

        .sequence-box.empty:hover {
            transform: scale(1.05);
            background: rgba(255,255,255,0.5) !important;
        }

        .sequence-box.correct {
            background: #00b894 !important;
            color: white !important;
            animation: bounce 0.6s ease-in-out;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        @media (max-width: 768px) {
            .sequence-boxes {
                gap: 5px !important;
            }
            
            .sequence-box {
                width: 50px !important;
                height: 50px !important;
                font-size: 1.2rem !important;
            }
            
            .sequence-options {
                gap: 5px !important;
            }
            
            .option-btn {
                padding: 8px 12px !important;
                font-size: 1rem !important;
            }
        }
        /* NUEVOS ESTILOS RESPONSIVE - AGREGAR AL FINAL */
    
        /* Mejoras para m√≥vil en drag and drop */
        .drag-sortable-number {
            touch-action: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        
        /* RESPONSIVE BREAKPOINTS */
        @media (max-width: 1024px) {
            .main-container {
                padding: 15px;
                max-width: 100%;
            }
            
            .matching-content {
                gap: 30px;
            }
            
            .matching-left-column {
                flex: 0 0 150px;
            }
            
            .matching-number {
                font-size: 1.8rem;
                padding: 12px;
            }
        }

        @media (max-width: 768px) {
            .header-card h1 { 
                font-size: 2.5rem; 
            }
            
            .header-card p { 
                font-size: 1.5rem; 
            }
            
            .instruction-card {
                font-size: 1.5rem;
                padding: 20px;
            }
            
            .numbers-grid { 
                grid-template-columns: repeat(2, 1fr); 
                gap: 20px; 
            }
            
            .number-btn { 
                font-size: 2rem; 
                padding: 25px 15px; 
            }
            
            .choice-row { 
                flex-direction: column; 
                align-items: flex-start; 
            }
            
            .choice-label { 
                margin-bottom: 10px; 
                min-width: auto; 
                width: 100%;
                text-align: center;
            }
            
            .choice-options {
                justify-content: center;
                width: 100%;
            }
            
            .choice-option {
                font-size: 1.1rem;
                padding: 8px 16px;
            }
            
            .drag-numbers-to-sort {
                gap: 10px;
            }
            
            .drag-sortable-number {
                font-size: 16px;
                padding: 12px 16px;
            }
            
            .drag-drop-zone {
                padding: 15px;
                gap: 8px;
            }
            
            .drag-drop-slot {
                width: 60px;
                height: 50px;
            }
            
            .drag-drop-slot::before {
                font-size: 10px;
                top: -20px;
            }
            
            .mobile-instruction {
                display: block;
            }
            
            /* Matching responsive */
            .matching-content {
                flex-direction: column;
                gap: 20px;
            }
            
            .matching-left-column {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
                gap: 10px;
                flex: none;
            }
            
            .matching-number {
                font-size: 1.5rem;
                padding: 10px;
                min-width: 80px;
            }
            
            .matching-right-column {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .matching-dots {
                min-height: 100px;
                padding: 15px;
            }
            
            .quantity-label {
                font-size: 1.3rem;
            }
            
            .emoji {
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            .main-container {
                padding: 10px;
            }
            
            .header-card {
                padding: 20px;
                margin-bottom: 20px;
            }
            
            .header-card h1 { 
                font-size: 2rem; 
            }
            
            .header-card p { 
                font-size: 1.3rem; 
            }
            
            .game-card {
                padding: 20px;
            }
            
            .number-btn { 
                font-size: 1.8rem; 
                padding: 20px 12px; 
            }
            
            .instruction-card { 
                font-size: 1.3rem;
                padding: 15px;
            }
            
            .answer-btn {
                font-size: 1.5rem;
                padding: 15px 35px;
            }
            
            .question-counter {
                font-size: 1.2rem;
                padding: 12px 20px;
            }
            
            .choice-label {
                font-size: 1.3rem;
            }
            
            .choice-option {
                font-size: 1rem;
                padding: 6px 12px;
                min-width: 50px;
            }
            
            .drag-sortable-number {
                font-size: 14px;
                padding: 10px 12px;
            }
            
            .drag-drop-slot {
                width: 50px;
                height: 40px;
            }
            
            .matching-number {
                font-size: 1.2rem;
                padding: 8px;
                min-width: 60px;
            }
            
            .quantity-label {
                font-size: 1.1rem;
            }
            
            .emoji {
                font-size: 0.9rem;
            }
        }

        @media (max-width: 320px) {
            .numbers-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .number-btn {
                font-size: 1.6rem;
                padding: 18px 10px;
            }
            
            .drag-drop-zone {
                flex-direction: column;
                gap: 10px;
            }
            
            .matching-left-column {
                flex-direction: column;
                align-items: center;
            }
            
            .drag-drop-slot {
                width: 45px;
                height: 35px;
            }
            
            .drag-sortable-number {
                font-size: 12px;
                padding: 8px 10px;
            }
        }

        /* Touch improvements */
        @media (hover: none) and (pointer: coarse) {
            .number-btn:hover,
            .choice-option:hover,
            .matching-number:hover,
            .matching-dots:hover {
                transform: none;
            }
            
            .number-btn:active {
                transform: scale(0.95);
            }
            
            .choice-option:active {
                transform: scale(0.95);
            }
        }

        /* Utility classes */
        .mobile-device .number-btn:hover,
        .mobile-device .choice-option:hover,
        .mobile-device .matching-number:hover,
        .mobile-device .matching-dots:hover {
            transform: none !important;
        }
        
        .mobile-device .number-btn:active,
        .mobile-device .choice-option:active {
            transform: scale(0.95) !important;
            transition: transform 0.1s ease !important;
        }
</style>
{% endblock %}


{% block content %}
    <div class="container-fluid">
        <nav class="breadcrumb">
            {% if es_docente %}
                <a style="color: #000;" href="{% url 'core_docente' %}">üè† Inicio Docente</a> &nbsp;/&nbsp;
                <a style="color: #000;" href="{% url 'docente_ver_niveles_modulo' modulo.mod_id %}">üìö Niveles</a> &nbsp;/&nbsp;
                <span style="color: #2632df;">üéÆ Probando Juego</span>
            {% else %}
                <a style="color: #000;" href="{% url 'core_estudiante' %}">üè† Inicio</a> &nbsp;/&nbsp;
                <a style="color: #000;" href="{% url 'estudiante_modulo' %}">üìö M√≥dulos</a> &nbsp;/&nbsp;
                <a style="color: #000;" href="{% url 'ver_niveles_modulo' modulo.mod_id %}"> üéØ Niveles</a> &nbsp;/&nbsp;
                <span style="color: #2632df;">üéÆ Juego</span>
            {% endif %}
        </nav>

        <div class="card loading">
            <div class="card-header">
                <h2>üåü {{nivel.niv_nombre}} -{{nivel.niv_descripcion}} </h2>
            </div>
            <div class="card-body">

                <div class="main-container">
                    <div class="floating-elements" id="floating-elements"></div>

                    <!-- Header Card -->
                    <div class="header-card">
                        <h1>üé® ¬°N√∫meros Divertidos! üé®</h1>
                        <p id="main-instruction">üöÄ ¬°Vamos a jugar con n√∫meros del 10 al 59! üöÄ</p>
                    </div>

                    <!-- Game Card -->
                    <div class="game-card">
                        <!-- Question Counter -->
                        <div class="question-counter" id="question-counter">
                            <i class="fas fa-star mr-2"></i>
                            Pregunta 1 de 4
                            <i class="fas fa-star ml-2"></i>
                        </div>

                        <!-- PREGUNTA 1: Pintar solo los n√∫meros que terminan en 7 -->
                        <div class="instruction-card" id="instruction-card">
                            <i class="fas fa-paint-brush mr-2"></i>
                            ¬°Pinta SOLO los n√∫meros que TERMINAN en 7!
                            <i class="fas fa-paint-brush ml-2"></i>
                        </div>
                        <div class="numbers-grid" id="numbers-container">
                            <!-- N√∫meros generados por JS -->
                        </div>

                        <!-- PREGUNTA 2: Escribe el n√∫mero seg√∫n imagen con emojis -->
                        <div class="number-write-question" id="write-number-container" style="display: none;">
                            <h3>‚úèÔ∏è Escribe el n√∫mero que representa cada imagen:</h3>
                            
                            <div class="write-row">
                                <div class="emoji-display">
                                    <span class="emoji-number">‚úã</span>
                                    <span class="emoji-label">5 dedos</span>
                                </div>
                                <input type="number" class="form-control write-input" data-correct="5" placeholder="Escribe aqu√≠" min="0" max="99">
                            </div>
                            
                            <div class="write-row">
                                <div class="emoji-display">
                                    <span class="emoji-number">üé≤</span>
                                    <span class="emoji-label">Dado con 3 puntos</span>
                                </div>
                                <input type="number" class="form-control write-input" data-correct="3" placeholder="Escribe aqu√≠" min="0" max="99">
                            </div>
                            
                            <div class="write-row">
                                <div class="emoji-display">
                                    <span class="emoji-number">üôå</span>
                                    <span class="emoji-label">10 dedos</span>
                                </div>
                                <input type="number" class="form-control write-input" data-correct="10" placeholder="Escribe aqu√≠" min="0" max="99">
                            </div>
                            
                            <div class="write-row">
                                <div class="emoji-display">
                                    <span class="emoji-number">üëÅÔ∏èüëÅÔ∏è</span>
                                    <span class="emoji-label">2 ojos</span>
                                </div>
                                <input type="number" class="form-control write-input" data-correct="2" placeholder="Escribe aqu√≠" min="0" max="99">
                            </div>
                            
                            <div class="write-row">
                                <div class="emoji-display">
                                    <span class="emoji-number">üåüüåüüåüüåüüåüüåüüåü</span>
                                    <span class="emoji-label">7 estrellas</span>
                                </div>
                                <input type="number" class="form-control write-input" data-correct="7" placeholder="Escribe aqu√≠" min="0" max="99">
                            </div>
                        </div>

                        <!-- PREGUNTA 3: Ordenar de menor a mayor -->
                        <div class="drag-drop-question" id="drag-drop-container" style="display: none;">
                            <h3 style="color: #74b9ff; text-align: center; font-size: 1.8rem; margin-bottom: 20px; font-weight: 800;">
                                üî¢ ¬°Ordena los n√∫meros de MENOR a MAYOR! üî¢
                            </h3>
                            
                            <!-- NUEVA INSTRUCCI√ìN PARA EL SISTEMA DE CLICK -->
                            <div class="click-instruction" style="
                                background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
                                color: white;
                                padding: 15px;
                                border-radius: 10px;
                                margin-bottom: 20px;
                                text-align: center;
                                font-weight: bold;
                            ">
                                üñ±Ô∏è <strong>Instrucciones:</strong> Haz clic en los n√∫meros en el orden correcto (de menor a mayor).
                                <br>üí° <strong>Tip:</strong>  Puedes hacer clic en los mismos numeros que ahora apareceran en plomo para quitar n√∫meros.
                            </div>
                            
                            <div class="drag-numbers-to-sort" id="drag-numbers-to-sort">
                                <div class="drag-sortable-number" data-value="32" draggable="false">32</div>
                                <div class="drag-sortable-number" data-value="11" draggable="false">11</div>
                                <div class="drag-sortable-number" data-value="28" draggable="false">28</div>
                                <div class="drag-sortable-number" data-value="46" draggable="false">46</div>
                                <div class="drag-sortable-number" data-value="18" draggable="false">18</div>
                            </div>
                            
                            <div class="drag-drop-zone" id="drag-drop-zone">
                                <div class="drag-drop-slot" data-position="1¬∞"></div>
                                <div class="drag-drop-slot" data-position="2¬∞"></div>
                                <div class="drag-drop-slot" data-position="3¬∞"></div>
                                <div class="drag-drop-slot" data-position="4¬∞"></div>
                                <div class="drag-drop-slot" data-position="5¬∞"></div>
                            </div>
                        </div>

                        <!-- PREGUNTA 4: Completar secuencias -->
                        <div class="sequence-question" style="display: none;" id="sequence-container">
                            <h3 style="color: #fd79a8; text-align: center; font-size: 2rem; margin-bottom: 20px; font-weight: 800;">
                                üî¢ ¬°Completa las secuencias! üî¢
                            </h3>
                            
                            <div class="sequence-grid" style="display: grid; grid-template-columns: 1fr; gap: 25px; max-width: 800px; margin: 0 auto;">
                                
                                <!-- Secuencia 1: Contar de 2 en 2 -->
                                <div class="sequence-item" style="background: linear-gradient(135deg, #74b9ff, #0984e3); padding: 20px; border-radius: 15px; box-shadow: 0 8px 16px rgba(0,0,0,0.2);">
                                    <div class="sequence-label" style="color: white; font-size: 1.3rem; font-weight: bold; margin-bottom: 15px; text-align: center;">
                                        üê∞ Cuenta de 2 en 2:
                                    </div>
                                    <div class="sequence-boxes" style="display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap;">
                                        <div class="sequence-box filled" style="background: white; color: #0984e3; font-size: 1.5rem; font-weight: bold; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 10px;">2</div>
                                        <div class="sequence-box filled" style="background: white; color: #0984e3; font-size: 1.5rem; font-weight: bold; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 10px;">4</div>
                                        <div class="sequence-box filled" style="background: white; color: #0984e3; font-size: 1.5rem; font-weight: bold; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 10px;">6</div>
                                        <div class="sequence-box empty" data-answer="8" style="background: rgba(255,255,255,0.3); border: 3px dashed white; color: white; font-size: 2rem; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 10px; cursor: pointer; transition: all 0.3s ease;">?</div>
                                        <div class="sequence-box filled" style="background: white; color: #0984e3; font-size: 1.5rem; font-weight: bold; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 10px;">10</div>
                                    </div>
                                    <div class="sequence-options" style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;">
                                        <button class="option-btn" data-value="7" style="background: white; color: #0984e3; border: none; font-size: 1.2rem; font-weight: bold; padding: 10px 15px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">7</button>
                                        <button class="option-btn" data-value="8" style="background: white; color: #0984e3; border: none; font-size: 1.2rem; font-weight: bold; padding: 10px 15px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">8</button>
                                        <button class="option-btn" data-value="9" style="background: white; color: #0984e3; border: none; font-size: 1.2rem; font-weight: bold; padding: 10px 15px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">9</button>
                                    </div>
                                </div>

                                <!-- Secuencia 2: Contar de 5 en 5 -->
                                <div class="sequence-item" style="background: linear-gradient(135deg, #fd79a8, #e84393); padding: 20px; border-radius: 15px; box-shadow: 0 8px 16px rgba(0,0,0,0.2);">
                                    <div class="sequence-label" style="color: white; font-size: 1.3rem; font-weight: bold; margin-bottom: 15px; text-align: center;">
                                        üå∏ Cuenta de 5 en 5:
                                    </div>
                                    <div class="sequence-boxes" style="display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap;">
                                        <div class="sequence-box filled" style="background: white; color: #e84393; font-size: 1.5rem; font-weight: bold; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 10px;">5</div>
                                        <div class="sequence-box filled" style="background: white; color: #e84393; font-size: 1.5rem; font-weight: bold; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 10px;">10</div>
                                        <div class="sequence-box empty" data-answer="15" style="background: rgba(255,255,255,0.3); border: 3px dashed white; color: white; font-size: 2rem; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 10px; cursor: pointer; transition: all 0.3s ease;">?</div>
                                        <div class="sequence-box filled" style="background: white; color: #e84393; font-size: 1.5rem; font-weight: bold; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 10px;">20</div>
                                        <div class="sequence-box filled" style="background: white; color: #e84393; font-size: 1.5rem; font-weight: bold; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 10px;">25</div>
                                    </div>
                                    <div class="sequence-options" style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;">
                                        <button class="option-btn" data-value="12" style="background: white; color: #e84393; border: none; font-size: 1.2rem; font-weight: bold; padding: 10px 15px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">12</button>
                                        <button class="option-btn" data-value="15" style="background: white; color: #e84393; border: none; font-size: 1.2rem; font-weight: bold; padding: 10px 15px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">15</button>
                                        <button class="option-btn" data-value="18" style="background: white; color: #e84393; border: none; font-size: 1.2rem; font-weight: bold; padding: 10px 15px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">18</button>
                                    </div>
                                </div>

                                <!-- Secuencia 3: Contar de 10 en 10 -->
                                <div class="sequence-item" style="background: linear-gradient(135deg, #00b894, #00a085); padding: 20px; border-radius: 15px; box-shadow: 0 8px 16px rgba(0,0,0,0.2);">
                                    <div class="sequence-label" style="color: white; font-size: 1.3rem; font-weight: bold; margin-bottom: 15px; text-align: center;">
                                        üåü Cuenta de 10 en 10:
                                    </div>
                                    <div class="sequence-boxes" style="display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap;">
                                        <div class="sequence-box filled" style="background: white; color: #00a085; font-size: 1.5rem; font-weight: bold; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 10px;">10</div>
                                        <div class="sequence-box filled" style="background: white; color: #00a085; font-size: 1.5rem; font-weight: bold; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 10px;">20</div>
                                        <div class="sequence-box filled" style="background: white; color: #00a085; font-size: 1.5rem; font-weight: bold; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 10px;">30</div>
                                        <div class="sequence-box filled" style="background: white; color: #00a085; font-size: 1.5rem; font-weight: bold; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 10px;">40</div>
                                        <div class="sequence-box empty" data-answer="50" style="background: rgba(255,255,255,0.3); border: 3px dashed white; color: white; font-size: 2rem; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 10px; cursor: pointer; transition: all 0.3s ease;">?</div>
                                    </div>
                                    <div class="sequence-options" style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;">
                                        <button class="option-btn" data-value="45" style="background: white; color: #00a085; border: none; font-size: 1.2rem; font-weight: bold; padding: 10px 15px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">45</button>
                                        <button class="option-btn" data-value="50" style="background: white; color: #00a085; border: none; font-size: 1.2rem; font-weight: bold; padding: 10px 15px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">50</button>
                                        <button class="option-btn" data-value="55" style="background: white; color: #00a085; border: none; font-size: 1.2rem; font-weight: bold; padding: 10px 15px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">55</button>
                                    </div>
                                </div>
                            </div>

                        </div>
                        <br>


                        <!-- Answer Button -->
                        <button class="answer-btn" id="answer-btn" onclick="checkAnswer()" disabled>
                            <i class="fas fa-check mr-2"></i>
                            ¬°RESPONDER!
                        </button>
                    </div>

                    
                </div>


            </div>

        </div>

    </div>


{% endblock %}


{% block js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
   
    // Variables globales para el juego
    window.studentId = {{ matricula_id}};
    window.levelId   = {{ level_id }};
    const moduloId = {{ modulo_id }};
    
</script>

<script>
    // ‚úÖ 1. DETECCI√ìN ULTRA MEJORADA DE MODO DOCENTE
    console.log('üöÄ === INICIANDO DETECCI√ìN DE MODO ===');

    // M√∫ltiples m√©todos de detecci√≥n
    const currentPath = window.location.pathname;
    const isDocenteURL = currentPath.includes('/docente/');
    const templateDocente = '{{ es_docente|yesno:"true,false" }}' === 'true';
    const modoContexto = '{{ modo_prueba|yesno:"true,false" }}' === 'true';

    // NUEVA: Detectar por elementos √∫nicos del template docente
    const docenteIndicator = document.querySelector('.card-header h2');
    const hasDocenteText = docenteIndicator && docenteIndicator.textContent.includes('MODO DOCENTE');

    console.log('üîç === AN√ÅLISIS COMPLETO DE MODO ===');
    console.log('  - URL actual:', currentPath);
    console.log('  - URL contiene /docente/:', isDocenteURL);
    console.log('  - Template es_docente:', templateDocente);
    console.log('  - Contexto modo_prueba:', modoContexto);
    console.log('  - Elemento HTML indica docente:', hasDocenteText);

    // ‚úÖ DETERMINACI√ìN FINAL CON M√öLTIPLES VERIFICACIONES
    const esDocente = isDocenteURL || templateDocente || modoContexto || hasDocenteText;

    console.log('üéØ === RESULTADO FINAL ===');
    console.log('  - MODO DETECTADO:', esDocente ? 'üßë‚Äçüè´ DOCENTE' : 'üë®‚Äçüéì ESTUDIANTE');

    // ‚úÖ 2. CONFIGURACI√ìN GLOBAL ULTRA SEGURA
    if (esDocente) {
        // MODO DOCENTE - Configuraci√≥n forzada
        window.esDocente = true;
        window.modoPrueba = true;
        window.studentId = -1;
        window.levelId = {{ level_id|default:1 }};
        window.moduloId = {{ modulo_id|default:1 }};
        window.DISABLE_STUDENT_AJAX = true;
        
        console.log('üßë‚Äçüè´ === MODO DOCENTE CONFIGURADO ===');
        console.log('  - studentId:', window.studentId);
        console.log('  - levelId:', window.levelId);
        console.log('  - moduloId:', window.moduloId);
        console.log('  - AJAX deshabilitado:', window.DISABLE_STUDENT_AJAX);
        
    } else {
        // MODO ESTUDIANTE - Configuraci√≥n normal
        window.esDocente = false;
        window.modoPrueba = false;
        window.studentId = {{ matricula_id|default:1 }};
        window.levelId = {{ level_id|default:1 }};
        window.moduloId = {{ modulo_id|default:1 }};
        window.DISABLE_STUDENT_AJAX = false;
        
        console.log('üë®‚Äçüéì === MODO ESTUDIANTE CONFIGURADO ===');
        console.log('  - studentId:', window.studentId);
        console.log('  - levelId:', window.levelId);
        console.log('  - moduloId:', window.moduloId);
    }

    // ‚úÖ 3. VALIDACIONES ADICIONALES
    if (!window.levelId || window.levelId <= 0) {
        console.warn('‚ö†Ô∏è levelId inv√°lido, corrigiendo a 1');
        window.levelId = 1;
    }

    if (!window.moduloId || window.moduloId <= 0) {
        console.warn('‚ö†Ô∏è moduloId inv√°lido, corrigiendo a 1');
        window.moduloId = 1;
    }

    console.log('‚úÖ === CONFIGURACI√ìN COMPLETADA ===');
    console.log('  - Modo final:', window.esDocente ? 'DOCENTE' : 'ESTUDIANTE');
    console.log('  - Level ID:', window.levelId);
    console.log('  - M√≥dulo ID:', window.moduloId);
    console.log('  - Student ID:', window.studentId);


    let selectedNumbers = [];
    let currentNumbers = [];
    let currentQuestion = 1;
    let totalQuestions = 4 ;// Ahora son 11 preguntas
    let usedQuestions = new Set();
    let gameFinished = false;
    let multipleChoiceAnswers = {}; // Para almacenar las respuestas de opci√≥n m√∫ltiple
    // NUEVAS VARIABLES PARA EL SISTEMA DE CALIFICACIONES
    let questionScores = []; // Array para guardar puntajes de cada pregunta
    let currentScore = 0;
    let maxScorePerQuestion = 10/4; // Aproximadamente 3.33 puntos por pregunta
    let totalPossibleScore = 10; // 10 puntos TOTAL
   // VARIABLES PARA EL SISTEMA DE VIDAS (ACTUALIZADAS)
    let studentId = null;
    let levelId = null;
    let vidasRestantes = 0;
    let vidasTotales = 0;
    let vidasOriginalesNivel = 0;  // ‚úÖ Esta l√≠nea FALTABA
    let puedeIntentar = false;

    // Variables para controlar recargas
    let gameSessionId = null;
    let hasGameStarted = false;
    let pageLoadTime = Date.now();

    let correctAnswers = 0;
    const totalSequences = 3;

    // Colores para cada n√∫mero
    const numberColors = {
        '15': '#e74c3c',
        '23': '#3498db', 
        '31': '#27ae60',
        '47': '#f39c12'
    };

    // NUEVAS VARIABLES PARA M√ìVIL - AGREGAR ESTAS
    let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    

    // Generar ID √∫nico de sesi√≥n
    function generateSessionId() {
        return 'game_' + studentId + '_' + levelId + '_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    // Verificar si es una recarga no autorizada
    function isUnauthorizedReload() {
        const sessionKey = `game_session_${studentId}_${levelId}`;
        const storedSession = sessionStorage.getItem(sessionKey);
        
        if (storedSession) {
            const sessionData = JSON.parse(storedSession);
            const timeDiff = Date.now() - sessionData.timestamp;
            
            // Si la sesi√≥n existe y han pasado menos de 30 segundos, es una recarga
            if (timeDiff < 30000) {
                console.log('Recarga detectada dentro de', timeDiff, 'ms');
                return true;
            }
        }
        
        return false;
    }

    // Registrar sesi√≥n actual
    function registerGameSession() {
        const sessionKey = `game_session_${studentId}_${levelId}`;
        gameSessionId = generateSessionId();
        
        const sessionData = {
            sessionId: gameSessionId,
            timestamp: Date.now(),
            questionNumber: currentQuestion,
            hasStarted: hasGameStarted
        };
        
        sessionStorage.setItem(sessionKey, JSON.stringify(sessionData));
        console.log('Sesi√≥n registrada:', sessionData);
    }

    // Limpiar sesi√≥n al salir
    function clearGameSession() {
        const sessionKey = `game_session_${studentId}_${levelId}`;
        sessionStorage.removeItem(sessionKey);
        console.log('Sesi√≥n limpiada');
    }


    // Sobrescribir initializeGameData para modo docente
    const originalInitializeGameData = window.initializeGameData;

    // FUNCI√ìN MODIFICADA: initializeGameData
    async function initializeGameData() {
        console.log('üîß === INICIO initializeGameData MEJORADO ===');
        console.log('üîç Verificando modo: window.esDocente =', window.esDocente);
        
        // VERIFICACI√ìN TRIPLE DE MODO DOCENTE
        const tripleCheck = window.esDocente || 
                        window.DISABLE_STUDENT_AJAX || 
                        currentPath.includes('/docente/');
        
        if (tripleCheck) {
            console.log('üßë‚Äçüè´ === MODO DOCENTE CONFIRMADO - CONFIGURACI√ìN DIRECTA ===');
            
            // Configurar variables de docente de forma ultra segura
            studentId = -1;
            levelId = window.levelId || 1;
            vidasRestantes = 999;
            vidasTotales = 999;
            puedeIntentar = true;
            
            // Mostrar display especial para docente
            updateLivesDisplayDocente();
            
            // IMPORTANTE: NO mostrar popup si ya est√° en una secuencia de juego
            if (currentQuestion === 1 && !hasGameStarted) {
                showDocenteWelcome();
            }
            
            console.log('‚úÖ Docente configurado correctamente');
            return true;
        }
        
        // Para estudiantes, usar l√≥gica original
        console.log('üë®‚Äçüéì Configurando modo estudiante...');
        studentId = window.studentId;
        levelId = window.levelId;
        
        if (!levelId || levelId <= 0 || isNaN(levelId)) {
            console.error('‚ùå ERROR: levelId inv√°lido para estudiante:', levelId);
            Swal.fire({
                icon: 'error',
                title: 'Error del sistema',
                text: 'No se pudo cargar la informaci√≥n del nivel.',
                confirmButtonText: 'Volver'
            }).then(() => {
                window.location.href = '/core_estudiante/';
            });
            return false;
        }
        
        const gameInfo = await getGameInfo();
        return gameInfo;
    }

    // ‚úÖ 6. FUNCI√ìN MEJORADA showDocenteWelcome
    function showDocenteWelcome() {
        console.log('üéâ Mostrando bienvenida de docente...');
        
        setTimeout(() => {
            Swal.fire({
                icon: 'info',
                title: 'üßë‚Äçüè´ MODO DOCENTE ACTIVADO',
                html: `
                    <div style="text-align: center;">
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin: 10px 0;">
                            <p><strong>üéÆ Nivel:</strong> ${levelId}</p>
                            <p><strong>üìö M√≥dulo:</strong> ${window.moduloId}</p>
                            <p><strong>üíñ Vidas:</strong> Ilimitadas</p>
                            <p><strong>üíæ Guardado:</strong> Deshabilitado</p>
                        </div>
                        <p style="color: #666; font-size: 0.9em;">
                            ¬°Listo para probar el juego! Todas las funciones est√°n disponibles.
                        </p>
                    </div>
                `,
                confirmButtonText: '¬°Comenzar demostraci√≥n!',
                allowOutsideClick: false,
                timer: 2500,
                timerProgressBar: true
            });
        }, 500);
    }

    // ‚úÖ 7. FUNCI√ìN MEJORADA updateLivesDisplayDocente
    function updateLivesDisplayDocente() {
        console.log('üîÑ Actualizando display de vidas para docente...');
        
        let livesIndicator = document.getElementById('lives-indicator');
        if (!livesIndicator) {
            livesIndicator = document.createElement('div');
            livesIndicator.id = 'lives-indicator';
            livesIndicator.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
                color: white;
                padding: 15px 20px;
                border-radius: 25px;
                font-weight: bold;
                font-size: 1.1em;
                box-shadow: 0 8px 16px rgba(0,0,0,0.2);
                z-index: 1000;
                font-family: 'Comic Sans MS', cursive, sans-serif;
                border: 3px solid #fff;
            `;
            document.body.appendChild(livesIndicator);
        }
        
        livesIndicator.innerHTML = `
            <div style="text-align: center;">
                <div style="font-size: 1.4em; margin-bottom: 5px;">üßë‚Äçüè´</div>
                <div style="font-weight: bold;">MODO DOCENTE</div>
                <div style="font-size: 0.9em; margin-top: 5px;">‚àû Vidas ilimitadas</div>
            </div>
        `;
    }

    // NUEVA FUNCI√ìN: Obtener informaci√≥n del juego
    async function getGameInfo() {
        // VERIFICACI√ìN TRIPLE PARA DOCENTES
        const tripleCheck = window.esDocente || 
                        window.DISABLE_STUDENT_AJAX || 
                        currentPath.includes('/docente/');
        
        if (tripleCheck) {
            console.log('üßë‚Äçüè´ getGameInfo() - MODO DOCENTE: Sin peticiones AJAX');
            return true;
        }
        
        // L√≥gica normal para estudiantes (sin cambios)
        if (!studentId || studentId <= 0 || isNaN(studentId)) {
            console.error('‚ùå getGameInfo: studentId inv√°lido:', studentId);
            return false;
        }
        
        if (!levelId || levelId <= 0 || isNaN(levelId)) {
            console.error('‚ùå getGameInfo: levelId inv√°lido:', levelId);
            return false;
        }
        try {
            const response = await fetch('/get_game_info/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    estudiante_id: studentId,
                    nivel_id: levelId
                })
            });
            
            const data = await response.json();
            if (data.success) {
                vidasRestantes = data.vidas_restantes;
                vidasTotales = data.vidas_originales_nivel;
                puedeIntentar = data.puede_intentar;
                
                console.log(`Vidas: ${vidasRestantes}/${vidasTotales}, Puede intentar: ${puedeIntentar}`);
                
                // Actualizar UI con informaci√≥n de vidas
                updateLivesDisplay();
                
                // Verificar si puede jugar
                if (!puedeIntentar) {
                    showNoLivesMessage();
                    return false;
                }
                
                // Mostrar mensaje de vidas restauradas si aplica
                if (data.vidas_restauradas > 0) {
                    Swal.fire({
                        icon: 'info',
                        title: '¬°Vidas restauradas!',
                        text: `Se han agregado ${data.vidas_restauradas} vidas adicionales a este nivel.`,
                        confirmButtonText: '¬°Genial!'
                    });
                }
                
                return true;
            } else {
                console.error('Error al obtener info del juego:', data.error);
                return false;
            }
        } catch (error) {
            console.error('Error de red al obtener info del juego:', error);
            return false;
        }
    }

    // FUNCI√ìN MODIFICADA: Actualizar display de vidas con indicador de estado
    function updateLivesDisplay() {
        let livesIndicator = document.getElementById('lives-indicator');
        if (!livesIndicator) {
            livesIndicator = document.createElement('div');
            livesIndicator.id = 'lives-indicator';
            livesIndicator.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 100%);
                color: white;
                padding: 15px 20px;
                border-radius: 25px;
                font-weight: bold;
                font-size: 1.1em;
                box-shadow: 0 8px 16px rgba(0,0,0,0.2);
                z-index: 1000;
                font-family: 'Comic Sans MS', cursive, sans-serif;
                transition: all 0.3s ease;
            `;
            document.body.appendChild(livesIndicator);
        }
        
        // Crear corazones para representar vidas
        let heartsHTML = '';
        for (let i = 0; i < vidasTotales; i++) {
            if (i < vidasRestantes) {
                heartsHTML += '‚ù§Ô∏è'; // Vida disponible
            } else {
                heartsHTML += 'üñ§'; // Vida usada
            }
        }
        
        // Cambiar color seg√∫n vidas restantes
        let bgColor = 'linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 100%)';
        if (vidasRestantes <= 1) {
            bgColor = 'linear-gradient(135deg, #f44336 0%, #ff9800 100%)';
            livesIndicator.style.animation = 'pulse 1s infinite';
        } else if (vidasRestantes <= 2) {
            bgColor = 'linear-gradient(135deg, #ff9800 0%, #ffc107 100%)';
        }
        
        livesIndicator.style.background = bgColor;
        
        livesIndicator.innerHTML = `
            <div style="text-align: center;">
                <div style="font-size: 1.2em; margin-bottom: 5px;">${heartsHTML}</div>
                <div>Vidas: ${vidasRestantes}/${vidasTotales}</div>
                ${vidasRestantes <= 1 ? '<div style="font-size: 0.8em; color: #ffeb3b;">¬°Cuidado!</div>' : ''}
            </div>
        `;
    }

    // Event listeners para detectar intentos de salida
    window.addEventListener('beforeunload', function(e) {
        if (hasGameStarted && currentQuestion > 1 && !gameFinished) {
            // Advertir al usuario antes de salir
            const message = '¬øEst√°s seguro de que quieres salir? Perder√°s el progreso actual.';
            e.returnValue = message;
            return message;
        }
        
        // Limpiar sesi√≥n al salir
        clearGameSession();
    });

    // Limpiar sesi√≥n cuando se va a otra p√°gina
    window.addEventListener('pagehide', function() {
        clearGameSession();
    });

    // NUEVA FUNCI√ìN: Mostrar mensaje sin vidas
    function showNoLivesMessage() {
        Swal.fire({
            icon: 'warning',
            title: '¬°Sin vidas restantes! üíî',
            html: `
                <div>
                    <p>Has agotado todas las vidas para este nivel.</p>
                    <p><strong>Vidas utilizadas: ${vidasTotales}</p>
                    <br>
                    <p style="color: #666;">Contacta a tu profesor para obtener m√°s intentos.</p>
                </div>
            `,
            confirmButtonText: 'Volver al men√∫',
            allowOutsideClick: false,
            customClass: {
                popup: 'animated shake'
            }
        }).then(() => {
            window.location.href = `/modulo/${moduloId}/niveles/`;
        });
    }
   
    // Funci√≥n para calcular puntaje de cada pregunta
    function calculateQuestionScore(isCorrect, questionType) {
        let score = 0;
        
        if (questionType === 'normal' || questionType === 'drag-drop') {
            // Preguntas normales y drag-drop: todo o nada
            score = isCorrect ? maxScorePerQuestion : 0;
        } else if (questionType === 'write-number') {
            // Pregunta 2: escribir n√∫meros - puntaje proporcional
            let correctAnswers = 0;
            const totalItems = 5; // 5 items en la pregunta 2
            
            // Revisar cada input de la pregunta 2
            const writeInputs = document.querySelectorAll('.write-input');
            writeInputs.forEach(input => {
                const userAnswer = parseInt(input.value);
                const correctAnswer = parseInt(input.dataset.correct);
                
                if (userAnswer === correctAnswer) {
                    correctAnswers++;
                }
            });
            
            // Calcular puntaje proporcional
            score = (correctAnswers / totalItems) * maxScorePerQuestion;
        } else if (questionType === 'sequence') {
            // Pregunta 4: completar secuencias - puntaje proporcional
            let correctSequences = 0;
            const totalSequences = 3; // 3 secuencias en la pregunta 4
            
            // Revisar cada secuencia completada correctamente
            const sequenceBoxes = document.querySelectorAll('.sequence-box.correct');
            correctSequences = sequenceBoxes.length;
            
            // Calcular puntaje proporcional
            score = (correctSequences / totalSequences) * maxScorePerQuestion;
        }
        
        return Math.round(score * 100) / 100; // Redondear a 2 decimales
    }

    // Crear elementos flotantes
    function createFloatingElements() {
        const container = document.getElementById('floating-elements');
        const elements = ['üåü', '‚≠ê', '‚ú®', 'üéà', 'üéâ', 'üéä', 'üåà', 'üí´', 'ü¶Ñ', 'üéØ'];
        
        for (let i = 0; i < 20; i++) {
            const element = document.createElement('div');
            element.className = 'floating-element';
            element.innerHTML = elements[Math.floor(Math.random() * elements.length)];
            element.style.left = Math.random() * 100 + '%';
            element.style.top = Math.random() * 100 + '%';
            element.style.animationDelay = Math.random() * 8 + 's';
            element.style.animationDuration = (Math.random() * 4 + 6) + 's';
            container.appendChild(element);
        }
    }

      // Generar los n√∫meros √∫nicos
    function generateUniqueNumbers() {
        let attempts = 0;
        let questionSet;

        do {
            questionSet = generateNumbers();
            attempts++;
        } while (usedQuestions.has(JSON.stringify(questionSet)) && attempts < 50);

        if (attempts < 50) {
            usedQuestions.add(JSON.stringify(questionSet));
        }

        return questionSet;
    }

    // Generar los n√∫meros (correctos = terminan en 7)
    function generateNumbers() {
        const correctOptions = [];
        const incorrectOptions = [];

        for (let i = 10; i <= 59; i++) {
            if (i % 10 === 7) {
                correctOptions.push(i);
            } else {
                incorrectOptions.push(i);
            }
        }

        const selectedCorrect = correctOptions.sort(() => Math.random() - 0.5).slice(0, 3);
        const selectedIncorrect = incorrectOptions.sort(() => Math.random() - 0.5).slice(0, 3);

        return [...selectedCorrect, ...selectedIncorrect].sort(() => Math.random() - 0.5);
    }

    // Mostrar los n√∫meros en pantalla
    function mostrarNumeros() {
        const container = document.getElementById("numbers-container");
        container.innerHTML = "";

        const numeros = generateUniqueNumbers();

        numeros.forEach(num => {
            const btn = document.createElement("button");
            btn.className = "number-button";
            btn.textContent = num;
            btn.addEventListener("click", function () {
                if (num % 10 === 7) {
                    btn.classList.add("correcto");  // Pintar correcto
                } else {
                    btn.classList.add("incorrecto");  // Pintar incorrecto
                }
                btn.disabled = true;
            });
            container.appendChild(btn);
        });
    }

    // Funci√≥n corregida para mostrar n√∫meros en la pantalla
    function displayNumbers() {
        // Marcar que el juego ha iniciado cuando se muestra la primera pregunta
        if (currentQuestion === 1 && !hasGameStarted) {
            hasGameStarted = true;
            // ‚úÖ SOLO registrar sesi√≥n para estudiantes
            if (!window.esDocente) {
                registerGameSession(); // Solo registrar sesi√≥n para estudiantes
            }
        }
        
        // Primero, ocultar TODOS los contenedores
        document.getElementById('numbers-container').style.display = 'none';
        
        document.getElementById('drag-drop-container').style.display = 'none';
        // AGREGAR: Ocultar el contenedor de la pregunta 2
        const writeNumberContainer = document.getElementById('write-number-container');
        if (writeNumberContainer) {
            writeNumberContainer.style.display = 'none';
        }
        
        
        // NUEVO: Ocultar el contenedor de secuencias
        const sequenceContainer = document.getElementById('sequence-container');
        if (sequenceContainer) {
            sequenceContainer.style.display = 'none';
        }
        
        // Pregunta 1: n√∫meros con 2,4
        if (currentQuestion === 1) {
            document.getElementById('numbers-container').style.display = 'grid';
            
            const container = document.getElementById('numbers-container');
            container.innerHTML = '';
            selectedNumbers = [];
            
            currentNumbers = generateUniqueNumbers();
            
            currentNumbers.forEach((number, index) => {
                const button = document.createElement('button');
                button.className = 'number-btn';
                button.textContent = number;
                // CORREGIR: Usar funci√≥n an√≥nima para evitar problemas de contexto
                button.onclick = function() {
                    selectNumber(number, this);
                };
                button.style.animationDelay = (index * 0.2) + 's';
                button.dataset.number = number;
                container.appendChild(button);
            });
            
            // Resetear bot√≥n de respuesta
            document.getElementById('answer-btn').disabled = true;
        }
        // Pregunta 2: Escribir el n√∫mero seg√∫n imagen
        else if (currentQuestion === 2) {
            document.getElementById('numbers-container').style.display = 'none';
            document.getElementById('write-number-container').style.display = 'block';
            document.getElementById('drag-drop-container').style.display = 'none';
            document.getElementById('sequence-container').style.display = 'none';

            document.getElementById('main-instruction').innerHTML = '‚úèÔ∏è Escribe el n√∫mero que representa cada imagen';
            document.getElementById('instruction-card').innerHTML = `
                <i class="fas fa-pencil-alt mr-2"></i>
                Observa y escribe el n√∫mero correcto
                <i class="fas fa-pencil-alt ml-2"></i>
            `;

            document.getElementById('question-counter').innerHTML = `
                <i class="fas fa-star mr-2"></i>
                Pregunta ${currentQuestion} de ${totalQuestions}
                <i class="fas fa-star ml-2"></i>
            `;

            const inputs = document.querySelectorAll('.write-input');
            inputs.forEach(input => {
                input.value = ''; // Limpiar
            });

            document.getElementById('answer-btn').disabled = true;

            // Habilitar bot√≥n solo si todos los inputs est√°n llenos
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    const allFilled = Array.from(inputs).every(inp => inp.value.trim() !== '');
                    document.getElementById('answer-btn').disabled = !allFilled;
                });
            });
        }
        // Pregunta 3: drag and drop
        else if (currentQuestion === 3) {
            showDragDropQuestion();
            return;
        }
        // Pregunta 4: completar secuencias
        else if (currentQuestion === 4) {
            // Mostrar el contenedor de secuencias
            const sequenceContainer = document.getElementById('sequence-container');
            if (sequenceContainer) {
                sequenceContainer.style.display = 'block';
                
                // Actualizar instrucciones
                document.getElementById('main-instruction').innerHTML = 'üî¢ ¬°Completa las secuencias!';
                document.getElementById('instruction-card').innerHTML = `
                    <i class="fas fa-brain mr-2"></i>
                    Encuentra el patr√≥n y completa cada secuencia
                    <i class="fas fa-brain ml-2"></i>
                `;

                document.getElementById('question-counter').innerHTML = `
                    <i class="fas fa-star mr-2"></i>
                    Pregunta ${currentQuestion} de ${totalQuestions}
                    <i class="fas fa-star ml-2"></i>
                `;

                // Resetear la pregunta de secuencias
                initSequenceQuestion();
            } else {
                console.error('No se encontr√≥ el contenedor sequence-container');
            }
            return;
        }
        
        // Actualizar contador de preguntas
        document.getElementById('question-counter').innerHTML = `
            Pregunta ${currentQuestion} de ${totalQuestions}
        `;
        
        // Resetear bot√≥n de respuesta (solo para pregunta 1)
        if (currentQuestion === 1) {
            document.getElementById('answer-btn').disabled = true;
        }
    }

    // Seleccionar/deseleccionar n√∫mero
    function selectNumber(number, button) {
        if (gameFinished) return;

        const index = selectedNumbers.indexOf(number);
        
        if (index > -1) {
            // Deseleccionar
            selectedNumbers.splice(index, 1);
            button.classList.remove('selected');
        } else {
            // Seleccionar
            selectedNumbers.push(number);
            button.classList.add('selected');
        }

        // Habilitar/deshabilitar bot√≥n de respuesta
        document.getElementById('answer-btn').disabled = selectedNumbers.length === 0;
    }

    // Crear confeti
    function createConfetti() {
        const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffa726', '#ef5350'];
        
        for (let i = 0; i < 50; i++) {
            setTimeout(() => {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                document.body.appendChild(confetti);
                
                setTimeout(() => {
                    confetti.remove();
                }, 3000);
            }, i * 100);
        }
    }

    // REEMPLAZAR la funci√≥n showDragDropQuestion existente
    function showDragDropQuestion() {
        document.getElementById('numbers-container').style.display = 'none';
        document.getElementById('drag-drop-container').style.display = 'block';
        
        // Cambiar las instrucciones para el nuevo sistema
        document.getElementById('main-instruction').innerHTML = 'üî¢ ¬°Ordena los n√∫meros haciendo clic!';
        document.getElementById('instruction-card').innerHTML = `
            <i class="fas fa-mouse-pointer mr-2"></i>
            ¬°Haz clic en los n√∫meros en el orden de MENOR a MAYOR! 
            <br><small>üí° Tip: Puedes hacer clic en los mismos numeros que ahora apareceran en plomo para quitar n√∫meros</small>
            <i class="fas fa-mouse-pointer ml-2"></i>
        `;

        document.getElementById('question-counter').innerHTML = `
            <i class="fas fa-star mr-2"></i>
            Pregunta ${currentQuestion} de ${totalQuestions}
            <i class="fas fa-star ml-2"></i>
        `;

        // Inicializar el nuevo sistema
        initClickToOrder();
    }

    // Variables para drag and drop
    let orderSequence = []; // Array para mantener el orden de los n√∫meros seleccionados
    let clickOrder = 1; // Contador para el orden de clic
    const correctOrderNumbers = [11, 18, 28, 32, 46]; // Orden correcto de menor a mayor

    // NUEVA funci√≥n para inicializar el sistema de click-to-order
    function initClickToOrder() {
        const sortableNumbers = document.querySelectorAll('.drag-sortable-number');
        const dropSlots = document.querySelectorAll('.drag-drop-slot');

        // Resetear variables
        orderSequence = [];
        clickOrder = 1;

        // Limpiar slots existentes
        dropSlots.forEach(slot => {
            slot.innerHTML = '';
            slot.classList.remove('filled', 'drag-over', 'mobile-target');
            slot.setAttribute('data-slot-number', '');
        });

        // Configurar n√∫meros clicables
        sortableNumbers.forEach(number => {
            number.style.display = 'flex';
            number.classList.remove('mobile-selected', 'dragging', 'selected', 'placed');
            number.style.cursor = 'pointer';
            number.style.opacity = '1';
            
            // Remover todos los event listeners anteriores clonando el elemento
            const newNumber = number.cloneNode(true);
            number.parentNode.replaceChild(newNumber, number);
            
            // Agregar nuevo event listener para el clic
            newNumber.addEventListener('click', function(e) {
                e.preventDefault();
                handleNumberClick(this);
            });
        });

        // Configurar slots clicables para remover n√∫meros
        dropSlots.forEach(slot => {
            slot.addEventListener('click', function(e) {
                e.preventDefault();
                handleSlotClick(this);
            });
        });

        // Resetear bot√≥n
        document.getElementById('answer-btn').disabled = true;
        updateButtonText();
    }

    // NUEVA funci√≥n para manejar clic en n√∫meros
    function handleNumberClick(numberElement) {
        const numberValue = parseInt(numberElement.getAttribute('data-value'));
        
        // Verificar si el n√∫mero ya est√° colocado
        if (numberElement.classList.contains('placed')) {
            // Si ya est√° colocado, removerlo y reorganizar
            removeNumberFromOrder(numberValue, numberElement);
            return;
        }

        // Verificar si hay espacio disponible
        if (orderSequence.length >= 5) {
            Swal.fire({
                icon: 'info',
                title: '¬°Espacios llenos!',
                text: 'Ya has colocado todos los n√∫meros. Puedes hacer clic en una casilla para remover un n√∫mero.',
                timer: 2000,
                showConfirmButton: false
            });
            return;
        }

        // Agregar n√∫mero al orden
        addNumberToOrder(numberValue, numberElement);
    }

    // NUEVA funci√≥n para agregar n√∫mero al orden
    function addNumberToOrder(numberValue, numberElement) {
        // Encontrar el siguiente slot vac√≠o
        const emptySlot = document.querySelector('.drag-drop-slot:not(.filled)');
        
        if (!emptySlot) {
            console.error('No hay slots vac√≠os disponibles');
            return;
        }

        // Agregar a la secuencia
        orderSequence.push({
            value: numberValue,
            order: clickOrder,
            element: numberElement,
            slot: emptySlot
        });

        // Crear elemento visual en el slot
        const slotNumber = document.createElement('div');
        slotNumber.className = 'drag-dropped-number click-ordered-number';
        slotNumber.textContent = numberValue;
        slotNumber.setAttribute('data-value', numberValue);
        slotNumber.setAttribute('data-order', clickOrder);
        
        // Agregar indicador de orden
        const orderIndicator = document.createElement('div');
        orderIndicator.className = 'order-indicator';
        orderIndicator.textContent = clickOrder;
        slotNumber.appendChild(orderIndicator);

        // Colocar en el slot
        emptySlot.appendChild(slotNumber);
        emptySlot.classList.add('filled');
        emptySlot.setAttribute('data-slot-number', numberValue);

        // Marcar el n√∫mero original como colocado
        numberElement.classList.add('placed');
        numberElement.style.opacity = '0.4';
        numberElement.style.transform = 'scale(0.9)';

        // Incrementar contador
        clickOrder++;

        // Verificar si est√° completo
        checkOrderComplete();
        
        // Efectos visuales
        createClickEffect(numberElement);
        
        console.log('Orden actual:', orderSequence.map(item => item.value));
    }

    // NUEVA funci√≥n para remover n√∫mero del orden
    function removeNumberFromOrder(numberValue, numberElement) {
        // Encontrar el n√∫mero en la secuencia
        const index = orderSequence.findIndex(item => item.value === numberValue);
        
        if (index === -1) {
            console.error('N√∫mero no encontrado en la secuencia');
            return;
        }

        // Obtener el item a remover
        const itemToRemove = orderSequence[index];
        
        // Remover del slot
        const slotElement = itemToRemove.slot.querySelector('.click-ordered-number');
        if (slotElement) {
            slotElement.remove();
        }
        itemToRemove.slot.classList.remove('filled');
        itemToRemove.slot.setAttribute('data-slot-number', '');

        // Remover de la secuencia
        orderSequence.splice(index, 1);

        // Restaurar apariencia del n√∫mero original
        numberElement.classList.remove('placed');
        numberElement.style.opacity = '1';
        numberElement.style.transform = 'scale(1)';

        // Reorganizar los n√∫meros restantes y actualizar orden visual
        reorganizeOrder();
        
        // Verificar completitud
        checkOrderComplete();
        
        console.log('N√∫mero removido. Orden actual:', orderSequence.map(item => item.value));
    }

    // NUEVA funci√≥n para reorganizar el orden despu√©s de una eliminaci√≥n
    function reorganizeOrder() {
        // Limpiar todos los slots
        const dropSlots = document.querySelectorAll('.drag-drop-slot');
        dropSlots.forEach(slot => {
            slot.innerHTML = '';
            slot.classList.remove('filled');
            slot.setAttribute('data-slot-number', '');
        });

        // Reorganizar secuencia y recolocar en orden
        orderSequence.forEach((item, index) => {
            const newSlot = dropSlots[index];
            const newOrder = index + 1;
            
            // Crear nuevo elemento visual
            const slotNumber = document.createElement('div');
            slotNumber.className = 'drag-dropped-number click-ordered-number';
            slotNumber.textContent = item.value;
            slotNumber.setAttribute('data-value', item.value);
            slotNumber.setAttribute('data-order', newOrder);
            
            // Agregar indicador de orden actualizado
            const orderIndicator = document.createElement('div');
            orderIndicator.className = 'order-indicator';
            orderIndicator.textContent = newOrder;
            slotNumber.appendChild(orderIndicator);

            // Colocar en el nuevo slot
            newSlot.appendChild(slotNumber);
            newSlot.classList.add('filled');
            newSlot.setAttribute('data-slot-number', item.value);
            
            // Actualizar referencia del slot en la secuencia
            item.slot = newSlot;
            item.order = newOrder;
        });

        // Actualizar contador de orden
        clickOrder = orderSequence.length + 1;
    }

    // NUEVA funci√≥n para manejar clic en slots (para remover n√∫meros)
    function handleSlotClick(slotElement) {
        const slotNumber = slotElement.getAttribute('data-slot-number');
        
        if (!slotNumber || slotNumber === '') {
            return; // Slot vac√≠o, no hacer nada
        }

        const numberValue = parseInt(slotNumber);
        
        // Encontrar el elemento n√∫mero original
        const originalNumber = document.querySelector(`.drag-sortable-number[data-value="${numberValue}"]`);
        
        if (originalNumber) {
            removeNumberFromOrder(numberValue, originalNumber);
        }
    }

    // NUEVA funci√≥n para verificar si el orden est√° completo
    function checkOrderComplete() {
        const answerBtn = document.getElementById('answer-btn');
        
        if (orderSequence.length === 5) {
            answerBtn.disabled = false;
            updateButtonText('‚úì ¬°RESPONDER!');
        } else {
            answerBtn.disabled = true;
            updateButtonText();
        }
    }

    // NUEVA funci√≥n para actualizar texto del bot√≥n
    function updateButtonText(customText = null) {
        const answerBtn = document.getElementById('answer-btn');
        
        if (customText) {
            answerBtn.innerHTML = `<i class="fas fa-check mr-2"></i> ${customText}`;
        } else {
            const remaining = 5 - orderSequence.length;
            answerBtn.innerHTML = `‚úì !RESPONDER¬°`;
        }
    }

    // NUEVA funci√≥n para verificar el orden de los n√∫meros
    function checkClickOrder() {
        const userOrder = orderSequence.map(item => item.value);
        const isCorrect = userOrder.every((value, index) => value === correctOrderNumbers[index]);
        
        // Efectos visuales en los slots
        const dropSlots = document.querySelectorAll('.drag-drop-slot.filled');
        dropSlots.forEach((slot, index) => {
            const slotNumber = slot.querySelector('.click-ordered-number');
            if (slotNumber) {
                const numberValue = parseInt(slotNumber.getAttribute('data-value'));
                
                if (numberValue === correctOrderNumbers[index]) {
                    slot.classList.add('correct-slot');
                    slotNumber.classList.add('correct-number');
                } else {
                    slot.classList.add('incorrect-slot');
                    slotNumber.classList.add('incorrect-number');
                }
            }
        });

        // Deshabilitar m√°s interacciones
        document.querySelectorAll('.drag-sortable-number').forEach(num => {
            num.style.cursor = 'not-allowed';
            num.style.pointerEvents = 'none';
        });

        document.querySelectorAll('.drag-drop-slot').forEach(slot => {
            slot.style.cursor = 'not-allowed';
            slot.style.pointerEvents = 'none';
        });

        return {
            isCorrect: isCorrect,
            message: isCorrect ? 
                'üéâ ¬°Excelente! Has ordenado correctamente los n√∫meros de menor a mayor.' :
                '‚ùå El orden no es correcto. Recuerda: debe ser de MENOR a MAYOR.'
        };
    }

    // NUEVA funci√≥n para crear efecto visual al hacer clic
    function createClickEffect(element) {
        const effect = document.createElement('div');
        effect.style.cssText = `
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            background: #4CAF50;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: clickPulse 0.6s ease-out;
            pointer-events: none;
            z-index: 1000;
        `;
        
        element.style.position = 'relative';
        element.appendChild(effect);
        
        setTimeout(() => {
            if (effect.parentNode) {
                effect.remove();
            }
        }, 600);
    }

    // NUEVA funci√≥n para resetear el sistema de click-to-order
    function resetClickToOrder() {
        orderSequence = [];
        clickOrder = 1;
        
        const sortableNumbers = document.querySelectorAll('.drag-sortable-number');
        const dropSlots = document.querySelectorAll('.drag-drop-slot');
        
        // Limpiar slots
        dropSlots.forEach(slot => {
            slot.innerHTML = '';
            slot.classList.remove('filled', 'correct-slot', 'incorrect-slot');
            slot.setAttribute('data-slot-number', '');
            slot.style.cursor = 'pointer';
            slot.style.pointerEvents = 'auto';
        });
        
        // Restaurar n√∫meros
        sortableNumbers.forEach(number => {
            number.style.display = 'flex';
            number.classList.remove('placed');
            number.style.opacity = '1';
            number.style.transform = 'scale(1)';
            number.style.cursor = 'pointer';
            number.style.pointerEvents = 'auto';
        });
        
        // Resetear bot√≥n
        document.getElementById('answer-btn').disabled = true;
        updateButtonText();
    }

    // FUNCI√ìN PARA DETECTAR M√ìVIL - AGREGAR ESTA
    function detectMobile() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
               (navigator.maxTouchPoints && navigator.maxTouchPoints > 2);
    }
    
    // FUNCI√ìN PARA CONFIGURAR OPTIMIZACIONES T√ÅCTILES - AGREGAR ESTA
    function setupTouchOptimizations() {
        if (detectMobile()) {
            document.addEventListener('touchstart', function(e) {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });

            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(e) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, false);

            document.body.classList.add('mobile-device');
        }
    }
    
    // MODIFICAR TU FUNCI√ìN initDragDrop EXISTENTE - REEMPLAZAR CON ESTA
    function initDragDrop() {
        const sortableNumbers = document.querySelectorAll('.drag-sortable-number');
        const dropSlots = document.querySelectorAll('.drag-drop-slot');

        dropSlots.forEach(slot => {
            const existing = slot.querySelector('.drag-dropped-number');
            if (existing) {
                existing.remove();
                slot.classList.remove('filled');
            }
        });

        sortableNumbers.forEach(number => {
            number.style.display = 'block';
            number.classList.remove('mobile-selected');
            
            if (isMobile) {
                number.addEventListener('touchstart', handleMobileTouchStart, { passive: false });
                number.addEventListener('click', handleMobileNumberSelect);
            } else {
                number.addEventListener('dragstart', handleDragStart);
                number.addEventListener('dragend', handleDragEnd);
            }
        });

        dropSlots.forEach(slot => {
            slot.classList.remove('mobile-target');
            
            if (isMobile) {
                slot.addEventListener('click', handleMobileSlotSelect);
            } else {
                slot.addEventListener('dragover', handleDragOver);
                slot.addEventListener('drop', handleDrop);
                slot.addEventListener('dragenter', handleDragEnter);
                slot.addEventListener('dragleave', handleDragLeave);
            }
        });
    }

    // Funci√≥n para verificar si el drag and drop est√° completo
    function checkDragDropComplete() {
        const dropSlots = document.querySelectorAll('.drag-drop-slot');
        let filledSlots = 0;
        
        dropSlots.forEach(slot => {
            if (slot.querySelector('.drag-dropped-number')) {
                filledSlots++;
            }
        });
        
        const answerBtn = document.getElementById('answer-btn');
        
        // Habilitar bot√≥n solo cuando todos los slots est√©n llenos
        if (filledSlots === dropSlots.length) {
            answerBtn.disabled = false;
            answerBtn.textContent = '‚úì Responder';
        } else {
            answerBtn.disabled = true;
            answerBtn.textContent = `‚úì !RESPONDER¬°`;
        }
    }

    // Manejar clic en slot para devolver n√∫meros
    function handleSlotClick(e) {
        const droppedNumber = this.querySelector('.drag-dropped-number');
        if (droppedNumber) {
            // Encontrar el n√∫mero original y mostrarlo
            const numbersContainer = document.getElementById('drag-numbers-to-sort');
            const originalNumbers = document.querySelectorAll('.drag-sortable-number');
            
            originalNumbers.forEach(num => {
                if (num.getAttribute('data-value') === droppedNumber.getAttribute('data-value')) {
                    num.style.display = 'flex';
                }
            });
            
            // Remover del slot
            droppedNumber.remove();
            this.classList.remove('filled');
            
            // Verificar completitud
            checkDragDropComplete();
        }
    }

    // ACTUALIZAR la funci√≥n checkDragDropOrder para usar el nuevo sistema
    function checkDragDropOrder() {
        return checkClickOrder();
    }

    // Funci√≥n modificada para checkAnswer 
    function checkAnswer() {
        if (gameFinished) return;

        gameFinished = true;
        
        let isCorrect = false;
        let feedback = '';
        let questionType = '';
        let score = 0;

        // Si es la pregunta de completar secuencias (ahora es la pregunta 4 - √∫ltima)
        if (currentQuestion === 4) {
            questionType = 'sequence';
            const sequenceResult = checkSequenceAnswers();
            isCorrect = sequenceResult.isCorrect;
            feedback = sequenceResult.message;
        }
        // Si es la pregunta de drag and drop (ahora es la pregunta 3)
        else if (currentQuestion === 3) {
            questionType = 'drag-drop';
            const dragResult = checkDragDropOrder();
            isCorrect = dragResult.isCorrect;
            feedback = dragResult.message;
        }
        else if (currentQuestion === 2) {
            questionType = 'write-number'; // Cambiar de 'normal' a 'write-number'
            const inputs = document.querySelectorAll('.write-input');
            let correct = 0;
            const totalInputs = inputs.length; // 5 items

            inputs.forEach(input => {
                const correctVal = parseInt(input.dataset.correct);
                const entered = parseInt(input.value.trim());
                
                if (entered === correctVal) {
                    correct++;
                    input.style.border = '3px solid #4CAF50'; // Verde si correcto
                    input.style.backgroundColor = '#e8f5e8'; // Fondo verde claro
                } else {
                    input.style.border = '3px solid #f44336'; // Rojo si incorrecto
                    input.style.backgroundColor = '#ffe8e8'; // Fondo rojo claro
                }
            });

            // Para efectos visuales, consideramos "correcto" si tiene al menos 3 de 5
            // pero el puntaje ser√° proporcional
            isCorrect = correct >= Math.ceil(totalInputs * 0.6); // 60% o m√°s para "√©xito"
            
            // Feedback detallado
            const percentage = (correct / totalInputs) * 100;
            
            if (correct === totalInputs) {
                feedback = 'üéâ ¬°Perfecto! Todos los n√∫meros est√°n correctos.';
            } else if (correct >= Math.ceil(totalInputs * 0.8)) {
                feedback = `üåü ¬°Muy bien! Acertaste ${correct} de ${totalInputs} n√∫meros.`;
            } else if (correct >= Math.ceil(totalInputs * 0.6)) {
                feedback = `üëç ¬°Buen trabajo! Acertaste ${correct} de ${totalInputs} n√∫meros.`;
            } else if (correct > 0) {
                feedback = `üí™ ¬°Sigue intentando! Acertaste ${correct} de ${totalInputs} n√∫meros.`;
            } else {
                feedback = `üîÅ Int√©ntalo otra vez. Revisa cada imagen y cuenta con cuidado.`;
            }
        }
        else if (currentQuestion === 1) {
            questionType = 'normal';
            const correctNumbers = currentNumbers.filter(num => num % 10 === 7);

            const selectedCorrect = selectedNumbers.filter(num => num % 10 === 7);
            const selectedIncorrect = selectedNumbers.filter(num => num % 10 !== 7);

            isCorrect = selectedCorrect.length === correctNumbers.length &&
                        selectedIncorrect.length === 0 &&
                        correctNumbers.every(num => selectedNumbers.includes(num));

            // Marcar visualmente los n√∫meros
            const buttons = document.querySelectorAll('.number-btn');
            buttons.forEach(button => {
                const number = parseInt(button.dataset.number);
                const wasSelected = selectedNumbers.includes(number);
                const shouldBeSelected = number % 10 === 7;

                if (shouldBeSelected && wasSelected) {
                    button.classList.add('correct-answer');
                } else if (shouldBeSelected && !wasSelected) {
                    button.classList.add('correct-answer');
                    button.style.border = '4px solid #96ceb4';
                } else if (!shouldBeSelected && wasSelected) {
                    button.classList.add('incorrect-answer');
                }
            });

            feedback = isCorrect ?
                `üéâ ¬°Correcto! Has seleccionado todos los que terminan en 7.` :
                `‚ùå Recuerda: solo los que TERMINAN en 7 `;
        }

        // Calcular puntaje de la pregunta
        score = calculateQuestionScore(isCorrect, questionType);
        questionScores.push({
            question: currentQuestion,
            score: score,
            maxScore: maxScorePerQuestion,
            isCorrect: isCorrect,
            type: questionType
        });

        // Mostrar resultado
        setTimeout(() => {
            if (isCorrect) {
                createConfetti();
                Swal.fire({
                    icon: 'success',
                    title: '¬°CORRECTO! üåü',
                    html: `
                        <div>
                            <p>${feedback}</p>
                            <div style="font-size: 1.2em; margin: 15px 0; color: #4CAF50;">
                                <strong>Puntaje: ${score.toFixed(2)}/${maxScorePerQuestion.toFixed(2)} puntos</strong>
                            </div>
                        </div>
                    `,
                    confirmButtonText: currentQuestion < totalQuestions ? '¬°Siguiente pregunta!' : '¬°Ver resultados!',
                    allowOutsideClick: false,
                    customClass: {
                        popup: 'animated bounceIn',
                        confirmButton: 'btn btn-success'
                    }
                }).then(() => {
                    nextQuestion();
                });
            } else {
                Swal.fire({
                    icon: 'info',
                    title: '¬°Sigue intentando! üí™',
                    html: `
                        <div>
                            <p>${feedback}</p>
                            <div style="font-size: 1.2em; margin: 15px 0; color: #ff9800;">
                                <strong>Puntaje: ${score.toFixed(2)}/${maxScorePerQuestion.toFixed(2)} puntos</strong>
                            </div>
                        </div>
                    `,
                    confirmButtonText: 'Continuar',
                    allowOutsideClick: false,
                    customClass: {
                        popup: 'animated shake',
                        confirmButton: 'btn btn-primary'
                    }
                }).then(() => {
                    nextQuestion();
                });
            }
        }, 1500);
    }

    // Pasar a la siguiente pregunta
    function nextQuestion() {
        if (currentQuestion >= totalQuestions) {
            // Juego terminado
            showFinalResults();
        } else {
            // Siguiente pregunta
            currentQuestion++;
            gameFinished = false;
            displayNumbers();
        }
    }

    // FUNCI√ìN CORREGIDA: showFinalResults con c√°lculo correcto de vidas
    function showFinalResults() {
        const totalScore = questionScores.reduce((sum, q) => sum + q.score, 0);
        const finalScore = Math.round(totalScore * 100) / 100;

        let questionsHTML = '';
        questionScores.forEach((q, index) => {
            const icon = q.isCorrect ? '‚úÖ' : '‚ùå';
            const color = q.isCorrect ? '#4CAF50' : '#f44336';
            questionsHTML += `
                <div style="margin: 10px 0; padding: 10px; border-left: 4px solid ${color}; background: #f9f9f9;">
                    <strong>Pregunta ${q.question}:</strong> ${icon} ${q.score.toFixed(2)}/${q.maxScore.toFixed(2)} puntos
                </div>
            `;
        });

        const isPassed = finalScore >= 7;
        const statusColor = isPassed ? '#4CAF50' : '#ff9800';
        const statusText = isPassed ? '¬°APROBADO!' : 'Necesitas mejorar';

        // ‚úÖ MENSAJE ESPEC√çFICO PARA DOCENTE
        if (window.esDocente || window.DISABLE_STUDENT_AJAX) {
            console.log('üßë‚Äçüè´ Mostrando resultados finales para docente');
            
            Swal.fire({
                icon: 'info',
                title: 'üßë‚Äçüè´ DEMOSTRACI√ìN COMPLETADA',
                html: `
                    <div style="font-size: 1.1em;">
                        <div style="margin: 20px 0; padding: 15px; background: #ff9800; color: white; border-radius: 10px;">
                            <h3 style="margin: 0; color: white;">MODO DOCENTE</h3>
                            <div style="font-size: 1.5em; margin: 10px 0;">
                                <strong>PUNTAJE: ${finalScore.toFixed(2)}/10</strong>
                            </div>
                            <div style="font-size: 1.1em;">
                                Estado: <strong>${statusText}</strong>
                            </div>
                        </div>

                        <div style="text-align: left; margin: 20px 0;">
                            <h4>üìä Resumen por pregunta:</h4>
                            ${questionsHTML}
                        </div>

                        <div style="margin: 15px 0; padding: 15px; background: #e3f2fd; border-radius: 10px;">
                            <p><strong>‚ÑπÔ∏è Informaci√≥n del modo docente:</strong></p>
                            <p style="margin: 5px 0;">‚Ä¢ No se guardaron intentos</p>
                            <p style="margin: 5px 0;">‚Ä¢ No se consumieron vidas</p>
                            <p style="margin: 5px 0;">‚Ä¢ Esta es solo una demostraci√≥n</p>
                            <p style="margin: 5px 0;">‚Ä¢ Nivel: ${window.levelId} | M√≥dulo: ${window.moduloId}</p>
                        </div>
                    </div>
                `,
                confirmButtonText: 'üîÑ Probar de nuevo',
                cancelButtonText: 'üè† Volver al men√∫',
                showCancelButton: true,
                allowOutsideClick: false,
                customClass: {
                    popup: 'animated tada',
                    confirmButton: 'btn btn-success',
                    cancelButton: 'btn btn-secondary'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    // Reiniciar el juego en modo docente
                    resetGame();
                } else {
                    // Volver al men√∫ de docente
                    window.location.href = `/docente/modulo/${window.moduloId}/niveles/`;
                }
            });
            return;
        }

        // ‚úÖ C√°lculo correcto de vidas antes y despu√©s
        const vidasAntes = vidasRestantes;
        const vidasDespues = Math.max(0, vidasRestantes - 1);
        const puedeIntentarMas = vidasDespues > 0;

        Swal.fire({
            icon: isPassed ? 'success' : 'info',
            title: '¬°JUEGO COMPLETADO! üèÜ',
            html: `
                <div style="font-size: 1.1em;">
                    <div style="margin: 20px 0; padding: 15px; background: ${statusColor}; color: white; border-radius: 10px;">
                        <h3 style="margin: 0; color: white;">${statusText}</h3>
                        <div style="font-size: 1.5em; margin: 10px 0;">
                            <strong>NOTA FINAL: ${finalScore.toFixed(2)}/10</strong>
                        </div>
                    </div>

                    <div style="text-align: left; margin: 20px 0;">
                        <h4>üìä Resumen por pregunta:</h4>
                        ${questionsHTML}
                    </div>

                    <div style="margin: 15px 0; padding: 15px; background: #f0f0f0; border-radius: 10px;">
                        <h4 style="margin: 0 0 10px 0; color: #333;">üíñ Estado de vidas:</h4>
                        <p style="margin: 5px 0;"><strong>Vidas antes:</strong> ${vidasAntes}/${vidasTotales}</p>
                        <p style="margin: 5px 0;"><strong>Vidas despu√©s:</strong> ${vidasDespues}/${vidasTotales}</p>
                        ${puedeIntentarMas ? 
                            `<p style="color: #4CAF50; font-weight: bold;">¬°Puedes intentar ${vidasDespues} vez${vidasDespues !== 1 ? 'es' : ''} m√°s!</p>` : 
                            '<p style="color: #f44336; font-weight: bold;">¬°Se han agotado todas las vidas!</p>'
                        }
                    </div>
                </div>
            `,
            confirmButtonText: puedeIntentarMas ? 'üîÑ Volver a intentar' : 'üè† Volver al men√∫',
            cancelButtonText: 'üè† Volver al men√∫',
            showCancelButton: puedeIntentarMas,
            allowOutsideClick: false,
            customClass: {
                popup: 'animated tada',
                confirmButton: 'btn btn-success',
                cancelButton: 'btn btn-secondary'
            }
        }).then((result) => {
            saveAttempt(finalScore).then((saveResult) => {
                if (saveResult.success) {
                    vidasRestantes = saveResult.vidasRestantes;
                    puedeIntentar = saveResult.puedeIntentar;

                    if (result.isConfirmed && puedeIntentar) {
                        resetGame();
                    } else {
                        updateBestScore().then(() => {
                            window.location.href = `/modulo/${moduloId}/niveles/`;
                        });
                    }
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Hubo un problema al guardar tu intento. Por favor, contacta al administrador.',
                        confirmButtonText: 'Entendido'
                    });
                }
            });
        });
    }


    // Funci√≥n para obtener CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

   
    // FUNCI√ìN MODIFICADA: saveAttempt actualizada
    async function saveAttempt(finalScore) {
        // ‚úÖ SIMULACI√ìN PARA DOCENTES
        if (window.esDocente || window.DISABLE_STUDENT_AJAX) {
            console.log('üßë‚Äçüè´ saveAttempt() - Modo docente: SIMULANDO guardado');
            
            // Simular respuesta exitosa sin hacer petici√≥n real
            return { 
                success: true, 
                vidasRestantes: 999,
                puedeIntentar: true,
                nota: finalScore,
                puede_continuar: true,
                estado: 'modo_docente',
                mensaje: 'Simulaci√≥n: Intento no guardado'
            };
        }
        
        // L√≥gica normal para estudiantes
        if (!studentId || studentId <= 0 || isNaN(studentId)) {
            console.error('‚ùå saveAttempt: studentId inv√°lido:', studentId);
            return { success: false, error: 'ID de estudiante inv√°lido' };
        }
        
        if (!levelId || levelId <= 0 || isNaN(levelId)) {
            console.error('‚ùå saveAttempt: levelId inv√°lido:', levelId);
            return { success: false, error: 'ID de nivel inv√°lido' };
        }
        
        try {
            const response = await fetch('/save_attempt/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    estudiante_id: studentId,
                    nivel_id: levelId,
                    puntaje_total: finalScore
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                vidasRestantes = data.vidas_restantes;
                puedeIntentar = data.puede_continuar;
                updateLivesDisplay();
                
                return { 
                    success: true, 
                    data: data,
                    vidasRestantes: vidasRestantes,
                    puedeIntentar: puedeIntentar
                };
            } else {
                console.error('‚ùå Error del servidor en saveAttempt:', data.error);
                return { success: false, error: data.error };
            }
        } catch (error) {
            console.error('‚ùå Error de red en saveAttempt:', error);
            return { success: false, error: 'Error de conexi√≥n: ' + error.message };
        }
    }

    // Funci√≥n para actualizar mejor puntaje
    async function updateBestScore() {
        try {
            const response = await fetch('/update_best_score/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    estudiante_id: studentId,
                    nivel_id: levelId
                })
            });
            
            const data = await response.json();
            if (data.success) {
                console.log('Mejor puntaje actualizado:', data.best_score);
            } else {
                console.error('Error al actualizar mejor puntaje:', data.error);
            }
        } catch (error) {
            console.error('Error al actualizar mejor puntaje:', error);
        }
    }

    // MODIFICAR LA FUNCI√ìN resetGame para reiniciar puntajes
    function resetGame() {
        currentQuestion = 1;
        selectedNumbers = [];
        currentNumbers = [];
        usedQuestions.clear();
        gameFinished = false;
        multipleChoiceAnswers = {};
        hasGameStarted = false; // Resetear estado de juego iniciado
        
        // REINICIAR VARIABLES DE PUNTAJE
        questionScores = [];
        currentScore = 0;
        
        // Limpiar y registrar nueva sesi√≥n
        clearGameSession();
        registerGameSession();
        
        // OCULTAR TODOS LOS CONTENEDORES DE PREGUNTAS POSIBLES
        const containersToHide = [
            'multiple-choice-container',
            'drag-drop-container', 
            'sequence-container',
            'write-number-container', // Pregunta 2: Escribir n√∫meros
            
            'results-container', // Agregar contenedor de resultados
            'game-over-container', // Agregar contenedor de game over
            'final-results-container' // Agregar contenedor de resultados finales
        ];
        
        containersToHide.forEach(containerId => {
            const container = document.getElementById(containerId);
            if (container) {
                container.style.display = 'none';
            }
        });
        
        // MOSTRAR el contenedor inicial
        const numbersContainer = document.getElementById('numbers-container');
        if (numbersContainer) {
            numbersContainer.style.display = 'grid';
        }
        
        // Restaurar instrucciones originales
        const mainInstruction = document.getElementById('main-instruction');
        const instructionCard = document.getElementById('instruction-card');
        
        if (mainInstruction) {
            mainInstruction.innerHTML = '¬°Pinta SOLO los n√∫meros que TERMINAN en 7!';
        }
        
        if (instructionCard) {
            instructionCard.innerHTML = `
                ¬°Pinta SOLO los n√∫meros que TERMINAN en 7!
            `;
        }
        
        // Limpiar TODAS las selecciones posibles
        document.querySelectorAll('.choice-option').forEach(option => {
            option.classList.remove('selected');
            option.style.background = '';
            option.style.boxShadow = '';
        });
        
        document.querySelectorAll('.choice-row').forEach(row => {
            row.classList.remove('selected');
        });
        
        // Limpiar elementos de n√∫mero seleccionados
        document.querySelectorAll('.number-item').forEach(item => {
            item.classList.remove('selected');
            item.style.background = '';
            item.style.boxShadow = '';
        });
        
        // Limpiar elementos de drag and drop
        resetDragDrop();
        
        // Limpiar elementos de secuencia si existen
        document.querySelectorAll('.sequence-item').forEach(item => {
            item.classList.remove('selected');
            item.style.background = '';
        });
        
        // Limpiar inputs de escritura (pregunta 2)
        document.querySelectorAll('.write-input').forEach(input => {
            input.value = '';
            input.classList.remove('correct', 'incorrect');
        });
        
        // Limpiar elementos de drag and drop completamente
        const dragItems = document.querySelectorAll('.drag-item');
        const dropZones = document.querySelectorAll('.drop-zone');
        
        dragItems.forEach(item => {
            item.classList.remove('dragging', 'correct', 'incorrect');
            item.style.display = 'block'; // Restaurar visibilidad
        });
        
        dropZones.forEach(zone => {
            zone.classList.remove('drag-over', 'filled');
            zone.innerHTML = zone.dataset.originalContent || 'Suelta aqu√≠';
        });
        
        // Regenerar n√∫meros iniciales
        displayNumbers();
        
        // Limpiar cualquier mensaje de error o √©xito
        const messageElements = document.querySelectorAll('.error-message, .success-message, .feedback-message');
        messageElements.forEach(msg => msg.remove());
    }

    // Agregar animaci√≥n de pulso para vidas bajas (CSS)
    const pulseStyle = document.createElement('style');
    pulseStyle.textContent = `
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    `;
    document.head.appendChild(pulseStyle);

    // ACTUALIZAR resetDragDrop para usar el nuevo sistema
    function resetDragDrop() {
        resetClickToOrder();
    }

    // AGREGAR estilos CSS para el nuevo sistema
    const clickOrderStyles = document.createElement('style');
    clickOrderStyles.textContent = `
        /* Estilos para el sistema de click-to-order */
        .drag-sortable-number {
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }
        
        .drag-sortable-number:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 16px rgba(76, 175, 80, 0.4);
            border-color: #4CAF50;
        }
        
        .drag-sortable-number.placed {
            background: linear-gradient(45deg, #9E9E9E, #757575) !important;
            cursor: pointer !important;
            border-color: #666;
        }
        
        .drag-sortable-number.placed:hover {
            transform: scale(0.95);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            border-color: #f44336;
        }
        
        .click-ordered-number {
            position: relative;
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
            padding: 10px;
            border-radius: 6px;
            font-weight: bold;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            font-size: 1.2rem;
        }
        
        .order-indicator {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #FF9800;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .drag-drop-slot {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .drag-drop-slot:hover {
            background: #f0f0f0;
            transform: scale(1.02);
        }
        
        .drag-drop-slot.filled:hover {
            background: #ffebee;
            border-color: #f44336;
        }
        
        .correct-slot {
            border-color: #4CAF50 !important;
            background: #e8f5e8 !important;
            animation: correctPulse 1s ease;
        }
        
        .incorrect-slot {
            border-color: #f44336 !important;
            background: #ffebee !important;
            animation: incorrectShake 0.6s ease;
        }
        
        .correct-number {
            background: linear-gradient(45deg, #4CAF50, #45a049) !important;
        }
        
        .incorrect-number {
            background: linear-gradient(45deg, #f44336, #d32f2f) !important;
        }
        
        @keyframes clickPulse {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(4);
                opacity: 0;
            }
        }
        
        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes incorrectShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        /* Responsive para m√≥viles */
        @media (max-width: 768px) {
            .drag-sortable-number {
                font-size: 14px;
                padding: 10px 12px;
            }
            
            .order-indicator {
                width: 16px;
                height: 16px;
                font-size: 0.7rem;
                top: -6px;
                right: -6px;
            }
            
            .click-ordered-number {
                font-size: 1rem;
            }
            
            .drag-drop-slot {
                width: 50px;
                height: 40px;
            }
        }
        
        @media (max-width: 480px) {
            .drag-sortable-number {
                font-size: 12px;
                padding: 8px 10px;
            }
            
            .drag-drop-slot {
                width: 45px;
                height: 35px;
            }
            
            .click-ordered-number {
                font-size: 0.9rem;
            }
        }
    `;

    document.head.appendChild(clickOrderStyles);

    // Funciones de utilidad adicionales
    function playSound(type) {
        // Funci√≥n para reproducir sonidos (opcional)
        // Puedes implementar sonidos usando Web Audio API si lo deseas
        try {
            if (type === 'correct') {
                // Sonido de √©xito
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmYfCzef0fPNeyYELIjN8NSLORsP...');
                audio.play();
            } else if (type === 'incorrect') {
                // Sonido de error
            }
        } catch (e) {
            // Ignorar errores de audio
        }
    }

   // Tambi√©n corregir la funci√≥n de efectos de clic para ser m√°s robusta
    function addClickEffects() {
        document.addEventListener('click', function(e) {
            // Verificar que el target existe y tiene las clases esperadas
            if (!e.target) return;
            
            if (e.target.classList.contains('number-btn') || 
                e.target.classList.contains('choice-option')) {
                
                // Crear efecto visual de clic
                const ripple = document.createElement('div');
                ripple.style.cssText = `
                    position: absolute;
                    border-radius: 50%;
                    background: rgba(255, 255, 255, 0.6);
                    animation: ripple 0.6s linear;
                    pointer-events: none;
                    z-index: 1000;
                `;
                
                const rect = e.target.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                ripple.style.width = ripple.style.height = size + 'px';
                ripple.style.left = (rect.left + rect.width / 2 - size / 2) + 'px';
                ripple.style.top = (rect.top + rect.height / 2 - size / 2) + 'px';
                
                document.body.appendChild(ripple);
                
                setTimeout(() => {
                    if (ripple.parentNode) {
                        ripple.remove();
                    }
                }, 600);
            }
        });
    }

    // Agregar animaci√≥n de ripple en CSS
    const rippleStyle = document.createElement('style');
    rippleStyle.textContent = `
        @keyframes ripple {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            100% {
                transform: scale(4);
                opacity: 0;
            }
        }
    `;

    document.head.appendChild(rippleStyle);

    // Inicializar el juego cuando la p√°gina carga
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ === INICIALIZANDO JUEGO ===');
        console.log('Modo:', window.esDocente ? 'DOCENTE' : 'ESTUDIANTE');
        
        // Quitar el overlay de debug despu√©s de unos segundos
        setTimeout(() => {
            const debugOverlay = document.getElementById('debug-critical');
            if (debugOverlay) {
                debugOverlay.style.display = 'none';
            }
        }, 3000);
            
        // Inicializar datos del juego
        initializeGameData().then((canPlay) => {
            if (canPlay) {
                console.log('‚úÖ Puede jugar - Iniciando elementos del juego');
                createFloatingElements();
                addClickEffects();
                
                // ‚úÖ ASEGURAR QUE displayNumbers SE EJECUTE
                setTimeout(() => {
                    displayNumbers();
                    console.log('üéÆ Juego completamente inicializado');
                }, 100);
            } else {
                console.log('‚ùå No puede jugar - Mostrando mensaje correspondiente');
            }
        }).catch((error) => {
            console.error('‚ùå Error en initializeGameData:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Hubo un problema al inicializar el juego. Por favor, recarga la p√°gina.',
                confirmButtonText: 'Recargar'
            }).then(() => {
                window.location.reload();
            });
        });
        
        // Agregar atajo de teclado para responder (tecla Enter)
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !document.getElementById('answer-btn').disabled) {
                checkAnswer();
            }
        });
        
        // Configurar SweetAlert2 con estilos personalizados
        const swalStyle = document.createElement('style');
        swalStyle.textContent = `
            .swal2-popup {
                font-family: 'Comic Sans MS', cursive, sans-serif !important;
                border-radius: 20px !important;
            }
            .swal2-title {
                color: #ff6b6b !important;
                font-weight: 900 !important;
            }
            .swal2-confirm {
                background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 100%) !important;
                border: none !important;
                border-radius: 25px !important;
                font-weight: 700 !important;
                padding: 12px 30px !important;
            }
            .swal2-cancel {
                background: linear-gradient(135deg, #96ceb4 0%, #45b7d1 100%) !important;
                border: none !important;
                border-radius: 25px !important;
                font-weight: 700 !important;
                padding: 12px 30px !important;
            }
        `;
        document.head.appendChild(swalStyle);
    });

    // Funci√≥n para detectar si es un dispositivo m√≥vil
    function isMobileDevice() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    // Ajustar el juego para dispositivos m√≥viles
    if (isMobileDevice()) {
        document.addEventListener('DOMContentLoaded', function() {
            // Ajustar tama√±os para m√≥viles
            const style = document.createElement('style');
            style.textContent = `
                @media (max-width: 768px) {
                    .number-btn:hover {
                        transform: scale(1.1) !important;
                    }
                    .choice-option:hover {
                        transform: scale(1.05) !important;
                    }
                }
            `;
            document.head.appendChild(style);
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        let correctAnswers = 0;
        const totalSequences = 3;
        
        // Manejar clicks en las opciones - PERMITIR CAMBIO DE SELECCI√ìN
        document.querySelectorAll('.option-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const sequenceItem = this.closest('.sequence-item');
                // CAMBIO IMPORTANTE: Buscar espec√≠ficamente la caja vac√≠a (que tiene "?" o est√° vac√≠a)
                const emptyBox = sequenceItem.querySelector('.sequence-box.empty, .sequence-box[data-answer]');
                const selectedValue = this.dataset.value;
                
                console.log('Caja vac√≠a encontrada:', emptyBox); // Debug
                
                // Verificar si los botones est√°n deshabilitados (ya se verific√≥ la respuesta)
                if (this.disabled) {
                    return; // No permitir cambios despu√©s de verificar
                }
                
                // Verificar que encontramos la caja vac√≠a
                if (!emptyBox) {
                    console.error('No se encontr√≥ la caja vac√≠a en esta secuencia');
                    return;
                }
                
                // Remover selecci√≥n previa en esta secuencia
                sequenceItem.querySelectorAll('.option-btn').forEach(b => {
                    b.classList.remove('selected');
                });
                
                // Marcar como seleccionado el bot√≥n actual
                this.classList.add('selected');
                
                // Actualizar la caja vac√≠a con la nueva selecci√≥n
                emptyBox.textContent = selectedValue;
                emptyBox.classList.add('selected');
                emptyBox.classList.remove('empty');
                
                // Limpiar estados previos de la caja (por si hab√≠a una selecci√≥n anterior)
                emptyBox.classList.remove('correct', 'incorrect');
                
                console.log('Valor actualizado en la caja:', selectedValue); // Debug
            });
        });
    });

    // Funci√≥n para verificar las respuestas de las secuencias
    function checkSequenceAnswers() {
        // Primero evaluamos las respuestas seleccionadas
        let correctAnswers = 0;
        
        // Verificar cada secuencia cuando se llama desde checkAnswer()
        document.querySelectorAll('.sequence-item').forEach(sequenceItem => {
            // CAMBIO IMPORTANTE: Buscar la caja que tiene data-answer (la caja vac√≠a)
            const emptyBox = sequenceItem.querySelector('.sequence-box[data-answer]');
            
            if (emptyBox && emptyBox.classList.contains('selected')) {
                const correctAnswer = emptyBox.dataset.answer;
                const selectedValue = emptyBox.textContent;
                
                console.log(`Secuencia: Correcto=${correctAnswer}, Seleccionado=${selectedValue}`); // Debug
                
                if (selectedValue === correctAnswer) {
                    // Respuesta correcta
                    emptyBox.classList.add('correct');
                    emptyBox.classList.remove('selected');
                    correctAnswers++;
                } else {
                    // Respuesta incorrecta
                    emptyBox.classList.add('incorrect');
                    emptyBox.classList.remove('selected');
                    
                    // Resaltar la respuesta correcta
                    sequenceItem.querySelectorAll('.option-btn').forEach(b => {
                        if (b.dataset.value === correctAnswer) {
                            b.classList.add('correct-answer');
                            b.style.backgroundColor = '#00b894';
                            b.style.color = 'white';
                        }
                    });
                }
                
                // Deshabilitar botones de esta secuencia DESPU√âS de verificar
                sequenceItem.querySelectorAll('.option-btn').forEach(b => {
                    b.disabled = true;
                    b.style.opacity = '0.5';
                    b.style.cursor = 'not-allowed';
                });
            }
        });
        
        // Ahora contar los resultados finales
        const correctBoxes = document.querySelectorAll('.sequence-box.correct');
        const incorrectBoxes = document.querySelectorAll('.sequence-box.incorrect');
        const totalSequences = 3;
        const correctCount = correctBoxes.length;
        const totalCompleted = correctBoxes.length + incorrectBoxes.length;
        
        let isCorrect = false;
        let message = '';
        
        // Solo evaluar si todas las secuencias est√°n completadas
        if (totalCompleted >= totalSequences) {
            // Consideramos "correcto" si complet√≥ al menos 2 de 3 secuencias para efectos visuales
            isCorrect = correctCount >= 2;
            
            // Generar mensaje de feedback basado en el rendimiento
            if (correctCount === 3) {
                message = 'üéâ ¬°Excelente! Completaste todas las secuencias correctamente. ¬°Eres un genio de los patrones!';
            } else if (correctCount === 2) {
                message = 'üåü ¬°Muy bien! Completaste 2 de 3 secuencias. ¬°Tienes buen ojo para los patrones!';
            } else if (correctCount === 1) {
                message = 'üëç ¬°Buen intento! Completaste 1 secuencia correctamente. ¬°Sigue practicando los patrones!';
            } else {
                message = 'üí™ ¬°No te rindas! Los patrones necesitan pr√°ctica. ¬°Int√©ntalo otra vez!';
            }
        }
        
        return {
            isCorrect: isCorrect,
            message: message,
            correctCount: correctCount,
            totalSequences: totalSequences,
            totalCompleted: totalCompleted
        };
    }

    // Funci√≥n adicional para reiniciar el ejercicio (opcional)
    function resetSequenceExercise() {
        // Limpiar todas las selecciones y estados
        document.querySelectorAll('.sequence-item').forEach(sequenceItem => {
            // Rehabilitar botones
            sequenceItem.querySelectorAll('.option-btn').forEach(b => {
                b.disabled = false;
                b.style.opacity = '1';
                b.style.cursor = 'pointer';
                b.classList.remove('selected', 'correct-answer');
                b.style.backgroundColor = '';
                b.style.color = '';
            });
            
            // Limpiar caja de respuesta - SOLO la caja vac√≠a
            const emptyBox = sequenceItem.querySelector('.sequence-box[data-answer]');
            if (emptyBox) {
                emptyBox.textContent = '?';
                emptyBox.classList.remove('selected', 'correct', 'incorrect');
                emptyBox.classList.add('empty');
            }
        });
    }
    // Funci√≥n para inicializar/resetear la pregunta de secuencias
    function initSequenceQuestion() {
        // Resetear todos los botones de opciones
        const optionButtons = document.querySelectorAll('.option-btn');
        optionButtons.forEach(btn => {
            btn.classList.remove('selected');
            btn.disabled = false;
            btn.style.opacity = '1';
        });
        
        // Resetear las cajas de secuencia
        const emptyBoxes = document.querySelectorAll('.sequence-box.empty, .sequence-box.correct');
        emptyBoxes.forEach(box => {
            if (box.classList.contains('correct')) {
                box.classList.remove('correct');
                box.classList.add('empty');
                box.textContent = '?';
            }
        });
        
        // Limpiar el feedback
        const feedback = document.querySelector('.sequence-feedback');
        if (feedback) {
            feedback.innerHTML = '';
        }
        
        // Habilitar el bot√≥n de respuesta (si se maneja desde aqu√≠)
        const answerBtn = document.getElementById('answer-btn');
        if (answerBtn) {
            answerBtn.disabled = false;
        }
    }

</script>

{% endblock %}