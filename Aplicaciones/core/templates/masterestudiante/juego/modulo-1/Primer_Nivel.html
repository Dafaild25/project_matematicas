{% extends "plantillas/MasterEstudiante.html" %}
{% load static %}
{% block title %}Estudiantes_Modulos{% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/Modulo-1/primer-nivel.css' %}">
<style>
        body {
            background: linear-gradient(-45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #ffa726, #ef5350);
            background-size: 400% 400%;
            animation: rainbowShift 8s ease infinite;
            min-height: 100vh;
            font-family: 'Comic Sans MS', cursive, sans-serif;
            overflow-x: hidden;
        }

        @keyframes rainbowShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .main-container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .header-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            text-align: center;
            animation: bounceIn 1s ease-out;
            border: 5px solid #ff6b6b;
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }

        .header-card h1 {
            color: #ff6b6b;
            font-size: 3rem;
            font-weight: 900;
            margin-bottom: 15px;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.3);
            animation: wiggle 2s ease-in-out infinite;
        }

        @keyframes wiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(1deg); }
            75% { transform: rotate(-1deg); }
        }

        .header-card p {
            color: #333;
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .game-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            border: 5px solid #4ecdc4;
            animation: slideInUp 1s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(100px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .instruction-card {
            background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 100%);
            color: white;
            padding: 25px;
            border-radius: 25px;
            margin-bottom: 30px;
            text-align: center;
            font-size: 1.8rem;
            font-weight: 800;
            box-shadow: 0 15px 30px rgba(255, 107, 107, 0.4);
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { box-shadow: 0 15px 30px rgba(255, 107, 107, 0.4); }
            to { box-shadow: 0 15px 30px rgba(255, 107, 107, 0.8); }
        }

        .numbers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .number-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 100%);
            border: none;
            border-radius: 25px;
            padding: 30px 20px;
            font-size: 2.5rem;
            font-weight: 900;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 15px 30px rgba(255, 107, 107, 0.4);
            position: relative;
            overflow: hidden;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            animation: numberFloat 4s ease-in-out infinite;
        }

        @keyframes numberFloat {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            25% { transform: translateY(-5px) rotate(1deg); }
            75% { transform: translateY(5px) rotate(-1deg); }
        }

        .number-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.6s;
        }

        .number-btn:hover::before {
            left: 100%;
        }

        .number-btn:hover {
            transform: scale(1.2) translateY(-10px) rotate(5deg);
            box-shadow: 0 25px 50px rgba(255, 107, 107, 0.6);
            animation-play-state: paused;
        }

        .number-btn:active {
            transform: scale(1.1) translateY(-5px);
        }

        .number-btn.selected {
            background: linear-gradient(135deg, #ffa726 0%, #ff9800 100%);
            box-shadow: 0 15px 30px rgba(255, 167, 38, 0.6);
            transform: scale(1.1);
            border: 4px solid #fff;
        }

        .number-btn.correct-answer {
            background: linear-gradient(135deg, #96ceb4 0%, #45b7d1 100%);
            box-shadow: 0 15px 30px rgba(150, 206, 180, 0.6);
            animation: correctCelebration 1s ease;
        }

        .number-btn.incorrect-answer {
            background: linear-gradient(135deg, #ef5350 0%, #ffa726 100%);
            box-shadow: 0 15px 30px rgba(239, 83, 80, 0.6);
            animation: incorrectShake 0.6s ease;
        }

        @keyframes correctCelebration {
            0% { transform: scale(1); }
            25% { transform: scale(1.3) rotate(10deg); }
            50% { transform: scale(1.4) rotate(-10deg); }
            75% { transform: scale(1.3) rotate(10deg); }
            100% { transform: scale(1.2); }
        }

        @keyframes incorrectShake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-15px) rotate(-5deg); }
            20%, 40%, 60%, 80% { transform: translateX(15px) rotate(5deg); }
        }

        .answer-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 100%);
            color: white;
            border: none;
            padding: 20px 50px;
            border-radius: 50px;
            font-size: 1.8rem;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 15px 30px rgba(255, 107, 107, 0.4);
            display: block;
            margin: 0 auto;
            animation: rainbow 3s ease-in-out infinite;
        }

        @keyframes rainbow {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }

        .answer-btn:hover {
            transform: scale(1.1) translateY(-5px);
            box-shadow: 0 20px 40px rgba(255, 107, 107, 0.6);
        }

        .answer-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            animation: none;
        }

        .floating-elements {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .floating-element {
            position: absolute;
            font-size: 2rem;
            animation: floatAround 8s infinite ease-in-out;
            opacity: 0.7;
        }

        @keyframes floatAround {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.7; }
            25% { transform: translateY(-30px) rotate(90deg); opacity: 1; }
            50% { transform: translateY(-20px) rotate(180deg); opacity: 0.8; }
            75% { transform: translateY(-40px) rotate(270deg); opacity: 1; }
        }

        .confetti {
            position: fixed;
            top: -10px;
            background-color: #f0f0f0;
            width: 10px;
            height: 10px;
            animation: confetti 3s ease-in-out infinite;
            pointer-events: none;
            z-index: 1000;
        }

        @keyframes confetti {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .question-counter {
            background: linear-gradient(135deg, #45b7d1 0%, #96ceb4 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 20px;
            text-align: center;
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 20px;
            box-shadow: 0 10px 20px rgba(69, 183, 209, 0.3);
        }

        /* Estilo para la tabla de opciones m√∫ltiples */
        .multiple-choice-table {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .multiple-choice-table h3 {
            color: #ff6b6b;
            text-align: center;
            font-size: 1.8rem;
            margin-bottom: 20px;
            font-weight: 800;
        }

        .choice-row {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.7);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 3px solid transparent;
        }

        .choice-row:hover {
            background: rgba(255, 107, 107, 0.1);
            transform: translateX(10px);
        }

        .choice-row.selected {
            background: rgba(255, 167, 38, 0.2);
            border-color: #ffa726;
            transform: translateX(10px);
        }

        .choice-label {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
            margin-right: 20px;
            min-width: 200px;
        }

        .choice-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .choice-option {
            background: linear-gradient(135deg, #4ecdc4 0%, #45b7d1 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 15px;
            font-size: 1.3rem;
            font-weight: 700;
            min-width: 60px;
            text-align: center;
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .choice-option:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 16px rgba(78, 205, 196, 0.4);
        }

        .choice-option.selected {
            background: linear-gradient(135deg, #ffa726 0%, #ff9800 100%);
            border-color: #fff;
            transform: scale(1.1);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-card h1 { font-size: 2.5rem; }
            .header-card p { font-size: 1.5rem; }
            .numbers-grid { grid-template-columns: repeat(2, 1fr); gap: 20px; }
            .number-btn { font-size: 2rem; padding: 25px 15px; }
            .main-container { padding: 15px; }
            .choice-row { flex-direction: column; align-items: flex-start; }
            .choice-label { margin-bottom: 10px; min-width: auto; }
        }

        @media (max-width: 480px) {
            .header-card h1 { font-size: 2rem; }
            .header-card p { font-size: 1.3rem; }
            .number-btn { font-size: 1.8rem; padding: 20px 12px; }
            .instruction-card { font-size: 1.5rem; }
        }

        /* Estilos para drag and drop */
        .drag-drop-question {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .drag-numbers-to-sort {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .drag-sortable-number {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: grab;
            font-weight: bold;
            font-size: 18px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            user-select: none;
        }

        .drag-sortable-number:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .drag-sortable-number.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
            cursor: grabbing;
        }

        .drag-drop-zone {
            background: #f1f3f4;
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            min-height: 80px;
            align-items: center;
            flex-wrap: wrap;
        }

        .drag-drop-slot {
            width: 80px;
            height: 60px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            background: white;
            transition: all 0.3s ease;
        }

        .drag-drop-slot::before {
            content: attr(data-position);
            position: absolute;
            top: -25px;
            font-size: 12px;
            color: #666;
            font-weight: bold;
        }

        .drag-drop-slot.drag-over {
            border-color: #4CAF50;
            background: #e8f5e8;
            transform: scale(1.05);
        }

        .drag-drop-slot.filled {
            border-color: #4CAF50;
            background: #e8f5e8;
        }

        .drag-dropped-number {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
            padding: 10px;
            border-radius: 6px;
            font-weight: bold;
            cursor: grab;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
        }
    </style>
{% endblock %}


{% block content %}
    <div class="container-fluid">
        <nav class="breadcrumb">
            <a style="color: #000;" href="{% url 'core_estudiante' %}">üè† Inicio</a> &nbsp;/&nbsp;
            <a style="color: #000;" href="{% url 'estudiante_modulo' %}">üìö M√≥dulos</a> &nbsp;/&nbsp;
            <a style="color: #000;" href="{% url 'ver_niveles_modulo' modulo.mod_id %}"> üéØ Niveles</a> &nbsp;/&nbsp;
            <span style="color: #2632df;">üéÆ Juego</span>
        </nav>

        <div class="card loading">
            <div class="card-header">
                <h2>üåü {{nivel.niv_nombre}} -{{nivel.niv_descripcion}} </h2>
            </div>
            <div class="card-body">

                <div class="main-container">
                    <div class="floating-elements" id="floating-elements"></div>

                    <!-- Header Card -->
                    <div class="header-card">
                        <h1>üåà ¬°N√∫meros M√°gicos! üåà</h1>
                        <p id="main-instruction">üîç ¬°Encuentra los n√∫meros que tengan 5, 6 y 7! üîç</p>
                    </div>

                    <!-- Game Card -->
                    <div class="game-card">
                        <!-- Question Counter -->
                        <div class="question-counter" id="question-counter">
                            <i class="fas fa-star mr-2"></i>
                            Pregunta 1 de 3
                            <i class="fas fa-star ml-2"></i>
                        </div>

                        <!-- Instructions -->
                        <div class="instruction-card" id="instruction-card">
                            <i class="fas fa-star mr-2"></i>
                            ¬°Selecciona TODOS los n√∫meros que contengan <strong>5</strong>, <strong>6</strong> y
                            <strong>7</strong>!
                            <i class="fas fa-star ml-2"></i>
                        </div>

                        <!-- Numbers Grid (para preguntas normales) -->
                        <div class="numbers-grid" id="numbers-container">
                            <!-- Los n√∫meros se generar√°n con JavaScript -->
                        </div>

                        <!-- Multiple Choice Table (para la pregunta especial) -->
                        <div class="multiple-choice-table" id="multiple-choice-container" style="display: none;">
                            <h3>Presiona el n√∫mero que corresponde:</h3>

                            <div class="choice-row" data-question="quinientos-ochenta-siete">
                                <div class="choice-label">Quinientos ochenta y siete:</div>
                                <div class="choice-options">
                                    <div class="choice-option" data-value="578">578</div>
                                    <div class="choice-option" data-value="687">687</div>
                                    <div class="choice-option" data-value="587">587</div>
                                </div>
                            </div>

                            <div class="choice-row" data-question="novecientos-dos">
                                <div class="choice-label">Novecientos dos:</div>
                                <div class="choice-options">
                                    <div class="choice-option" data-value="902">902</div>
                                    <div class="choice-option" data-value="900">900</div>
                                    <div class="choice-option" data-value="912">912</div>
                                </div>
                            </div>

                            <div class="choice-row" data-question="ciento-uno">
                                <div class="choice-label">Ciento uno:</div>
                                <div class="choice-options">
                                    <div class="choice-option" data-value="110">110</div>
                                    <div class="choice-option" data-value="101">101</div>
                                    <div class="choice-option" data-value="100">100</div>
                                </div>
                            </div>

                            <div class="choice-row" data-question="doscientos-doce">
                                <div class="choice-label">Doscientos doce:</div>
                                <div class="choice-options">
                                    <div class="choice-option" data-value="202">202</div>
                                    <div class="choice-option" data-value="212">212</div>
                                    <div class="choice-option" data-value="122">122</div>
                                </div>
                            </div>
                        </div>

                        <!-- Drag and Drop Question -->
                        <div class="drag-drop-question" id="drag-drop-container">
                            <h3
                                style="color: #ff6b6b; text-align: center; font-size: 1.8rem; margin-bottom: 20px; font-weight: 800;">
                                üìä ¬°Ordena los n√∫meros de mayor a menor! üìä
                            </h3>
                            <div class="drag-numbers-to-sort" id="drag-numbers-to-sort">
                                <div class="drag-sortable-number" data-value="37" draggable="true">37</div>
                                <div class="drag-sortable-number" data-value="10" draggable="true">10</div>
                                <div class="drag-sortable-number" data-value="25" draggable="true">25</div>
                                <div class="drag-sortable-number" data-value="47" draggable="true">47</div>
                                <div class="drag-sortable-number" data-value="15" draggable="true">15</div>
                            </div>
                            <div class="drag-drop-zone" id="drag-drop-zone">
                                <div class="drag-drop-slot" data-position="1¬∞"></div>
                                <div class="drag-drop-slot" data-position="2¬∞"></div>
                                <div class="drag-drop-slot" data-position="3¬∞"></div>
                                <div class="drag-drop-slot" data-position="4¬∞"></div>
                                <div class="drag-drop-slot" data-position="5¬∞"></div>
                            </div>
                        </div>

                        <!-- Answer Button -->
                        <button class="answer-btn" id="answer-btn" onclick="checkAnswer()" disabled>
                            <i class="fas fa-check mr-2"></i>
                            ¬°RESPONDER!
                        </button>
                    </div>
                </div>


            </div>

        </div>



    </div>


{% endblock %}


{% block js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // Variables globales para el juego
    window.studentId = 1; // ID del usuario logueado
    window.levelId = 1; // ID del nivel que corresponda
    
</script>

<script>
    let selectedNumbers = [];
    let currentNumbers = [];
    let currentQuestion = 1;
    let totalQuestions = 3; // Ahora son 11 preguntas
    let usedQuestions = new Set();
    let gameFinished = false;
    let multipleChoiceAnswers = {}; // Para almacenar las respuestas de opci√≥n m√∫ltiple
    // NUEVAS VARIABLES PARA EL SISTEMA DE CALIFICACIONES
    let questionScores = []; // Array para guardar puntajes de cada pregunta
    let currentScore = 0;
    let maxScorePerQuestion = 10/3; // Aproximadamente 3.33 puntos por pregunta
    let totalPossibleScore = 10; // 10 puntos TOTAL
   // VARIABLES PARA EL SISTEMA DE VIDAS (ACTUALIZADAS)
    let studentId = null;
    let levelId = null;
    let vidasRestantes = 0;
    let vidasTotales = 0;
    let puedeIntentar = false;

    // Variables para controlar recargas
    let gameSessionId = null;
    let hasGameStarted = false;
    let pageLoadTime = Date.now();

    // Generar ID √∫nico de sesi√≥n
    function generateSessionId() {
        return 'game_' + studentId + '_' + levelId + '_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // Verificar si es una recarga no autorizada
    function isUnauthorizedReload() {
        const sessionKey = `game_session_${studentId}_${levelId}`;
        const storedSession = sessionStorage.getItem(sessionKey);
        
        if (storedSession) {
            const sessionData = JSON.parse(storedSession);
            const timeDiff = Date.now() - sessionData.timestamp;
            
            // Si la sesi√≥n existe y han pasado menos de 30 segundos, es una recarga
            if (timeDiff < 30000) {
                console.log('Recarga detectada dentro de', timeDiff, 'ms');
                return true;
            }
        }
        
        return false;
    }

    // Registrar sesi√≥n actual
    function registerGameSession() {
        const sessionKey = `game_session_${studentId}_${levelId}`;
        gameSessionId = generateSessionId();
        
        const sessionData = {
            sessionId: gameSessionId,
            timestamp: Date.now(),
            questionNumber: currentQuestion,
            hasStarted: hasGameStarted
        };
        
        sessionStorage.setItem(sessionKey, JSON.stringify(sessionData));
        console.log('Sesi√≥n registrada:', sessionData);
    }

    // Limpiar sesi√≥n al salir
    function clearGameSession() {
        const sessionKey = `game_session_${studentId}_${levelId}`;
        sessionStorage.removeItem(sessionKey);
        console.log('Sesi√≥n limpiada');
    }

    // FUNCI√ìN MODIFICADA: initializeGameData
    async function initializeGameData() {
        studentId = window.studentId || 1;
        levelId = window.levelId || 1;
        
        console.log('Student ID:', studentId, 'Level ID:', levelId);
        
        // Verificar si es una recarga no autorizada
        const isReload = isUnauthorizedReload();
        
        if (isReload) {
            console.log('‚ö†Ô∏è RECARGA DETECTADA - Penalizando con una vida');
            
            // Mostrar advertencia de recarga
            Swal.fire({
                icon: 'warning',
                title: '‚ö†Ô∏è Recarga Detectada',
                html: `
                    <div>
                        <p><strong>Se ha detectado una recarga de p√°gina.</strong></p>
                        <p>Como penalizaci√≥n, se restar√° <span style="color: #f44336; font-weight: bold;">1 vida</span>.</p>
                        <br>
                        <p style="color: #666; font-size: 0.9em;">
                            üí° <strong>Consejo:</strong> Evita recargar la p√°gina durante el juego.
                        </p>
                    </div>
                `,
                confirmButtonText: 'Continuar',
                allowOutsideClick: false,
                timer: 4000,
                timerProgressBar: true
            });
            
            // Penalizar con una vida
            const penaltyResult = await penalizeReload();
            if (!penaltyResult.success) {
                console.error('Error al penalizar recarga:', penaltyResult.error);
            }
        }
        
        // Registrar nueva sesi√≥n
        registerGameSession();
        
        // Obtener informaci√≥n del juego
        const gameInfo = await getGameInfo();
        return gameInfo;
    }


    // NUEVA FUNCI√ìN: Obtener informaci√≥n del juego
    async function getGameInfo() {
        try {
            const response = await fetch('/get_game_info/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    estudiante_id: studentId,
                    nivel_id: levelId
                })
            });
            
            const data = await response.json();
            if (data.success) {
                vidasRestantes = data.vidas_restantes;
                vidasTotales = data.vidas_totales;
                puedeIntentar = data.puede_intentar;
                
                console.log(`Vidas: ${vidasRestantes}/${vidasTotales}, Puede intentar: ${puedeIntentar}`);
                
                // Actualizar UI con informaci√≥n de vidas
                updateLivesDisplay();
                
                // Verificar si puede jugar
                if (!puedeIntentar) {
                    showNoLivesMessage();
                    return false;
                }
                
                // Mostrar mensaje de vidas restauradas si aplica
                if (data.vidas_restauradas > 0) {
                    Swal.fire({
                        icon: 'info',
                        title: '¬°Vidas restauradas!',
                        text: `Se han agregado ${data.vidas_restauradas} vidas adicionales a este nivel.`,
                        confirmButtonText: '¬°Genial!'
                    });
                }
                
                return true;
            } else {
                console.error('Error al obtener info del juego:', data.error);
                return false;
            }
        } catch (error) {
            console.error('Error de red al obtener info del juego:', error);
            return false;
        }
    }

    // FUNCI√ìN MODIFICADA: Actualizar display de vidas con indicador de estado
    function updateLivesDisplay() {
        let livesIndicator = document.getElementById('lives-indicator');
        if (!livesIndicator) {
            livesIndicator = document.createElement('div');
            livesIndicator.id = 'lives-indicator';
            livesIndicator.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 100%);
                color: white;
                padding: 15px 20px;
                border-radius: 25px;
                font-weight: bold;
                font-size: 1.1em;
                box-shadow: 0 8px 16px rgba(0,0,0,0.2);
                z-index: 1000;
                font-family: 'Comic Sans MS', cursive, sans-serif;
                transition: all 0.3s ease;
            `;
            document.body.appendChild(livesIndicator);
        }
        
        // Crear corazones para representar vidas
        let heartsHTML = '';
        for (let i = 0; i < vidasTotales; i++) {
            if (i < vidasRestantes) {
                heartsHTML += '‚ù§Ô∏è'; // Vida disponible
            } else {
                heartsHTML += 'üñ§'; // Vida usada
            }
        }
        
        // Cambiar color seg√∫n vidas restantes
        let bgColor = 'linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 100%)';
        if (vidasRestantes <= 1) {
            bgColor = 'linear-gradient(135deg, #f44336 0%, #ff9800 100%)';
            livesIndicator.style.animation = 'pulse 1s infinite';
        } else if (vidasRestantes <= 2) {
            bgColor = 'linear-gradient(135deg, #ff9800 0%, #ffc107 100%)';
        }
        
        livesIndicator.style.background = bgColor;
        
        livesIndicator.innerHTML = `
            <div style="text-align: center;">
                <div style="font-size: 1.2em; margin-bottom: 5px;">${heartsHTML}</div>
                <div>Vidas: ${vidasRestantes}/${vidasTotales}</div>
                ${vidasRestantes <= 1 ? '<div style="font-size: 0.8em; color: #ffeb3b;">¬°Cuidado!</div>' : ''}
            </div>
        `;
    }

    // Event listeners para detectar intentos de salida
    window.addEventListener('beforeunload', function(e) {
        if (hasGameStarted && currentQuestion > 1 && !gameFinished) {
            // Advertir al usuario antes de salir
            const message = '¬øEst√°s seguro de que quieres salir? Perder√°s el progreso actual.';
            e.returnValue = message;
            return message;
        }
        
        // Limpiar sesi√≥n al salir
        clearGameSession();
    });

    // Limpiar sesi√≥n cuando se va a otra p√°gina
    window.addEventListener('pagehide', function() {
        clearGameSession();
    });

    // NUEVA FUNCI√ìN: Mostrar mensaje sin vidas
    function showNoLivesMessage() {
        Swal.fire({
            icon: 'warning',
            title: '¬°Sin vidas restantes! üíî',
            html: `
                <div>
                    <p>Has agotado todas las vidas para este nivel.</p>
                    <p><strong>Vidas utilizadas: ${vidasTotales}/${vidasTotales}</strong></p>
                    <br>
                    <p style="color: #666;">Contacta a tu profesor para obtener m√°s intentos.</p>
                </div>
            `,
            confirmButtonText: 'Volver al men√∫',
            allowOutsideClick: false,
            customClass: {
                popup: 'animated shake'
            }
        }).then(() => {
            window.location.href = '/cuestionario_Modulo1/';
        });
    }
    // Funci√≥n para calcular puntaje de cada pregunta
    function calculateQuestionScore(isCorrect, questionType) {
        let score = 0;
        
        if (questionType === 'normal' || questionType === 'drag-drop') {
            // Preguntas normales y drag-drop: todo o nada
            score = isCorrect ? maxScorePerQuestion : 0;
        } else if (questionType === 'multiple-choice') {
            // Pregunta de opci√≥n m√∫ltiple: puntaje proporcional
            let correctAnswers = 0;
            let totalQuestions = Object.keys(correctMultipleChoiceAnswers).length;
            
            for (let question in correctMultipleChoiceAnswers) {
                const userAnswer = multipleChoiceAnswers[question];
                const correctAnswer = correctMultipleChoiceAnswers[question];
                if (userAnswer === correctAnswer) {
                    correctAnswers++;
                }
            }
            
            score = (correctAnswers / totalQuestions) * maxScorePerQuestion;
        }
        
        return Math.round(score * 100) / 100; // Redondear a 2 decimales
    }
    // Respuestas correctas para la pregunta de opci√≥n m√∫ltiple
    const correctMultipleChoiceAnswers = {
        'quinientos-ochenta-siete': '587',
        'novecientos-dos': '902',
        'ciento-uno': '101',
        'doscientos-doce': '212'
    };

    // Crear elementos flotantes
    function createFloatingElements() {
        const container = document.getElementById('floating-elements');
        const elements = ['üåü', '‚≠ê', '‚ú®', 'üéà', 'üéâ', 'üéä', 'üåà', 'üí´', 'ü¶Ñ', 'üéØ'];
        
        for (let i = 0; i < 20; i++) {
            const element = document.createElement('div');
            element.className = 'floating-element';
            element.innerHTML = elements[Math.floor(Math.random() * elements.length)];
            element.style.left = Math.random() * 100 + '%';
            element.style.top = Math.random() * 100 + '%';
            element.style.animationDelay = Math.random() * 8 + 's';
            element.style.animationDuration = (Math.random() * 4 + 6) + 's';
            container.appendChild(element);
        }
    }

    // Verificar si un n√∫mero contiene los d√≠gitos 5, 6 y 7
    function containsDigits567(number) {
        const str = number.toString();
        return str.includes('5') && str.includes('6') && str.includes('7');
    }

    // Generar un conjunto √∫nico de n√∫meros para cada pregunta
    function generateUniqueNumbers() {
        let attempts = 0;
        let questionSet;
        
        do {
            questionSet = generateNumbers();
            attempts++;
        } while (usedQuestions.has(JSON.stringify(questionSet)) && attempts < 50);
        
        if (attempts < 50) {
            usedQuestions.add(JSON.stringify(questionSet));
        }
        
        return questionSet;
    }

    // Generar n√∫meros apropiados para ni√±os de 5 a√±os
    function generateNumbers() {
        // N√∫meros correctos que contengan 5, 6, 7
        const correctOptions = [
            567, 576, 657, 675, 756, 765,
            
        ];
        
        // Seleccionar 2-3 n√∫meros correctos aleatoriamente
        const numCorrect = Math.floor(Math.random() * 2) + 2; // 2 o 3
        const correctNumbers = [];
        const shuffledCorrect = [...correctOptions].sort(() => Math.random() - 0.5);
        
        for (let i = 0; i < numCorrect; i++) {
            correctNumbers.push(shuffledCorrect[i]);
        }

        // Generar n√∫meros incorrectos
        const incorrectNumbers = [];
        const incorrectOptions = [
            123, 234, 345, 456, 789, 890, 147, 258, 369, 
            159, 267, 348, 159, 753, 951, 357, 159, 753,
            125, 136, 147, 158, 169, 235, 246, 257, 268, 279,
            356, 367, 378, 389, 456, 467, 478, 489, 
            
        ];
        
        const shuffledIncorrect = [...incorrectOptions].sort(() => Math.random() - 0.5);
        
        for (let i = 0; i < 6 - numCorrect; i++) {
            let num = shuffledIncorrect[i];
            if (!containsDigits567(num)) {
                incorrectNumbers.push(num);
            }
        }

        // Combinar y mezclar
        const allNumbers = [...correctNumbers, ...incorrectNumbers];
        return allNumbers.sort(() => Math.random() - 0.5);
    }

    // Mostrar la pregunta de opci√≥n m√∫ltiple
    // Funci√≥n corregida para la pregunta de opci√≥n m√∫ltiple
    function showMultipleChoiceQuestion() {
        // Ocultar otros contenedores
        document.getElementById('numbers-container').style.display = 'none';
        document.getElementById('drag-drop-container').style.display = 'none';
        document.getElementById('multiple-choice-container').style.display = 'block';
        
        // Cambiar las instrucciones
        document.getElementById('main-instruction').innerHTML = 'üî¢ ¬°Identifica los n√∫meros escritos en palabras! üî¢';
        document.getElementById('instruction-card').innerHTML = `
            <i class="fas fa-star mr-2"></i>
            ¬°Presiona el n√∫mero que corresponde a cada palabra!
            <i class="fas fa-star ml-2"></i>
        `;

        // Limpiar respuestas anteriores
        multipleChoiceAnswers = {};
        
        // Limpiar selecciones visuales anteriores
        document.querySelectorAll('.choice-option').forEach(option => {
            option.classList.remove('selected');
            option.style.background = '';
            option.style.boxShadow = '';
        });
        
        document.querySelectorAll('.choice-row').forEach(row => {
            row.classList.remove('selected');
        });
        
        // Actualizar contador de preguntas
        document.getElementById('question-counter').innerHTML = `
            <i class="fas fa-star mr-2"></i>
            Pregunta ${currentQuestion} de ${totalQuestions}
            <i class="fas fa-star ml-2"></i>
        `;
        
        // Agregar event listeners a las opciones
        const choiceOptions = document.querySelectorAll('.choice-option');
        choiceOptions.forEach(option => {
            // Remover event listeners anteriores clonando el elemento
            const newOption = option.cloneNode(true);
            option.parentNode.replaceChild(newOption, option);
            
            newOption.addEventListener('click', function() {
                const row = this.closest('.choice-row');
                const question = row.dataset.question;
                const value = this.dataset.value;
                
                // Remover selecci√≥n anterior en esta fila
                row.querySelectorAll('.choice-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                
                // Seleccionar esta opci√≥n
                this.classList.add('selected');
                row.classList.add('selected');
                
                // Guardar respuesta
                multipleChoiceAnswers[question] = value;
                
                // Habilitar bot√≥n si todas las preguntas est√°n respondidas
                const totalQuestions = Object.keys(correctMultipleChoiceAnswers).length;
                const answeredQuestions = Object.keys(multipleChoiceAnswers).length;
                
                document.getElementById('answer-btn').disabled = answeredQuestions < totalQuestions;
            });
        });
        
        // Resetear bot√≥n de respuesta
        document.getElementById('answer-btn').disabled = true;
    }

    // Mostrar n√∫meros en la pantalla
    function displayNumbers() {

        // Marcar que el juego ha iniciado cuando se muestra la primera pregunta
        if (currentQuestion === 1 && !hasGameStarted) {
            hasGameStarted = true;
            registerGameSession(); // Actualizar sesi√≥n
        }
        // Primero, ocultar TODOS los contenedores
        document.getElementById('numbers-container').style.display = 'none';
        document.getElementById('multiple-choice-container').style.display = 'none';
        document.getElementById('drag-drop-container').style.display = 'none';
        
        // Si es la √∫ltima pregunta (drag and drop)
        if (currentQuestion === totalQuestions) {
            showDragDropQuestion();
            return;
        }
        // Si es la segunda pregunta (opci√≥n m√∫ltiple)
        else if (currentQuestion === 2) {
            showMultipleChoiceQuestion();
            return;
        }
        
        // Pregunta normal (primera pregunta)
        document.getElementById('numbers-container').style.display = 'grid';
        
        const container = document.getElementById('numbers-container');
        container.innerHTML = '';
        selectedNumbers = [];
        
        currentNumbers = generateUniqueNumbers();
        
        currentNumbers.forEach((number, index) => {
            const button = document.createElement('button');
            button.className = 'number-btn';
            button.textContent = number;
            button.onclick = () => selectNumber(number, button);
            button.style.animationDelay = (index * 0.2) + 's';
            button.dataset.number = number;
            container.appendChild(button);
        });

        // Actualizar contador de preguntas
        document.getElementById('question-counter').innerHTML = `
            <i class="fas fa-star mr-2"></i>
            Pregunta ${currentQuestion} de ${totalQuestions}
            <i class="fas fa-star ml-2"></i>
        `;

        // Resetear bot√≥n de respuesta
        document.getElementById('answer-btn').disabled = true;
    }

    // Seleccionar/deseleccionar n√∫mero
    function selectNumber(number, button) {
        if (gameFinished) return;

        const index = selectedNumbers.indexOf(number);
        
        if (index > -1) {
            // Deseleccionar
            selectedNumbers.splice(index, 1);
            button.classList.remove('selected');
        } else {
            // Seleccionar
            selectedNumbers.push(number);
            button.classList.add('selected');
        }

        // Habilitar/deshabilitar bot√≥n de respuesta
        document.getElementById('answer-btn').disabled = selectedNumbers.length === 0;
    }

    // Crear confeti
    function createConfetti() {
        const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffa726', '#ef5350'];
        
        for (let i = 0; i < 50; i++) {
            setTimeout(() => {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                document.body.appendChild(confetti);
                
                setTimeout(() => {
                    confetti.remove();
                }, 3000);
            }, i * 100);
        }
    }

    // Mostrar la pregunta de drag and drop
    function showDragDropQuestion() {
        // Ocultar otros contenedores
        document.getElementById('numbers-container').style.display = 'none';
        document.getElementById('multiple-choice-container').style.display = 'none';
        document.getElementById('drag-drop-container').style.display = 'block';
        
        // Cambiar las instrucciones
        document.getElementById('main-instruction').innerHTML = 'üìä ¬°Ordena los n√∫meros de p√°ginas de libros! üìä';
        document.getElementById('instruction-card').innerHTML = `
            <i class="fas fa-star mr-2"></i>
            ¬°Arrastra los n√∫meros para ordenarlos de MAYOR a MENOR seg√∫n las p√°ginas de los libros!
            <i class="fas fa-star ml-2"></i>
        `;

        // Actualizar contador de preguntas
        document.getElementById('question-counter').innerHTML = `
            <i class="fas fa-star mr-2"></i>
            Pregunta ${currentQuestion} de ${totalQuestions}
            <i class="fas fa-star ml-2"></i>
        `;

        // Resetear drag and drop
        resetDragDrop();
        
        // Inicializar drag and drop
        initDragDrop();
        
        // Deshabilitar bot√≥n hasta que se complete el ordenamiento
        document.getElementById('answer-btn').disabled = true;
    }

    // Variables para drag and drop
    let draggedElement = null;
    const correctDragOrder = [47,37,25, 15,10];

    // Inicializar drag and drop
    function initDragDrop() {
        const sortableNumbers = document.querySelectorAll('.drag-sortable-number');
        const dropSlots = document.querySelectorAll('.drag-drop-slot');

        // Limpiar slots
        dropSlots.forEach(slot => {
            const existing = slot.querySelector('.drag-dropped-number');
            if (existing) {
                existing.remove();
                slot.classList.remove('filled');
            }
        });

        // Restaurar n√∫meros originales
        sortableNumbers.forEach(number => {
            number.style.display = 'block';
            number.addEventListener('dragstart', handleDragStart);
            number.addEventListener('dragend', handleDragEnd);
        });

        // Event listeners para slots
        dropSlots.forEach(slot => {
            slot.addEventListener('dragover', handleDragOver);
            slot.addEventListener('drop', handleDrop);
            slot.addEventListener('dragenter', handleDragEnter);
            slot.addEventListener('dragleave', handleDragLeave);
        });
    }

    // Funciones de drag and drop
    function handleDragStart(e) {
        draggedElement = this;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
    }

    function handleDragEnd(e) {
        this.classList.remove('dragging');
        draggedElement = null;
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        return false;
    }

    function handleDragEnter(e) {
        if (!this.querySelector('.drag-dropped-number')) {
            this.classList.add('drag-over');
        }
    }

    function handleDragLeave(e) {
        this.classList.remove('drag-over');
    }

    // Funci√≥n mejorada para verificar si el drag and drop est√° completo
    function checkDragDropComplete() {
        const dropSlots = document.querySelectorAll('.drag-drop-slot');
        let filledSlots = 0;
        
        dropSlots.forEach(slot => {
            if (slot.querySelector('.drag-dropped-number')) {
                filledSlots++;
            }
        });
        
        // Habilitar bot√≥n solo cuando todos los slots est√©n llenos
        document.getElementById('answer-btn').disabled = filledSlots < dropSlots.length;
    }

    function handleDrop(e) {
        e.stopPropagation();
        this.classList.remove('drag-over');

        if (this.querySelector('.drag-dropped-number')) {
            return false;
        }

        if (draggedElement) {
            const droppedNumber = document.createElement('div');
            droppedNumber.className = 'drag-dropped-number';
            droppedNumber.textContent = draggedElement.textContent;
            droppedNumber.setAttribute('data-value', draggedElement.getAttribute('data-value'));
            droppedNumber.draggable = true;

            droppedNumber.addEventListener('dragstart', handleDroppedDragStart);
            droppedNumber.addEventListener('dragend', handleDragEnd);

            this.appendChild(droppedNumber);
            this.classList.add('filled');
            draggedElement.style.display = 'none';
            
            // Verificar si el drag and drop est√° completo
            checkDragDropComplete();
        }
        return false;
    }

    function handleDroppedDragStart(e) {
        draggedElement = this;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        
        // Permitir arrastrar de vuelta al √°rea de n√∫meros
        const numbersArea = document.getElementById('drag-numbers-to-sort');
        numbersArea.addEventListener('dragover', handleNumbersAreaDragOver);
        numbersArea.addEventListener('drop', handleNumbersAreaDrop);
    }

    // Manejar drag over en el √°rea de n√∫meros
    function handleNumbersAreaDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    }

    // Manejar drop en el √°rea de n√∫meros (devolver n√∫mero)
    function handleNumbersAreaDrop(e) {
        e.stopPropagation();
        
        if (draggedElement && draggedElement.classList.contains('drag-dropped-number')) {
            // Encontrar el n√∫mero original
            const originalNumbers = document.querySelectorAll('.drag-sortable-number');
            const value = draggedElement.getAttribute('data-value');
            
            originalNumbers.forEach(num => {
                if (num.getAttribute('data-value') === value) {
                    num.style.display = 'block';
                }
            });
            
            // Remover de la slot
            const slot = draggedElement.parentNode;
            slot.classList.remove('filled');
            draggedElement.remove();
            
            // Verificar completitud
            checkDragDropComplete();
        }
    }

    // Verificar orden de drag and drop
    function checkDragDropOrder() {
        const dropSlots = document.querySelectorAll('.drag-drop-slot');
        const userOrder = [];
        let hasEmptySlots = false;

        dropSlots.forEach(slot => {
            const droppedNumber = slot.querySelector('.drag-dropped-number');
            if (droppedNumber) {
                userOrder.push(parseInt(droppedNumber.getAttribute('data-value')));
            } else {
                hasEmptySlots = true;
            }
        });

        if (hasEmptySlots) {
            return { isCorrect: false, message: '¬°Completa todos los espacios antes de verificar!' };
        }

        const isCorrect = userOrder.every((value, index) => value === correctDragOrder[index]);
        
        return {
            isCorrect: isCorrect,
            message: isCorrect ? 
                'üéâ ¬°Excelente! Has ordenado correctamente los n√∫meros de mayor a menor.' :
                '‚ùå El orden no es correcto. Recuerda: debe ser de MAYOR a MENOR. ¬°Int√©ntalo de nuevo!'
        };
    }

   // MODIFICAR LA FUNCI√ìN checkAnswer (reemplazar completamente)
    function checkAnswer() {
        if (gameFinished) return;

        gameFinished = true;
        
        let isCorrect = false;
        let feedback = '';
        let questionType = '';
        let score = 0;

        // Si es la pregunta de drag and drop
        if (currentQuestion === totalQuestions) {
            questionType = 'drag-drop';
            const dragResult = checkDragDropOrder();
            isCorrect = dragResult.isCorrect;
            feedback = dragResult.message;
        }
        // Si es la pregunta de opci√≥n m√∫ltiple
        else if (currentQuestion === 2) {
            questionType = 'multiple-choice';
            let correctAnswers = 0;
            let totalQuestionsMultiple = Object.keys(correctMultipleChoiceAnswers).length;
            
            // Verificar cada respuesta
            for (let question in correctMultipleChoiceAnswers) {
                const userAnswer = multipleChoiceAnswers[question];
                const correctAnswer = correctMultipleChoiceAnswers[question];
                
                // Marcar visualmente las respuestas
                const row = document.querySelector(`[data-question="${question}"]`);
                const options = row.querySelectorAll('.choice-option');
                
                options.forEach(option => {
                    const value = option.dataset.value;
                    if (value === correctAnswer) {
                        option.style.background = 'linear-gradient(135deg, #96ceb4 0%, #45b7d1 100%)';
                        option.style.boxShadow = '0 8px 16px rgba(150, 206, 180, 0.6)';
                    } else if (value === userAnswer && value !== correctAnswer) {
                        option.style.background = 'linear-gradient(135deg, #ef5350 0%, #ffa726 100%)';
                        option.style.boxShadow = '0 8px 16px rgba(239, 83, 80, 0.6)';
                    }
                });
                
                if (userAnswer === correctAnswer) {
                    correctAnswers++;
                }
            }
            
            isCorrect = correctAnswers === totalQuestionsMultiple;
            feedback = `Respuestas correctas: ${correctAnswers}/${totalQuestionsMultiple}`;
        } else {
            // Pregunta normal de n√∫meros con 5, 6, 7
            questionType = 'normal';
            const correctNumbers = currentNumbers.filter(num => containsDigits567(num));
            
            // Verificar si la respuesta es correcta
            const selectedCorrect = selectedNumbers.filter(num => containsDigits567(num));
            const selectedIncorrect = selectedNumbers.filter(num => !containsDigits567(num));
            
            isCorrect = selectedCorrect.length === correctNumbers.length && 
                    selectedIncorrect.length === 0 && 
                    correctNumbers.every(num => selectedNumbers.includes(num));

            // Marcar visualmente los n√∫meros
            const buttons = document.querySelectorAll('.number-btn');
            buttons.forEach(button => {
                const number = parseInt(button.dataset.number);
                const wasSelected = selectedNumbers.includes(number);
                const shouldBeSelected = containsDigits567(number);
                
                if (shouldBeSelected && wasSelected) {
                    button.classList.add('correct-answer');
                } else if (shouldBeSelected && !wasSelected) {
                    button.classList.add('correct-answer');
                    button.style.border = '4px solid #96ceb4';
                } else if (!shouldBeSelected && wasSelected) {
                    button.classList.add('incorrect-answer');
                }
            });

            feedback = isCorrect ? 
                `¬°Excelente! Todos contienen los d√≠gitos 5, 6 y 7.` :
                `¬°Buen intento! Recuerda que deben tener TODOS los d√≠gitos: 5, 6 y 7.`;
        }

        // Calcular puntaje de la pregunta
        score = calculateQuestionScore(isCorrect, questionType);
        questionScores.push({
            question: currentQuestion,
            score: score,
            maxScore: maxScorePerQuestion,
            isCorrect: isCorrect,
            type: questionType
        });

        // Mostrar resultado
        setTimeout(() => {
            if (isCorrect) {
                createConfetti();
                Swal.fire({
                    icon: 'success',
                    title: '¬°CORRECTO! üåü',
                    html: `
                        <div>
                            <p>${feedback}</p>
                            <div style="font-size: 1.2em; margin: 15px 0; color: #4CAF50;">
                                <strong>Puntaje: ${score.toFixed(2)}/${maxScorePerQuestion.toFixed(2)} puntos</strong>
                            </div>
                        </div>
                    `,
                    confirmButtonText: currentQuestion < totalQuestions ? '¬°Siguiente pregunta!' : '¬°Ver resultados!',
                    allowOutsideClick: false,
                    customClass: {
                        popup: 'animated bounceIn',
                        confirmButton: 'btn btn-success'
                    }
                }).then(() => {
                    nextQuestion();
                });
            } else {
                Swal.fire({
                    icon: 'info',
                    title: '¬°Sigue intentando! üí™',
                    html: `
                        <div>
                            <p>${feedback}</p>
                            <div style="font-size: 1.2em; margin: 15px 0; color: #ff9800;">
                                <strong>Puntaje: ${score.toFixed(2)}/${maxScorePerQuestion.toFixed(2)} puntos</strong>
                            </div>
                        </div>
                    `,
                    confirmButtonText: 'Continuar',
                    allowOutsideClick: false,
                    customClass: {
                        popup: 'animated shake',
                        confirmButton: 'btn btn-primary'
                    }
                }).then(() => {
                    nextQuestion();
                });
            }
        }, 1500);
    }
    // Pasar a la siguiente pregunta
    function nextQuestion() {
        if (currentQuestion >= totalQuestions) {
            // Juego terminado
            showFinalResults();
        } else {
            // Siguiente pregunta
            currentQuestion++;
            gameFinished = false;
            displayNumbers();
        }
    }

    // FUNCI√ìN CORREGIDA: showFinalResults con c√°lculo correcto de vidas
    function showFinalResults() {
        const totalScore = questionScores.reduce((sum, q) => sum + q.score, 0);
        const finalScore = Math.round(totalScore * 100) / 100;
        
        let questionsHTML = '';
        questionScores.forEach((q, index) => {
            const icon = q.isCorrect ? '‚úÖ' : '‚ùå';
            const color = q.isCorrect ? '#4CAF50' : '#f44336';
            questionsHTML += `
                <div style="margin: 10px 0; padding: 10px; border-left: 4px solid ${color}; background: #f9f9f9;">
                    <strong>Pregunta ${q.question}:</strong> ${icon} ${q.score.toFixed(2)}/${q.maxScore.toFixed(2)} puntos
                </div>
            `;
        });
        
        const isPassed = finalScore >= 7;
        const statusColor = isPassed ? '#4CAF50' : '#ff9800';
        const statusText = isPassed ? '¬°APROBADO!' : 'Necesitas mejorar';
        
        // CORRECCI√ìN: Calcular las vidas correctamente
        const vidasAntes = vidasRestantes; // Vidas antes del intento actual
        const vidasDespues = vidasRestantes - 1; // Vidas despu√©s de usar este intento
        const vidasRestantesParaIntentar = Math.max(0, vidasDespues); // No puede ser negativo
        
        Swal.fire({
            icon: isPassed ? 'success' : 'info',
            title: '¬°JUEGO COMPLETADO! üèÜ',
            html: `
                <div style="font-size: 1.1em;">
                    <div style="margin: 20px 0; padding: 15px; background: ${statusColor}; color: white; border-radius: 10px;">
                        <h3 style="margin: 0; color: white;">${statusText}</h3>
                        <div style="font-size: 1.5em; margin: 10px 0;">
                            <strong>NOTA FINAL: ${finalScore.toFixed(2)}/10</strong>
                        </div>
                    </div>
                    
                    <div style="text-align: left; margin: 20px 0;">
                        <h4>üìä Resumen por pregunta:</h4>
                        ${questionsHTML}
                    </div>
                    
                    <div style="margin: 15px 0; padding: 15px; background: #f0f0f0; border-radius: 10px;">
                        <h4 style="margin: 0 0 10px 0; color: #333;">üíñ Estado de vidas:</h4>
                        <p style="margin: 5px 0;"><strong>Vidas antes:</strong> ${vidasAntes}/${vidasTotales}</p>
                        <p style="margin: 5px 0;"><strong>Vidas despu√©s:</strong> ${vidasDespues}/${vidasTotales}</p>
                        ${vidasRestantesParaIntentar > 0 ? 
                            `<p style="color: #4CAF50; font-weight: bold;">¬°Puedes intentar ${vidasRestantesParaIntentar} vez${vidasRestantesParaIntentar !== 1 ? 'es' : ''} m√°s!</p>` : 
                            '<p style="color: #f44336; font-weight: bold;">¬°Se han agotado todas las vidas!</p>'
                        }
                    </div>
                </div>
            `,
            confirmButtonText: vidasRestantesParaIntentar > 0 ? 'üîÑ Volver a intentar' : 'üè† Volver al men√∫',
            cancelButtonText: 'üè† Volver al men√∫',
            showCancelButton: vidasRestantesParaIntentar > 0,
            allowOutsideClick: false,
            customClass: {
                popup: 'animated tada',
                confirmButton: 'btn btn-success',
                cancelButton: 'btn btn-secondary'
            }
        }).then((result) => {
            // SIEMPRE guardar el intento ANTES de cualquier acci√≥n
            console.log('Guardando intento con puntaje:', finalScore);
            saveAttempt(finalScore).then((saveResult) => {
                if (saveResult.success) {
                    console.log('Intento guardado exitosamente');
                    
                    // Actualizar variables con los datos del servidor
                    vidasRestantes = saveResult.vidasRestantes;
                    puedeIntentar = saveResult.puedeIntentar;
                    
                    if (result.isConfirmed && puedeIntentar) {
                        // Volver a intentar
                        resetGame();
                    } else {
                        // Volver al men√∫
                        updateBestScore().then(() => {
                            window.location.href = '/cuestionario_Modulo1/';
                        });
                    }
                } else {
                    console.error('Error al guardar intento:', saveResult.error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Hubo un problema al guardar tu intento. Por favor, contacta al administrador.',
                        confirmButtonText: 'Entendido'
                    });
                }
            });
        });
    }

    // Funci√≥n para obtener CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

   
    // FUNCI√ìN MODIFICADA: saveAttempt actualizada
    async function saveAttempt(finalScore) {
        try {
            console.log('Enviando datos:', {
                estudiante_id: studentId,
                nivel_id: levelId,
                puntaje_total: finalScore
            });

            const response = await fetch('/save_attempt/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    estudiante_id: studentId,
                    nivel_id: levelId,
                    puntaje_total: finalScore
                })
            });
            
            const data = await response.json();
            console.log('Respuesta del servidor:', data);
            
            if (data.success) {
                // Actualizar variables locales
                vidasRestantes = data.vidas_restantes;
                puedeIntentar = data.puede_continuar;
                
                // Actualizar display de vidas
                updateLivesDisplay();
                
                console.log('Intento guardado correctamente con nota:', data.nota);
                return { 
                    success: true, 
                    data: data,
                    vidasRestantes: vidasRestantes,
                    puedeIntentar: puedeIntentar
                };
            } else {
                console.error('Error del servidor:', data.error);
                return { success: false, error: data.error };
            }
        } catch (error) {
            console.error('Error de red al guardar intento:', error);
            return { success: false, error: 'Error de conexi√≥n: ' + error.message };
        }
    }

    // Funci√≥n para actualizar mejor puntaje
    async function updateBestScore() {
        try {
            const response = await fetch('/update_best_score/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    estudiante_id: studentId,
                    nivel_id: levelId
                })
            });
            
            const data = await response.json();
            if (data.success) {
                console.log('Mejor puntaje actualizado:', data.best_score);
            } else {
                console.error('Error al actualizar mejor puntaje:', data.error);
            }
        } catch (error) {
            console.error('Error al actualizar mejor puntaje:', error);
        }
    }

    // MODIFICAR LA FUNCI√ìN resetGame para reiniciar puntajes
    function resetGame() {
        currentQuestion = 1;
        selectedNumbers = [];
        currentNumbers = [];
        usedQuestions.clear();
        gameFinished = false;
        multipleChoiceAnswers = {};
        hasGameStarted = false; // Resetear estado de juego iniciado
        
        // REINICIAR VARIABLES DE PUNTAJE
        questionScores = [];
        currentScore = 0;

        // Limpiar y registrar nueva sesi√≥n
        clearGameSession();
        registerGameSession();
        
        // Ocultar TODOS los contenedores de preguntas
        document.getElementById('numbers-container').style.display = 'grid';
        document.getElementById('multiple-choice-container').style.display = 'none';
        document.getElementById('drag-drop-container').style.display = 'none';
        
        // Restaurar instrucciones originales
        document.getElementById('main-instruction').innerHTML = 'üîç ¬°Encuentra los n√∫meros que tengan 5, 6 y 7! üîç';
        document.getElementById('instruction-card').innerHTML = `
            <i class="fas fa-star mr-2"></i>
            ¬°Selecciona TODOS los n√∫meros que contengan <strong>5</strong>, <strong>6</strong> y <strong>7</strong>!
            <i class="fas fa-star ml-2"></i>
        `;
        
        // Limpiar selecciones
        document.querySelectorAll('.choice-option').forEach(option => {
            option.classList.remove('selected');
            option.style.background = '';
            option.style.boxShadow = '';
        });
        
        document.querySelectorAll('.choice-row').forEach(row => {
            row.classList.remove('selected');
        });
        
        resetDragDrop();
        displayNumbers();
    }

    // Agregar animaci√≥n de pulso para vidas bajas (CSS)
    const pulseStyle = document.createElement('style');
    pulseStyle.textContent = `
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    `;
    document.head.appendChild(pulseStyle);

    // Nueva funci√≥n para limpiar el drag and drop
    function resetDragDrop() {
        const dropSlots = document.querySelectorAll('.drag-drop-slot');
        const sortableNumbers = document.querySelectorAll('.drag-sortable-number');
        
        // Limpiar slots
        dropSlots.forEach(slot => {
            const existing = slot.querySelector('.drag-dropped-number');
            if (existing) {
                existing.remove();
            }
            slot.classList.remove('filled', 'drag-over');
        });
        
        // Restaurar n√∫meros originales
        sortableNumbers.forEach(number => {
            number.style.display = 'block';
            number.classList.remove('dragging');
        });
    }
    // Funciones de utilidad adicionales
    function playSound(type) {
        // Funci√≥n para reproducir sonidos (opcional)
        // Puedes implementar sonidos usando Web Audio API si lo deseas
        try {
            if (type === 'correct') {
                // Sonido de √©xito
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmYfCzef0fPNeyYELIjN8NSLORsP...');
                audio.play();
            } else if (type === 'incorrect') {
                // Sonido de error
            }
        } catch (e) {
            // Ignorar errores de audio
        }
    }

    // Agregar efectos de sonido al hacer clic
    function addClickEffects() {
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('number-btn') || 
                e.target.classList.contains('choice-option')) {
                
                // Crear efecto visual de clic
                const ripple = document.createElement('div');
                ripple.style.cssText = `
                    position: absolute;
                    border-radius: 50%;
                    background: rgba(255, 255, 255, 0.6);
                    animation: ripple 0.6s linear;
                    pointer-events: none;
                    z-index: 1000;
                `;
                
                const rect = e.target.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                ripple.style.width = ripple.style.height = size + 'px';
                ripple.style.left = (rect.left + rect.width / 2 - size / 2) + 'px';
                ripple.style.top = (rect.top + rect.height / 2 - size / 2) + 'px';
                
                document.body.appendChild(ripple);
                
                setTimeout(() => {
                    ripple.remove();
                }, 600);
            }
        });
    }

    // Agregar animaci√≥n de ripple en CSS
    const rippleStyle = document.createElement('style');
    rippleStyle.textContent = `
        @keyframes ripple {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            100% {
                transform: scale(4);
                opacity: 0;
            }
        }
    `;

    document.head.appendChild(rippleStyle);

    // Inicializar el juego cuando la p√°gina carga
    document.addEventListener('DOMContentLoaded', function() {
            // Inicializar datos del juego
            initializeGameData().then((canPlay) => {
                if (canPlay) {
                    createFloatingElements();
                    addClickEffects();
                    displayNumbers();
                }
                // Si canPlay es false, ya se mostr√≥ el mensaje de sin vidas
            });
          
        
        // Agregar atajo de teclado para responder (tecla Enter)
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !document.getElementById('answer-btn').disabled) {
                checkAnswer();
            }
        });
        
        // Configurar SweetAlert2 con estilos personalizados
        const swalStyle = document.createElement('style');
        swalStyle.textContent = `
            .swal2-popup {
                font-family: 'Comic Sans MS', cursive, sans-serif !important;
                border-radius: 20px !important;
            }
            .swal2-title {
                color: #ff6b6b !important;
                font-weight: 900 !important;
            }
            .swal2-confirm {
                background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 100%) !important;
                border: none !important;
                border-radius: 25px !important;
                font-weight: 700 !important;
                padding: 12px 30px !important;
            }
            .swal2-cancel {
                background: linear-gradient(135deg, #96ceb4 0%, #45b7d1 100%) !important;
                border: none !important;
                border-radius: 25px !important;
                font-weight: 700 !important;
                padding: 12px 30px !important;
            }
        `;
        document.head.appendChild(swalStyle);
    });

    // Funci√≥n para detectar si es un dispositivo m√≥vil
    function isMobileDevice() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    // Ajustar el juego para dispositivos m√≥viles
    if (isMobileDevice()) {
        document.addEventListener('DOMContentLoaded', function() {
            // Ajustar tama√±os para m√≥viles
            const style = document.createElement('style');
            style.textContent = `
                @media (max-width: 768px) {
                    .number-btn:hover {
                        transform: scale(1.1) !important;
                    }
                    .choice-option:hover {
                        transform: scale(1.05) !important;
                    }
                }
            `;
            document.head.appendChild(style);
        });
    }
</script>

{% endblock %}