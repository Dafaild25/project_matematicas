{% extends 'plantillas/MasterEstudiante.html' %}
{% load static %}
{% block title %}
  Estudiantes_Modulos
{% endblock %}

{% block css %}
  <link rel="stylesheet" href="{% static 'css/Modulo-1/primer-nivel.css' %}" />
  <style>
    body {
      background: linear-gradient(-45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #ffa726, #ef5350);
      background-size: 400% 400%;
      animation: rainbowShift 8s ease infinite;
      min-height: 100vh;
      font-family: 'Comic Sans MS', cursive, sans-serif;
      overflow-x: hidden;
    }
    
    @keyframes rainbowShift {
      0% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
      100% {
        background-position: 0% 50%;
      }
    }
    
    .main-container {
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
    }
    
    .card-header {
      background: linear-gradient(45deg, #ff6b6b, #feca57);
      color: white;
      padding: 25px;
      text-align: center;
    }
    
    .card-header h2 {
      font-size: 2.5rem;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      margin: 0;
    }
    
    .header-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 30px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      text-align: center;
      animation: bounceIn 1s ease-out;
      border: 5px solid #ff6b6b;
    }
    
    @keyframes bounceIn {
      0% {
        transform: scale(0.3);
        opacity: 0;
      }
      50% {
        transform: scale(1.05);
      }
      70% {
        transform: scale(0.9);
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    .header-card h1 {
      color: #ff6b6b;
      font-size: 3rem;
      font-weight: 900;
      margin-bottom: 15px;
      text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.3);
      animation: wiggle 2s ease-in-out infinite;
    }
    
    @keyframes wiggle {
      0%,
      100% {
        transform: rotate(0deg);
      }
      25% {
        transform: rotate(1deg);
      }
      75% {
        transform: rotate(-1deg);
      }
    }
    
    .header-card p {
      color: #333;
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 0;
      animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%,
      100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }
    
    .game-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 30px;
      padding: 30px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      border: 5px solid #4ecdc4;
      animation: slideInUp 1s ease-out;
    }
    
    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(100px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .instruction-card {
      background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 100%);
      color: white;
      padding: 25px;
      border-radius: 25px;
      margin-bottom: 30px;
      text-align: center;
      font-size: 1.8rem;
      font-weight: 800;
      box-shadow: 0 15px 30px rgba(255, 107, 107, 0.4);
      animation: glow 2s ease-in-out infinite alternate;
    }
    
    @keyframes glow {
      from {
        box-shadow: 0 15px 30px rgba(255, 107, 107, 0.4);
      }
      to {
        box-shadow: 0 15px 30px rgba(255, 107, 107, 0.8);
      }
    }

    /* PREGUNTA 1: Libros y nÃºmeros en palabras */
    .libros-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      display: grid;
    }

    .libro-exercise {
      background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
      text-align: center;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }

    .libro-visual {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 20px 0;
      gap: 30px;
      flex-wrap: wrap;
    }

    .libro {
      width: 80px;
      height: 100px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      font-weight: 900;
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      box-shadow: 0 8px 16px rgba(0,0,0,0.3);
      position: relative;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .libro::before {
      content: 'ğŸ“–';
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.5rem;
    }

    .libro:hover {
      transform: scale(1.1) translateY(-5px);
    }

    .libro-rojo { background: linear-gradient(135deg, #ff6b6b, #ff4757); }
    .libro-azul { background: linear-gradient(135deg, #3742fa, #2f3542); }
    .libro-verde { background: linear-gradient(135deg, #2ed573, #1e824c); }
    .libro-amarillo { background: linear-gradient(135deg, #ffa726, #ff8f00); }

    .palabras-options {
      display: flex;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    .palabra-option {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 15px;
      padding: 15px 25px;
      font-size: 1.6rem;
      font-weight: 700;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
    }

    .palabra-option:hover {
      transform: scale(1.1) translateY(-3px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
    }

    .palabra-option.selected {
      background: linear-gradient(135deg, #ffa726 0%, #ff9800 100%);
      border: 3px solid #fff;
      transform: scale(1.1);
    }

    /* PREGUNTA 2: Problemas matemÃ¡ticos narrativos */
    .problemas-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      display: none;
    }

    .problema-exercise {
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
      text-align: center;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }

    .problema-story {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin: 15px 0;
      border: 3px solid #4ecdc4;
      font-size: 1.4rem;
      line-height: 1.6;
      color: #333;
    }

    .problema-visual {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin: 15px 0;
      font-size: 2.5rem;
    }

    /* PREGUNTA 3: Casitas de perritos */
    .casitas-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      display: none;
    }

    .casita-exercise {
      background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
      text-align: center;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }

    .casita-visual {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 30px;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .casita {
      background: linear-gradient(135deg, #ff9800, #f57c00);
      border-radius: 15px 15px 5px 5px;
      padding: 20px;
      position: relative;
      min-width: 100px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }

    .casita::before {
      content: 'ğŸ ';
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 2rem;
    }

    .casita-decenas-unidades {
      font-size: 1.8rem;
      font-weight: 900;
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }

    .casillero-vacio {
      width: 80px;
      height: 80px;
      border: 3px dashed #ff6b6b;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      background: rgba(255, 255, 255, 0.8);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .casillero-vacio:hover {
      background: rgba(255, 255, 255, 1);
      transform: scale(1.1);
    }

    .casillero-vacio.filled {
      border: 3px solid #4CAF50;
      background: #e8f5e8;
      color: #2e7d32;
      font-weight: 900;
    }

    .perrito-opcion {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .perrito-opcion:hover {
      transform: scale(1.1);
    }

    .perrito-emoji {
      font-size: 3rem;
      animation: bounce 2s infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .perrito-numero {
      background: linear-gradient(135deg, #4ecdc4, #45b7d1);
      color: white;
      padding: 10px 20px;
      border-radius: 25px;
      font-size: 1.8rem;
      font-weight: 900;
      box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    }

    /* PREGUNTA 4: Secuencias numÃ©ricas */
    .secuencias-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      display: none;
    }

    .secuencia-exercise {
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
      text-align: center;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }

    .secuencia-visual {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .secuencia-numero {
      background: white;
      border: 4px solid #45b7d1;
      border-radius: 15px;
      padding: 15px 20px;
      font-size: 2.5rem;
      font-weight: 900;
      color: #45b7d1;
      min-width: 70px;
    }

    .secuencia-missing {
      background: #ffe082;
      border: 4px dashed #ff9800;
      color: #ff9800;
      animation: pulse 2s infinite;
    }

    .number-options {
      display: flex;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    .number-option {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 15px;
      padding: 15px 25px;
      font-size: 1.8rem;
      font-weight: 700;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .number-option:hover {
      transform: scale(1.1) translateY(-3px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
    }

    .number-option.selected {
      background: linear-gradient(135deg, #ffa726 0%, #ff9800 100%);
      border: 3px solid #fff;
      transform: scale(1.1);
    }

    .answer-btn {
      background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 100%);
      color: white;
      border: none;
      padding: 20px 50px;
      border-radius: 50px;
      font-size: 1.8rem;
      font-weight: 800;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 15px 30px rgba(255, 107, 107, 0.4);
      display: block;
      margin: 0 auto;
      animation: rainbow 3s ease-in-out infinite;
    }
    
    @keyframes rainbow {
      0% {
        filter: hue-rotate(0deg);
      }
      100% {
        filter: hue-rotate(360deg);
      }
    }
    
    .answer-btn:hover {
      transform: scale(1.1) translateY(-5px);
      box-shadow: 0 20px 40px rgba(255, 107, 107, 0.6);
    }
    
    .answer-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      animation: none;
    }
    
    .floating-elements {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
    }
    
    .floating-element {
      position: absolute;
      font-size: 2rem;
      animation: floatAround 8s infinite ease-in-out;
      opacity: 0.7;
    }
    
    @keyframes floatAround {
      0%,
      100% {
        transform: translateY(0px) rotate(0deg);
        opacity: 0.7;
      }
      25% {
        transform: translateY(-30px) rotate(90deg);
        opacity: 1;
      }
      50% {
        transform: translateY(-20px) rotate(180deg);
        opacity: 0.8;
      }
      75% {
        transform: translateY(-40px) rotate(270deg);
        opacity: 1;
      }
    }
    
    .confetti {
      position: fixed;
      top: -10px;
      background-color: #f0f0f0;
      width: 10px;
      height: 10px;
      animation: confetti 3s ease-in-out infinite;
      pointer-events: none;
      z-index: 1000;
    }
    
    @keyframes confetti {
      0% {
        transform: translateY(-100vh) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
      }
    }
    
    .question-counter {
      background: linear-gradient(135deg, #45b7d1 0%, #96ceb4 100%);
      color: white;
      padding: 15px 30px;
      border-radius: 20px;
      text-align: center;
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 20px;
      box-shadow: 0 10px 20px rgba(69, 183, 209, 0.3);
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .header-card h1 {
        font-size: 2.5rem;
      }
      .header-card p {
        font-size: 1.5rem;
      }
      .number-option, .palabra-option {
        font-size: 1.5rem;
        padding: 12px 20px;
      }
      .main-container {
        padding: 15px;
      }
      .libro-visual, .casita-visual {
        gap: 15px;
      }
      .casita, .libro {
        width: 60px;
        height: 80px;
        font-size: 1.5rem;
      }
    }
    
    @media (max-width: 480px) {
      .header-card h1 {
        font-size: 2rem;
      }
      .header-card p {
        font-size: 1.3rem;
      }
      .number-option, .palabra-option {
        font-size: 1.3rem;
        padding: 10px 15px;
      }
      .instruction-card {
        font-size: 1.5rem;
      }
      .problema-story {
        font-size: 1.2rem;
      }
    }
  </style>
{% endblock %}

{% block content %}
  <div class="container-fluid">
    <nav class="breadcrumb">
      <a style="color: #000;" href="{% url 'core_estudiante' %}">ğŸ  Inicio</a> &nbsp;/&nbsp;
      <a style="color: #000;" href="{% url 'estudiante_modulo' %}">ğŸ“š MÃ³dulos</a> &nbsp;/&nbsp;
      <a style="color: #000;" href="{% url 'ver_niveles_modulo' modulo.mod_id %}">ğŸ¯ Niveles</a> &nbsp;/&nbsp;
      <span style="color: #2632df;">ğŸ® Juego</span>
    </nav>

    <div class="card loading">
      <div class="card-header">
        <h2>ğŸŒŸ {{ nivel.niv_nombre }} - {{ nivel.niv_descripcion }}</h2>
      </div>
      <div class="card-body">
        <div class="main-container">
          <div class="floating-elements" id="floating-elements"></div>

          <!-- Header Card -->
          <div class="header-card">
            <h1>ğŸ§® Â¡MatemÃ¡ticas Divertidas! ğŸ§®</h1>
            <p id="main-instruction">ğŸš€ Â¡Vamos a aprender matemÃ¡ticas! ğŸš€</p>
          </div>

          <!-- Game Card -->
          <div class="game-card">
            <!-- Question Counter -->
            <div class="question-counter" id="question-counter">
              <i class="fas fa-star mr-2"></i>
              Pregunta 1 de 4
              <i class="fas fa-star ml-2"></i>
            </div>

            <!-- PREGUNTA 1: Libros con nÃºmeros y palabras - 4 ejercicios -->
            <div class="instruction-card" id="instruction-card">
              ğŸ“š Â¡Encuentra la palabra que coincide con el nÃºmero del libro!
            </div>

            <div class="libros-container" id="libros-container">
              <!-- Libro 1: 25 = veinticinco -->
              <div class="libro-exercise" data-correct="veinticinco">
                <h4 style="color: #ff6b6b; margin-bottom: 15px;">Â¿CÃ³mo se escribe este nÃºmero en palabras?</h4>
                <div class="libro-visual">
                  <div class="libro libro-rojo" data-color="rojo">25</div>
                  <span style="font-size: 2rem;">ğŸ“– pÃ¡ginas</span>
                </div>
                <div class="palabras-options">
                  <button class="palabra-option" data-value="veinticinco">veinticinco</button>
                  <button class="palabra-option" data-value="cincuenta">cincuenta</button>
                  <button class="palabra-option" data-value="veinte">veinte</button>
                </div>
              </div>

              <!-- Libro 2: 34 = treinta y cuatro -->
              <div class="libro-exercise" data-correct="treinta y cuatro">
                <h4 style="color: #4ecdc4; margin-bottom: 15px;">Â¿CÃ³mo se escribe este nÃºmero en palabras?</h4>
                <div class="libro-visual">
                  <div class="libro libro-azul" data-color="azul">34</div>
                  <span style="font-size: 2rem;">ğŸ“– pÃ¡ginas</span>
                </div>
                <div class="palabras-options">
                  <button class="palabra-option" data-value="cuarenta y tres">cuarenta y tres</button>
                  <button class="palabra-option" data-value="treinta y cuatro">treinta y cuatro</button>
                  <button class="palabra-option" data-value="treinta">treinta</button>
                </div>
              </div>

              <!-- Libro 3: 67 = sesenta y siete -->
              <div class="libro-exercise" data-correct="sesenta y siete">
                <h4 style="color: #45b7d1; margin-bottom: 15px;">Â¿CÃ³mo se escribe este nÃºmero en palabras?</h4>
                <div class="libro-visual">
                  <div class="libro libro-verde" data-color="verde">67</div>
                  <span style="font-size: 2rem;">ğŸ“– pÃ¡ginas</span>
                </div>
                <div class="palabras-options">
                  <button class="palabra-option" data-value="setenta y seis">setenta y seis</button>
                  <button class="palabra-option" data-value="sesenta">sesenta</button>
                  <button class="palabra-option" data-value="sesenta y siete">sesenta y siete</button>
                </div>
              </div>

              <!-- Libro 4: 89 = ochenta y nueve -->
              <div class="libro-exercise" data-correct="ochenta y nueve">
                <h4 style="color: #96ceb4; margin-bottom: 15px;">Â¿CÃ³mo se escribe este nÃºmero en palabras?</h4>
                <div class="libro-visual">
                  <div class="libro libro-amarillo" data-color="amarillo">89</div>
                  <span style="font-size: 2rem;">ğŸ“– pÃ¡ginas</span>
                </div>
                <div class="palabras-options">
                  <button class="palabra-option" data-value="ochenta">ochenta</button>
                  <button class="palabra-option" data-value="ochenta y nueve">ochenta y nueve</button>
                  <button class="palabra-option" data-value="noventa y ocho">noventa y ocho</button>
                </div>
              </div>
            </div>

            <!-- PREGUNTA 2: Problemas matemÃ¡ticos narrativos - 4 ejercicios -->
            <div class="problemas-container" id="problemas-container">
              <h3 style="color: #667eea; text-align: center; font-size: 2.2rem; margin-bottom: 20px; font-weight: 800;">
                ğŸ“ Â¡Resuelve los problemas!
              </h3>
              
              <!-- Problema 1: 3 + 2 = 5 -->
              <div class="problema-exercise" data-correct="5">
                <div class="problema-story">
                  ğŸˆ MarÃ­a tenÃ­a <strong>3 globos</strong>. Su mamÃ¡ le comprÃ³ <strong>2 globos mÃ¡s</strong>. Â¿CuÃ¡ntos globos tiene MarÃ­a ahora?
                </div>
                <div class="problema-visual">
                  ğŸˆğŸˆğŸˆ + ğŸˆğŸˆ = ?
                </div>
                <div class="number-options">
                  <button class="number-option" data-value="5">5</button>
                  <button class="number-option" data-value="4">4</button>
                  <button class="number-option" data-value="6">6</button>
                </div>
              </div>

              <!-- Problema 2: 6 - 2 = 4 -->
              <div class="problema-exercise" data-correct="4">
                <div class="problema-story">
                  ğŸ Juan tenÃ­a <strong>6 manzanas</strong>. Se comiÃ³ <strong>2 manzanas</strong>. Â¿CuÃ¡ntas manzanas le quedan?
                </div>
                <div class="problema-visual">
                  ğŸğŸğŸğŸğŸğŸ - ğŸğŸ = ?
                </div>
                <div class="number-options">
                  <button class="number-option" data-value="4">4</button>
                  <button class="number-option" data-value="3">3</button>
                  <button class="number-option" data-value="5">5</button>
                </div>
              </div>

              <!-- Problema 3: 4 + 3 = 7 -->
              <div class="problema-exercise" data-correct="7">
                <div class="problema-story">
                  ğŸš— Pedro tenÃ­a <strong>4 carritos</strong>. Su papÃ¡ le regalÃ³ <strong>3 carritos mÃ¡s</strong>. Â¿CuÃ¡ntos carritos tiene Pedro en total?
                </div>
                <div class="problema-visual">
                  ğŸš—ğŸš—ğŸš—ğŸš— + ğŸš—ğŸš—ğŸš— = ?
                </div>
                <div class="number-options">
                  <button class="number-option" data-value="7">7</button>
                  <button class="number-option" data-value="6">6</button>
                  <button class="number-option" data-value="8">8</button>
                </div>
              </div>

              <!-- Problema 4: 8 - 3 = 5 -->
              <div class="problema-exercise" data-correct="5">
                <div class="problema-story">
                  ğŸŒŸ Ana tenÃ­a <strong>8 estrellas</strong>. Le regalÃ³ <strong>3 estrellas</strong> a su hermana. Â¿CuÃ¡ntas estrellas le quedan a Ana?
                </div>
                <div class="problema-visual">
                  ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ - ğŸŒŸğŸŒŸğŸŒŸ = ?
                </div>
                <div class="number-options">
                  <button class="number-option" data-value="5">5</button>
                  <button class="number-option" data-value="4">4</button>
                  <button class="number-option" data-value="6">6</button>
                </div>
              </div>
            </div>

            <!-- PREGUNTA 3: Casitas de perritos con unidades y decenas - 4 ejercicios -->
            <div class="casitas-container" id="casitas-container">
              <h3 style="color: #ff6b6b; text-align: center; font-size: 2.2rem; margin-bottom: 25px; font-weight: 800;">
                ğŸ  Â¡Ayuda a los perritos a encontrar su casita!
              </h3>
              
              <!-- Casita 1: 4D + 7U = 47 -->
              <div class="casita-exercise" data-correct="47">
                <div style="font-size: 1.3rem; margin-bottom: 15px; color: #333; font-weight: 600;">
                  Â¿QuÃ© perrito vive en esta casita?
                </div>
                <div class="casita-visual">
                  <div class="casita">
                    <div class="casita-decenas-unidades">4D + 7U</div>
                  </div>
                  <div class="casillero-vacio" id="casillero-1">?</div>
                </div>
                <div class="number-options">
                  <div class="perrito-opcion" data-value="47">
                    <div class="perrito-emoji">ğŸ¶</div>
                    <div class="perrito-numero">47</div>
                  </div>
                  <div class="perrito-opcion" data-value="74">
                    <div class="perrito-emoji">ğŸ•</div>
                    <div class="perrito-numero">74</div>
                  </div>
                  <div class="perrito-opcion" data-value="41">
                    <div class="perrito-emoji">ğŸ¦®</div>
                    <div class="perrito-numero">41</div>
                  </div>
                </div>
              </div>

              <!-- Casita 2: 3D + 6U = 36 -->
              <div class="casita-exercise" data-correct="36">
                <div style="font-size: 1.3rem; margin-bottom: 15px; color: #333; font-weight: 600;">
                  Â¿QuÃ© perrito vive en esta casita?
                </div>
                <div class="casita-visual">
                  <div class="casita">
                    <div class="casita-decenas-unidades">3D + 6U</div>
                  </div>
                  <div class="casillero-vacio" id="casillero-2">?</div>
                </div>
                <div class="number-options">
                  <div class="perrito-opcion" data-value="63">
                    <div class="perrito-emoji">ğŸ©</div>
                    <div class="perrito-numero">63</div>
                  </div>
                  <div class="perrito-opcion" data-value="36">
                    <div class="perrito-emoji">ğŸ•â€ğŸ¦º</div>
                    <div class="perrito-numero">36</div>
                  </div>
                  <div class="perrito-opcion" data-value="39">
                    <div class="perrito-emoji">ğŸº</div>
                    <div class="perrito-numero">39</div>
                  </div>
                </div>
              </div>

              <!-- Casita 3: 5D + 2U = 52 -->
              <div class="casita-exercise" data-correct="52">
                <div style="font-size: 1.3rem; margin-bottom: 15px; color: #333; font-weight: 600;">
                  Â¿QuÃ© perrito vive en esta casita?
                </div>
                <div class="casita-visual">
                  <div class="casita">
                    <div class="casita-decenas-unidades">5D + 2U</div>
                  </div>
                  <div class="casillero-vacio" id="casillero-3">?</div>
                </div>
                <div class="number-options">
                  <div class="perrito-opcion" data-value="52">
                    <div class="perrito-emoji">ğŸ¶</div>
                    <div class="perrito-numero">52</div>
                  </div>
                  <div class="perrito-opcion" data-value="25">
                    <div class="perrito-emoji">ğŸ•</div>
                    <div class="perrito-numero">25</div>
                  </div>
                  <div class="perrito-opcion" data-value="57">
                    <div class="perrito-emoji">ğŸ¦®</div>
                    <div class="perrito-numero">57</div>
                  </div>
                </div>
              </div>

              <!-- Casita 4: 8D + 1U = 81 -->
              <div class="casita-exercise" data-correct="81">
                <div style="font-size: 1.3rem; margin-bottom: 15px; color: #333; font-weight: 600;">
                  Â¿QuÃ© perrito vive en esta casita?
                </div>
                <div class="casita-visual">
                  <div class="casita">
                    <div class="casita-decenas-unidades">8D + 1U</div>
                  </div>
                  <div class="casillero-vacio" id="casillero-4">?</div>
                </div>
                <div class="number-options">
                  <div class="perrito-opcion" data-value="18">
                    <div class="perrito-emoji">ğŸ©</div>
                    <div class="perrito-numero">18</div>
                  </div>
                  <div class="perrito-opcion" data-value="81">
                    <div class="perrito-emoji">ğŸ•â€ğŸ¦º</div>
                    <div class="perrito-numero">81</div>
                  </div>
                  <div class="perrito-opcion" data-value="88">
                    <div class="perrito-emoji">ğŸº</div>
                    <div class="perrito-numero">88</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- PREGUNTA 4: Secuencias numÃ©ricas - 4 ejercicios -->
            <div class="secuencias-container" id="secuencias-container">
              <h3 style="color: #667eea; text-align: center; font-size: 2.2rem; margin-bottom: 25px; font-weight: 800;">
                ğŸ”¢ Â¡Completa las secuencias!
              </h3>
              
              <!-- Secuencia 1: 10, 20, ?, 40 (de 10 en 10) -->
              <div class="secuencia-exercise" data-correct="30">
                <div style="font-size: 1.3rem; margin-bottom: 15px; color: #333; font-weight: 600;">
                  Â¿QuÃ© nÃºmero falta en la secuencia?
                </div>
                <div class="secuencia-visual">
                  <div class="secuencia-numero">10</div>
                  <div class="secuencia-numero">20</div>
                  <div class="secuencia-numero secuencia-missing">?</div>
                  <div class="secuencia-numero">40</div>
                </div>
                <div class="number-options">
                  <button class="number-option" data-value="30">30</button>
                  <button class="number-option" data-value="25">25</button>
                  <button class="number-option" data-value="35">35</button>
                </div>
              </div>

              <!-- Secuencia 2: 15, 25, 35, ? (de 10 en 10) -->
              <div class="secuencia-exercise" data-correct="45">
                <div style="font-size: 1.3rem; margin-bottom: 15px; color: #333; font-weight: 600;">
                  Â¿QuÃ© nÃºmero falta en la secuencia?
                </div>
                <div class="secuencia-visual">
                  <div class="secuencia-numero">15</div>
                  <div class="secuencia-numero">25</div>
                  <div class="secuencia-numero">35</div>
                  <div class="secuencia-numero secuencia-missing">?</div>
                </div>
                <div class="number-options">
                  <button class="number-option" data-value="40">40</button>
                  <button class="number-option" data-value="45">45</button>
                  <button class="number-option" data-value="50">50</button>
                </div>
              </div>

              <!-- Secuencia 3: 22, 24, 26, ? (de 2 en 2) -->
              <div class="secuencia-exercise" data-correct="28">
                <div style="font-size: 1.3rem; margin-bottom: 15px; color: #333; font-weight: 600;">
                  Â¿QuÃ© nÃºmero falta en la secuencia?
                </div>
                <div class="secuencia-visual">
                  <div class="secuencia-numero">22</div>
                  <div class="secuencia-numero">24</div>
                  <div class="secuencia-numero">26</div>
                  <div class="secuencia-numero secuencia-missing">?</div>
                </div>
                <div class="number-options">
                  <button class="number-option" data-value="27">27</button>
                  <button class="number-option" data-value="28">28</button>
                  <button class="number-option" data-value="30">30</button>
                </div>
              </div>

              <!-- Secuencia 4: 50, 45, 40, ? (de 5 en 5 hacia atrÃ¡s) -->
              <div class="secuencia-exercise" data-correct="35">
                <div style="font-size: 1.3rem; margin-bottom: 15px; color: #333; font-weight: 600;">
                  Â¿QuÃ© nÃºmero falta en la secuencia?
                </div>
                <div class="secuencia-visual">
                  <div class="secuencia-numero">50</div>
                  <div class="secuencia-numero">45</div>
                  <div class="secuencia-numero">40</div>
                  <div class="secuencia-numero secuencia-missing">?</div>
                </div>
                <div class="number-options">
                  <button class="number-option" data-value="35">35</button>
                  <button class="number-option" data-value="30">30</button>
                  <button class="number-option" data-value="38">38</button>
                </div>
              </div>
            </div>

            <br />

            <!-- Answer Button -->
            <button class="answer-btn" id="answer-btn" onclick="checkAnswer()" disabled>
              <i class="fas fa-check mr-2"></i>
              Â¡RESPONDER!
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block js %}
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
   
    // Variables globales para el juego
    window.studentId = {{ matricula_id}};
    window.levelId   = {{ level_id }};
    const moduloId = {{ modulo_id }};
    
</script>

<script>
    let selectedNumbers = [];
    let currentNumbers = [];
    let currentQuestion = 1;
    let totalQuestions = 4;
    let usedQuestions = new Set();
    let gameFinished = false;
    
    // NUEVAS VARIABLES PARA EL SISTEMA DE CALIFICACIONES
    let questionScores = [];
    let currentScore = 0;
    let maxScorePerQuestion = 10/4;
    let totalPossibleScore = 10;
    
    // VARIABLES PARA EL SISTEMA DE VIDAS
    let studentId = null;
    let levelId = null;
    let vidasRestantes = 0;
    let vidasTotales = 0;
    let vidasOriginalesNivel = 0;
    let puedeIntentar = false;

    // Variables para controlar recargas
    let gameSessionId = null;
    let hasGameStarted = false;
    let pageLoadTime = Date.now();

    // Variables para preguntas especÃ­ficas
    let librosSelections = {}; // Para pregunta 1
    let problemasSelections = {}; // Para pregunta 2
    let casitasSelections = {}; // Para pregunta 3
    let secuenciasSelections = {}; // Para pregunta 4

    // Generar ID Ãºnico de sesiÃ³n
    function generateSessionId() {
        return 'game_' + studentId + '_' + levelId + '_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // Verificar si es una recarga no autorizada
    function isUnauthorizedReload() {
        const sessionKey = `game_session_${studentId}_${levelId}`;
        const storedSession = sessionStorage.getItem(sessionKey);
        
        if (storedSession) {
            const sessionData = JSON.parse(storedSession);
            const timeDiff = Date.now() - sessionData.timestamp;
            
            if (timeDiff < 30000) {
                console.log('Recarga detectada dentro de', timeDiff, 'ms');
                return true;
            }
        }
        
        return false;
    }

    // Registrar sesiÃ³n actual
    function registerGameSession() {
        const sessionKey = `game_session_${studentId}_${levelId}`;
        gameSessionId = generateSessionId();
        
        const sessionData = {
            sessionId: gameSessionId,
            timestamp: Date.now(),
            questionNumber: currentQuestion,
            hasStarted: hasGameStarted
        };
        
        sessionStorage.setItem(sessionKey, JSON.stringify(sessionData));
        console.log('SesiÃ³n registrada:', sessionData);
    }

    // Limpiar sesiÃ³n al salir
    function clearGameSession() {
        const sessionKey = `game_session_${studentId}_${levelId}`;
        sessionStorage.removeItem(sessionKey);
        console.log('SesiÃ³n limpiada');
    }

    async function initializeGameData() {
        studentId = window.studentId || 1;
        levelId = window.levelId || 1;
        
        console.log('Student ID:', studentId, 'Level ID:', levelId);
        
        const isReload = isUnauthorizedReload();
        
        if (isReload) {
            console.log('âš ï¸ RECARGA DETECTADA - Penalizando con una vida');
            
            Swal.fire({
                icon: 'warning',
                title: 'âš ï¸ Recarga Detectada',
                html: `
                    <div>
                        <p><strong>Se ha detectado una recarga de pÃ¡gina.</strong></p>
                        <p>Como penalizaciÃ³n, se restarÃ¡ <span style="color: #f44336; font-weight: bold;">1 vida</span>.</p>
                        <br>
                        <p style="color: #666; font-size: 0.9em;">
                            ğŸ’¡ <strong>Consejo:</strong> Evita recargar la pÃ¡gina durante el juego.
                        </p>
                    </div>
                `,
                confirmButtonText: 'Continuar',
                allowOutsideClick: false,
                timer: 4000,
                timerProgressBar: true
            });
            
            const penaltyResult = await penalizeReload();
            if (!penaltyResult.success) {
                console.error('Error al penalizar recarga:', penaltyResult.error);
            }
        }
        
        registerGameSession();
        
        const gameInfo = await getGameInfo();
        return gameInfo;
    }

    async function getGameInfo() {
        try {
            const response = await fetch('/get_game_info/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    estudiante_id: studentId,
                    nivel_id: levelId
                })
            });
            
            const data = await response.json();
            if (data.success) {
                vidasRestantes = data.vidas_restantes;
                vidasTotales = data.vidas_originales_nivel;
                puedeIntentar = data.puede_intentar;
                
                console.log(`Vidas: ${vidasRestantes}/${vidasTotales}, Puede intentar: ${puedeIntentar}`);
                
                updateLivesDisplay();
                
                if (!puedeIntentar) {
                    showNoLivesMessage();
                    return false;
                }
                
                if (data.vidas_restauradas > 0) {
                    Swal.fire({
                        icon: 'info',
                        title: 'Â¡Vidas restauradas!',
                        text: `Se han agregado ${data.vidas_restauradas} vidas adicionales a este nivel.`,
                        confirmButtonText: 'Â¡Genial!'
                    });
                }
                
                return true;
            } else {
                console.error('Error al obtener info del juego:', data.error);
                return false;
            }
        } catch (error) {
            console.error('Error de red al obtener info del juego:', error);
            return false;
        }
    }

    // FUNCIÃ“N MODIFICADA: Actualizar display de vidas con indicador de estado
    function updateLivesDisplay() {
        let livesIndicator = document.getElementById('lives-indicator');
        if (!livesIndicator) {
            livesIndicator = document.createElement('div');
            livesIndicator.id = 'lives-indicator';
            livesIndicator.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 100%);
                color: white;
                padding: 15px 20px;
                border-radius: 25px;
                font-weight: bold;
                font-size: 1.1em;
                box-shadow: 0 8px 16px rgba(0,0,0,0.2);
                z-index: 1000;
                font-family: 'Comic Sans MS', cursive, sans-serif;
                transition: all 0.3s ease;
            `;
            document.body.appendChild(livesIndicator);
        }
        
        // Crear corazones para representar vidas
        let heartsHTML = '';
        for (let i = 0; i < vidasTotales; i++) {
            if (i < vidasRestantes) {
                heartsHTML += 'â¤ï¸'; // Vida disponible
            } else {
                heartsHTML += 'ğŸ–¤'; // Vida usada
            }
        }
        
        // Cambiar color segÃºn vidas restantes
        let bgColor = 'linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 100%)';
        if (vidasRestantes <= 1) {
            bgColor = 'linear-gradient(135deg, #f44336 0%, #ff9800 100%)';
            livesIndicator.style.animation = 'pulse 1s infinite';
        } else if (vidasRestantes <= 2) {
            bgColor = 'linear-gradient(135deg, #ff9800 0%, #ffc107 100%)';
        }
        
        livesIndicator.style.background = bgColor;
        
        livesIndicator.innerHTML = `
            <div style="text-align: center;">
                <div style="font-size: 1.2em; margin-bottom: 5px;">${heartsHTML}</div>
                <div>Vidas: ${vidasRestantes}/${vidasTotales}</div>
                ${vidasRestantes <= 1 ? '<div style="font-size: 0.8em; color: #ffeb3b;">Â¡Cuidado!</div>' : ''}
            </div>
        `;
    }

    // NUEVA FUNCIÃ“N: Mostrar mensaje sin vidas
    function showNoLivesMessage() {
        Swal.fire({
            icon: 'warning',
            title: 'Â¡Sin vidas restantes! ğŸ’”',
            html: `
                <div>
                    <p>Has agotado todas las vidas para este nivel.</p>
                    <p><strong>Vidas utilizadas: ${vidasTotales}</strong></p>
                    <br>
                    <p style="color: #666;">Contacta a tu profesor para obtener mÃ¡s intentos.</p>
                </div>
            `,
            confirmButtonText: 'Volver al menÃº',
            allowOutsideClick: false,
            customClass: {
                popup: 'animated shake'
            }
        }).then(() => {
            window.location.href = `/modulo/${moduloId}/niveles/`;
        });
    }

    // Event listeners para detectar intentos de salida
    window.addEventListener('beforeunload', function(e) {
        if (hasGameStarted && currentQuestion > 1 && !gameFinished) {
            const message = 'Â¿EstÃ¡s seguro de que quieres salir? PerderÃ¡s el progreso actual.';
            e.returnValue = message;
            return message;
        }
        
        clearGameSession();
    });

    window.addEventListener('pagehide', function() {
        clearGameSession();
    });
   
    // Crear elementos flotantes
    function createFloatingElements() {
        const container = document.getElementById('floating-elements');
        const elements = ['ğŸ“š', 'ğŸ”¢', 'ğŸ¶', 'ğŸ ', 'âœ¨', 'ğŸŒŸ', 'ğŸ’«', 'â­', 'ğŸ“–', 'ğŸ¯'];
        
        for (let i = 0; i < 20; i++) {
            const element = document.createElement('div');
            element.className = 'floating-element';
            element.innerHTML = elements[Math.floor(Math.random() * elements.length)];
            element.style.left = Math.random() * 100 + '%';
            element.style.top = Math.random() * 100 + '%';
            element.style.animationDelay = Math.random() * 8 + 's';
            element.style.animationDuration = (Math.random() * 4 + 6) + 's';
            container.appendChild(element);
        }
    }

    // Crear confeti
    function createConfetti() {
        const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffa726', '#ef5350'];
        
        for (let i = 0; i < 50; i++) {
            setTimeout(() => {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                document.body.appendChild(confetti);
                
                setTimeout(() => {
                    confetti.remove();
                }, 3000);
            }, i * 100);
        }
    }

    // FunciÃ³n para calcular puntaje de cada pregunta
    function calculateQuestionScore(isCorrect, questionType, details = {}) {
        let score = 0;
        
        if (questionType === 'libros') {
            // Pregunta 1: Libros
            const totalQuestions = 4; // 4 libros
            score = (details.correctCount / totalQuestions) * maxScorePerQuestion;
        } 
        else if (questionType === 'problemas') {
            // Pregunta 2: Problemas
            const totalProblems = 4; // 4 problemas
            score = (details.correctCount / totalProblems) * maxScorePerQuestion;
        }
        else if (questionType === 'casitas') {
            // Pregunta 3: Casitas
            const totalCasitas = 4; // 4 casitas
            score = (details.correctCount / totalCasitas) * maxScorePerQuestion;
        }
        else if (questionType === 'secuencias') {
            // Pregunta 4: Secuencias
            const totalSecuencias = 4; // 4 secuencias
            score = (details.correctCount / totalSecuencias) * maxScorePerQuestion;
        }
        else {
            // Otros tipos: todo o nada
            score = isCorrect ? maxScorePerQuestion : 0;
        }
        
        return Math.round(score * 100) / 100;
    }

    // FunciÃ³n principal para mostrar preguntas
    function displayNumbers() {
        if (currentQuestion === 1 && !hasGameStarted) {
            hasGameStarted = true;
            registerGameSession();
        }

        // Ocultar TODOS los contenedores
        document.getElementById('libros-container').style.display = 'none';
        document.getElementById('problemas-container').style.display = 'none';
        document.getElementById('casitas-container').style.display = 'none';
        document.getElementById('secuencias-container').style.display = 'none';

        // PREGUNTA 1: Libros
        if (currentQuestion === 1) {
            document.getElementById('libros-container').style.display = 'block';
            setupLibrosQuestion();
            
            document.getElementById('main-instruction').innerHTML = 'ğŸ“š Â¡Encuentra las palabras que coinciden con los nÃºmeros!';
            document.getElementById('instruction-card').innerHTML = `
                ğŸ“š Lee el nÃºmero del libro y encuentra cÃ³mo se escribe en palabras
            `;
        }
        
        // PREGUNTA 2: Problemas
        else if (currentQuestion === 2) {
            document.getElementById('problemas-container').style.display = 'block';
            setupProblemasQuestion();
            
            document.getElementById('main-instruction').innerHTML = 'ğŸ“ Â¡Resuelve los problemas matemÃ¡ticos!';
            document.getElementById('instruction-card').innerHTML = `
                ğŸ“ Lee cada problema y encuentra la respuesta correcta
            `;
        }
        
        // PREGUNTA 3: Casitas
        else if (currentQuestion === 3) {
            document.getElementById('casitas-container').style.display = 'block';
            setupCasitasQuestion();
            
            document.getElementById('main-instruction').innerHTML = 'ğŸ  Â¡Ayuda a los perritos a encontrar su casita!';
            document.getElementById('instruction-card').innerHTML = `
                ğŸ  Mira la casita y encuentra el perrito con el nÃºmero correcto
            `;
        }
        
        // PREGUNTA 4: Secuencias
        else if (currentQuestion === 4) {
            document.getElementById('secuencias-container').style.display = 'block';
            setupSecuenciasQuestion();
            
            document.getElementById('main-instruction').innerHTML = 'ğŸ”¢ Â¡Completa las secuencias numÃ©ricas!';
            document.getElementById('instruction-card').innerHTML = `
                ğŸ”¢ Mira el patrÃ³n y encuentra el nÃºmero que falta
            `;
        }

        // Actualizar contador
        document.getElementById('question-counter').innerHTML = `
            <i class="fas fa-star mr-2"></i>
            Pregunta ${currentQuestion} de ${totalQuestions}
            <i class="fas fa-star ml-2"></i>
        `;
    }

    // Configurar pregunta 1: Libros
    function setupLibrosQuestion() {
        librosSelections = {};
        
        document.querySelectorAll('.palabra-option').forEach(btn => {
            btn.classList.remove('selected');
            
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
        });
        
        document.querySelectorAll('.libro-exercise .palabra-option').forEach(btn => {
            btn.addEventListener('click', function() {
                const libroExercise = this.closest('.libro-exercise');
                const exerciseIndex = Array.from(document.querySelectorAll('.libro-exercise')).indexOf(libroExercise);
                
                // Limpiar selecciÃ³n previa en este ejercicio
                libroExercise.querySelectorAll('.palabra-option').forEach(b => {
                    b.classList.remove('selected');
                });
                
                // Marcar como seleccionado
                this.classList.add('selected');
                
                // Guardar selecciÃ³n
                librosSelections[exerciseIndex] = this.dataset.value;
                
                // Verificar si hay al menos una selecciÃ³n para habilitar botÃ³n
                const hasSelections = Object.keys(librosSelections).length > 0;
                document.getElementById('answer-btn').disabled = !hasSelections;
                
                // Efecto visual
                this.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    this.style.transform = 'scale(1)';
                }, 200);
            });
        });
        
        document.getElementById('answer-btn').disabled = true;
    }

    // Configurar pregunta 2: Problemas
    function setupProblemasQuestion() {
        problemasSelections = {};
        
        document.querySelectorAll('.problema-exercise .number-option').forEach(btn => {
            btn.classList.remove('selected');
            
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
        });
        
        document.querySelectorAll('.problema-exercise .number-option').forEach(btn => {
            btn.addEventListener('click', function() {
                const problemaExercise = this.closest('.problema-exercise');
                const exerciseIndex = Array.from(document.querySelectorAll('.problema-exercise')).indexOf(problemaExercise);
                
                // Limpiar selecciÃ³n previa en este ejercicio
                problemaExercise.querySelectorAll('.number-option').forEach(b => {
                    b.classList.remove('selected');
                });
                
                // Marcar como seleccionado
                this.classList.add('selected');
                
                // Guardar selecciÃ³n
                problemasSelections[exerciseIndex] = parseInt(this.dataset.value);
                
                // Verificar si hay al menos una selecciÃ³n para habilitar botÃ³n
                const hasSelections = Object.keys(problemasSelections).length > 0;
                document.getElementById('answer-btn').disabled = !hasSelections;
                
                // Efecto visual
                this.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    this.style.transform = 'scale(1)';
                }, 200);
            });
        });
        
        document.getElementById('answer-btn').disabled = true;
    }

    // Configurar pregunta 3: Casitas
    function setupCasitasQuestion() {
        casitasSelections = {};
        
        document.querySelectorAll('.perrito-opcion').forEach(btn => {
            btn.classList.remove('selected');
            
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
        });
        
        document.querySelectorAll('.casita-exercise .perrito-opcion').forEach(btn => {
            btn.addEventListener('click', function() {
                const casitaExercise = this.closest('.casita-exercise');
                const exerciseIndex = Array.from(document.querySelectorAll('.casita-exercise')).indexOf(casitaExercise);
                
                // Limpiar selecciÃ³n previa en este ejercicio
                casitaExercise.querySelectorAll('.perrito-opcion').forEach(b => {
                    b.classList.remove('selected');
                });
                
                // Marcar como seleccionado
                this.classList.add('selected');
                
                // Llenar casillero
                const casillero = casitaExercise.querySelector('.casillero-vacio');
                const perritoNumero = this.querySelector('.perrito-numero').textContent;
                casillero.textContent = perritoNumero;
                casillero.classList.add('filled');
                
                // Guardar selecciÃ³n
                casitasSelections[exerciseIndex] = parseInt(this.dataset.value);
                
                // Verificar si hay al menos una selecciÃ³n para habilitar botÃ³n
                const hasSelections = Object.keys(casitasSelections).length > 0;
                document.getElementById('answer-btn').disabled = !hasSelections;
                
                // Efecto visual
                this.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    this.style.transform = 'scale(1)';
                }, 200);
            });
        });
        
        document.getElementById('answer-btn').disabled = true;
    }

    // Configurar pregunta 4: Secuencias
    function setupSecuenciasQuestion() {
        secuenciasSelections = {};
        
        document.querySelectorAll('.secuencia-exercise .number-option').forEach(btn => {
            btn.classList.remove('selected');
            
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
        });
        
        document.querySelectorAll('.secuencia-exercise .number-option').forEach(btn => {
            btn.addEventListener('click', function() {
                const secuenciaExercise = this.closest('.secuencia-exercise');
                const exerciseIndex = Array.from(document.querySelectorAll('.secuencia-exercise')).indexOf(secuenciaExercise);
                
                // Limpiar selecciÃ³n previa en este ejercicio
                secuenciaExercise.querySelectorAll('.number-option').forEach(b => {
                    b.classList.remove('selected');
                });
                
                // Marcar como seleccionado
                this.classList.add('selected');
                
                // Guardar selecciÃ³n
                secuenciasSelections[exerciseIndex] = parseInt(this.dataset.value);
                
                // Verificar si hay al menos una selecciÃ³n para habilitar botÃ³n
                const hasSelections = Object.keys(secuenciasSelections).length > 0;
                document.getElementById('answer-btn').disabled = !hasSelections;
                
                // Efecto visual
                this.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    this.style.transform = 'scale(1)';
                }, 200);
            });
        });
        
        document.getElementById('answer-btn').disabled = true;
    }

    // FunciÃ³n principal para verificar respuestas
    function checkAnswer() {
        if (gameFinished) return;

        gameFinished = true;
        
        let isCorrect = false;
        let feedback = '';
        let questionType = '';
        let score = 0;
        let details = {};

        if (currentQuestion === 1) {
            // Pregunta 1: Libros
            questionType = 'libros';
            const libroExercises = document.querySelectorAll('.libro-exercise');
            let correct = 0;

            libroExercises.forEach((exercise, index) => {
                const correctAnswer = exercise.dataset.correct;
                const userAnswer = librosSelections[index];
                
                if (userAnswer === correctAnswer) {
                    correct++;
                }
            });

            const total = libroExercises.length;
            details = { correctCount: correct, totalCount: total };
            isCorrect = correct === total;

            if (correct === total) {
                feedback = 'ğŸ‰ Â¡Perfecto! Conoces muy bien los nÃºmeros en palabras.';
            } else if (correct >= 3) {
                feedback = `ğŸŒŸ Â¡Muy bien! Acertaste ${correct} de ${total} libros.`;
            } else if (correct >= 2) {
                feedback = `ğŸ‘ Â¡Bien! Acertaste ${correct} de ${total} libros.`;
            } else {
                feedback = `ğŸ’¡ Recuerda: Los nÃºmeros se pueden escribir con palabras tambiÃ©n.`;
            }
        }
        else if (currentQuestion === 2) {
            // Pregunta 2: Problemas
            questionType = 'problemas';
            const problemaExercises = document.querySelectorAll('.problema-exercise');
            let correct = 0;

            problemaExercises.forEach((exercise, index) => {
                const correctAnswer = parseInt(exercise.dataset.correct);
                const userAnswer = problemasSelections[index];
                
                if (userAnswer === correctAnswer) {
                    correct++;
                }
            });

            const total = problemaExercises.length;
            details = { correctCount: correct, totalCount: total };
            isCorrect = correct === total;

            if (correct === total) {
                feedback = 'ğŸ‰ Â¡Excelente! Resolviste todos los problemas correctamente.';
            } else if (correct >= 3) {
                feedback = `ğŸŒŸ Â¡Muy bien! Resolviste ${correct} de ${total} problemas.`;
            } else if (correct >= 2) {
                feedback = `ğŸ‘ Â¡Bien! Resolviste ${correct} de ${total} problemas.`;
            } else {
                feedback = `ğŸ’¡ Recuerda: Lee bien el problema y cuenta con cuidado.`;
            }
        }
        else if (currentQuestion === 3) {
            // Pregunta 3: Casitas
            questionType = 'casitas';
            const casitaExercises = document.querySelectorAll('.casita-exercise');
            let correct = 0;

            casitaExercises.forEach((exercise, index) => {
                const correctAnswer = parseInt(exercise.dataset.correct);
                const userAnswer = casitasSelections[index];
                
                if (userAnswer === correctAnswer) {
                    correct++;
                }
            });

            const total = casitaExercises.length;
            details = { correctCount: correct, totalCount: total };
            isCorrect = correct === total;

            if (correct === total) {
                feedback = 'ğŸ‰ Â¡FantÃ¡stico! Todos los perritos encontraron su casita.';
            } else if (correct >= 3) {
                feedback = `ğŸŒŸ Â¡Muy bien! ${correct} de ${total} perritos estÃ¡n en su casita.`;
            } else if (correct >= 2) {
                feedback = `ğŸ‘ Â¡Bien! ${correct} de ${total} perritos estÃ¡n en su casita.`;
            } else {
                feedback = `ğŸ’¡ Recuerda: Las decenas (D) valen 10 cada una y las unidades (U) valen 1.`;
            }
        }
        else if (currentQuestion === 4) {
            // Pregunta 4: Secuencias
            questionType = 'secuencias';
            const secuenciaExercises = document.querySelectorAll('.secuencia-exercise');
            let correct = 0;

            secuenciaExercises.forEach((exercise, index) => {
                const correctAnswer = parseInt(exercise.dataset.correct);
                const userAnswer = secuenciasSelections[index];
                
                if (userAnswer === correctAnswer) {
                    correct++;
                }
            });

            const total = secuenciaExercises.length;
            details = { correctCount: correct, totalCount: total };
            isCorrect = correct === total;

            if (correct === total) {
                feedback = 'ğŸ‰ Â¡IncreÃ­ble! Completaste todas las secuencias perfectamente.';
            } else if (correct >= 3) {
                feedback = `ğŸŒŸ Â¡Muy bien! Completaste ${correct} de ${total} secuencias.`;
            } else if (correct >= 2) {
                feedback = `ğŸ‘ Â¡Bien! Completaste ${correct} de ${total} secuencias.`;
            } else {
                feedback = `ğŸ’¡ Recuerda: Mira el patrÃ³n entre los nÃºmeros para encontrar el que falta.`;
            }
        }

        // Calcular puntaje
        score = calculateQuestionScore(isCorrect, questionType, details);
        questionScores.push({
            question: currentQuestion,
            score: score,
            maxScore: maxScorePerQuestion,
            isCorrect: isCorrect,
            type: questionType
        });

        // Mostrar resultado
        setTimeout(() => {
            if (isCorrect) {
                createConfetti();
                Swal.fire({
                    icon: 'success',
                    title: 'Â¡CORRECTO! ğŸŒŸ',
                    html: `
                        <div>
                            <p>${feedback}</p>
                            <div style="font-size: 1.2em; margin: 15px 0; color: #4CAF50;">
                                <strong>Puntaje: ${score.toFixed(2)}/${maxScorePerQuestion.toFixed(2)} puntos</strong>
                            </div>
                        </div>
                    `,
                    confirmButtonText: currentQuestion < totalQuestions ? 'Â¡Siguiente pregunta!' : 'Â¡Ver resultados!',
                    allowOutsideClick: false,
                    customClass: {
                        popup: 'animated bounceIn',
                        confirmButton: 'btn btn-success'
                    }
                }).then(() => {
                    nextQuestion();
                });
            } else {
                Swal.fire({
                    icon: 'info',
                    title: 'Â¡Sigue intentando! ğŸ’ª',
                    html: `
                        <div>
                            <p>${feedback}</p>
                            <div style="font-size: 1.2em; margin: 15px 0; color: #ff9800;">
                                <strong>Puntaje: ${score.toFixed(2)}/${maxScorePerQuestion.toFixed(2)} puntos</strong>
                            </div>
                        </div>
                    `,
                    confirmButtonText: 'Continuar',
                    allowOutsideClick: false,
                    customClass: {
                        popup: 'animated shake',
                        confirmButton: 'btn btn-primary'
                    }
                }).then(() => {
                    nextQuestion();
                });
            }
        }, 1500);
    }

    // Pasar a la siguiente pregunta
    function nextQuestion() {
        if (currentQuestion >= totalQuestions) {
            showFinalResults();
        } else {
            currentQuestion++;
            gameFinished = false;
            displayNumbers();
        }
    }

    // Mostrar resultados finales (MODIFICADO para mostrar solo un botÃ³n cuando no hay vidas)
    async function showFinalResults() {
        // Calcular puntaje total
        const finalScore = questionScores.reduce((total, q) => total + q.score, 0);
        const percentage = (finalScore / totalPossibleScore) * 100;
        
        // Determinar mensaje de estado
        let statusMessage, statusColor, icon;
        if (percentage >= 90) {
            statusMessage = "Â¡SOBRESALIENTE!";
            statusColor = "#4CAF50";
            icon = "success";
        } else if (percentage >= 80) {
            statusMessage = "Â¡EXCELENTE!";
            statusColor = "#4CAF50";
            icon = "success";
        } else if (percentage >= 70) {
            statusMessage = "Â¡MUY BIEN!";
            statusColor = "#2196F3";
            icon = "success";
        } else if (percentage >= 60) {
            statusMessage = "Â¡BIEN!";
            statusColor = "#FF9800";
            icon = "info";
        } else {
            statusMessage = "Necesitas mejorar";
            statusColor = "#FF9800";
            icon = "warning";
        }

        // Crear resumen de preguntas
        const questionNames = [
            'ğŸ“š NÃºmeros en palabras',
            'ğŸ“ Problemas matemÃ¡ticos', 
            'ğŸ  Casitas de perritos',
            'ğŸ”¢ Secuencias numÃ©ricas'
        ];
        
        let questionSummaryHTML = '';
        questionScores.forEach((q, index) => {
            const emoji = q.isCorrect ? 'âœ…' : 'âŒ';
            questionSummaryHTML += `
                <div style="display: flex; justify-content: space-between; align-items: center; margin: 8px 0; padding: 8px 0; border-bottom: 1px solid #eee;">
                    <span style="font-weight: 500;">Pregunta ${q.question}: ${emoji}</span>
                    <span style="font-weight: 600; color: ${q.isCorrect ? '#4CAF50' : '#f44336'};">${q.score.toFixed(2)}/${q.maxScore.toFixed(2)} puntos</span>
                </div>
            `;
        });

        // Guardar intento
        const saveResult = await saveAttempt(finalScore);
        
        // Crear HTML del resultado final
        const resultHTML = `
            <div style="text-align: center; font-family: 'Comic Sans MS', cursive;">
                <!-- TÃ­tulo principal -->
                <div style="background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 100%); color: white; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                    <h2 style="margin: 0; font-size: 1.8rem; font-weight: 900;">
                        Â¡JUEGO COMPLETADO! ğŸ†
                    </h2>
                </div>

                <!-- Estado y nota -->
                <div style="background: ${statusColor}; color: white; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                    <div style="font-size: 1.4rem; font-weight: 700; margin-bottom: 8px;">
                        ${statusMessage}
                    </div>
                    <div style="font-size: 1.6rem; font-weight: 900;">
                        NOTA FINAL: ${finalScore.toFixed(2)}/10
                    </div>
                </div>

                <!-- Resumen por pregunta -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: left;">
                    <h4 style="margin: 0 0 15px 0; color: #333; font-size: 1.3rem; font-weight: 700; text-align: center;">
                        ğŸ“Š Resumen por pregunta:
                    </h4>
                    ${questionSummaryHTML}
                </div>

                <!-- Estado de vidas -->
                <div style="background: #f0f0f0; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #666; font-size: 1.3rem; font-weight: 700;">
                        ğŸ’— Estado de vidas:
                    </h4>
                    <div style="font-size: 1.1rem; line-height: 1.6;">
                        <div><strong>Vidas antes:</strong> ${vidasTotales}/${vidasTotales}</div>
                        <div><strong>Vidas despuÃ©s:</strong> ${saveResult.vidasRestantes}/${vidasTotales}</div>
                        <div style="color: #4CAF50; font-weight: 600; margin-top: 10px;">
                            ${saveResult.puedeIntentar ? 'Â¡Puedes intentar 1 vez mÃ¡s!' : 'Â¡Sin vidas restantes!'}
                        </div>
                    </div>
                </div>

                ${saveResult.success && saveResult.data.is_best_score ? 
                    '<div style="background: #fff3cd; color: #856404; padding: 15px; border-radius: 10px; margin-bottom: 15px;"><strong>ğŸ† Â¡Nuevo mejor puntaje!</strong></div>' : ''
                }
                
                ${saveResult.success && saveResult.data.nivel_completado ? 
                    '<div style="background: #d1ecf1; color: #0c5460; padding: 15px; border-radius: 10px; margin-bottom: 15px;"><strong>ğŸ‰ Â¡Nivel completado!</strong></div>' : ''
                }
            </div>
        `;

        // CAMBIO PRINCIPAL: Determinar quÃ© botones mostrar segÃºn las vidas restantes
        let buttonsConfig = {};
        
        if (saveResult.puedeIntentar) {
            // Tiene vidas: mostrar ambos botones
            buttonsConfig = {
                showCancelButton: true,
                confirmButtonText: 'ğŸ  Volver al menÃº',
                cancelButtonText: 'ğŸ”„ Jugar de nuevo'
            };
        } else {
            // Sin vidas: solo mostrar botÃ³n de volver al menÃº
            buttonsConfig = {
                showCancelButton: false,
                confirmButtonText: 'ğŸ  Volver al menÃº'
            };
        }

        // Mostrar resultados
        Swal.fire({
            icon: icon,
            title: false, // No mostrar tÃ­tulo por defecto
            html: resultHTML,
            ...buttonsConfig,
            allowOutsideClick: false,
            width: '600px',
            customClass: {
                popup: 'animated bounceIn',
                confirmButton: 'btn btn-primary',
                cancelButton: 'btn btn-success'
            }
        }).then((result) => {
            if (result.isConfirmed) {
                // Volver al menÃº
                window.location.href = `/modulo/${moduloId}/niveles/`;
            } else {
                // Reiniciar juego (solo disponible si tiene vidas)
                if (saveResult.puedeIntentar) {
                    resetGame();
                } else {
                    showNoLivesMessage();
                }
            }
        });

        // Actualizar mejor puntaje
        await updateBestScore();
    }

    // FunciÃ³n para obtener CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // FUNCIÃ“N MODIFICADA: saveAttempt actualizada
    async function saveAttempt(finalScore) {
        try {
            console.log('Enviando datos:', {
                estudiante_id: studentId,
                nivel_id: levelId,
                puntaje_total: finalScore
            });

            const response = await fetch('/save_attempt/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    estudiante_id: studentId,
                    nivel_id: levelId,
                    puntaje_total: finalScore
                })
            });
            
            const data = await response.json();
            console.log('Respuesta del servidor:', data);
            
            if (data.success) {
                // Actualizar variables locales
                vidasRestantes = data.vidas_restantes;
                puedeIntentar = data.puede_continuar;
                
                // Actualizar display de vidas
                updateLivesDisplay();
                
                console.log('Intento guardado correctamente con nota:', data.nota);
                return { 
                    success: true, 
                    data: data,
                    vidasRestantes: vidasRestantes,
                    puedeIntentar: puedeIntentar
                };
            } else {
                console.error('Error del servidor:', data.error);
                return { success: false, error: data.error };
            }
        } catch (error) {
            console.error('Error de red al guardar intento:', error);
            return { success: false, error: 'Error de conexiÃ³n: ' + error.message };
        }
    }

    // Actualizar mejor puntaje
    async function updateBestScore() {
        try {
            const response = await fetch('/update_best_score/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    estudiante_id: studentId,
                    nivel_id: levelId
                })
            });
            
            const data = await response.json();
            if (data.success) {
                console.log('Mejor puntaje actualizado:', data.best_score);
            } else {
                console.error('Error al actualizar mejor puntaje:', data.error);
            }
        } catch (error) {
            console.error('Error al actualizar mejor puntaje:', error);
        }
    }

    // FunciÃ³n para penalizar recarga
    async function penalizeReload() {
        try {
            const response = await fetch('/penalize_reload/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    estudiante_id: studentId,
                    nivel_id: levelId
                })
            });
            
            const data = await response.json();
            if (data.success) {
                vidasRestantes = data.vidas_restantes;
                updateLivesDisplay();
                return { success: true };
            } else {
                return { success: false, error: data.error };
            }
        } catch (error) {
            return { success: false, error: error.message };
        }
    }

    // Reiniciar juego
    function resetGame() {
        currentQuestion = 1;
        selectedNumbers = [];
        currentNumbers = [];
        usedQuestions.clear();
        gameFinished = false;
        hasGameStarted = false;
        
        // Reiniciar variables de puntaje
        questionScores = [];
        currentScore = 0;
        
        // Reiniciar variables de preguntas especÃ­ficas
        librosSelections = {};
        problemasSelections = {};
        casitasSelections = {};
        secuenciasSelections = {};
        
        clearGameSession();
        registerGameSession();
        
        // Ocultar contenedores
        const containers = [
            'problemas-container',
            'casitas-container', 
            'secuencias-container'
        ];
        
        containers.forEach(containerId => {
            const container = document.getElementById(containerId);
            if (container) {
                container.style.display = 'none';
            }
        });
        
        // Limpiar selecciones
        document.querySelectorAll('.palabra-option, .number-option, .perrito-opcion').forEach(btn => {
            btn.classList.remove('selected');
        });
        
        // Limpiar casilleros
        document.querySelectorAll('.casillero-vacio').forEach(casillero => {
            casillero.textContent = '?';
            casillero.classList.remove('filled');
        });
        
        displayNumbers();
    }

    // Agregar animaciÃ³n de pulso para vidas bajas
    const pulseStyle = document.createElement('style');
    pulseStyle.textContent = `
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    `;
    document.head.appendChild(pulseStyle);

    // Inicializar el juego cuando la pÃ¡gina carga
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof initializeGameData === 'function') {
            initializeGameData().then((canPlay) => {
                if (canPlay) {
                    createFloatingElements();
                    displayNumbers();
                }
            }).catch((error) => {
                console.error('Error al inicializar el juego:', error);
            });
        } else {
            console.error('La funciÃ³n initializeGameData no estÃ¡ definida');
        }
        
        // Atajo de teclado para responder
        document.addEventListener('keydown', function(e) {
            const answerBtn = document.getElementById('answer-btn');
            if (e.key === 'Enter' && answerBtn && !answerBtn.disabled) {
                if (typeof checkAnswer === 'function') {
                    checkAnswer();
                }
            }
        });
    
        // Configurar SweetAlert2 con estilos personalizados
        const swalStyle = document.createElement('style');
        swalStyle.textContent = `
            .swal2-popup {
                font-family: 'Comic Sans MS', cursive, sans-serif !important;
                border-radius: 20px !important;
            }
            .swal2-title {
                color: #ff6b6b !important;
                font-weight: 900 !important;
            }
            .swal2-confirm {
                background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 100%) !important;
                border: none !important;
                border-radius: 25px !important;
                font-weight: 700 !important;
                padding: 12px 30px !important;
            }
            .swal2-cancel {
                background: linear-gradient(135deg, #96ceb4 0%, #45b7d1 100%) !important;
                border: none !important;
                border-radius: 25px !important;
                font-weight: 700 !important;
                padding: 12px 30px !important;
            }
        `;
        document.head.appendChild(swalStyle);
    });
</script>
{% endblock %}