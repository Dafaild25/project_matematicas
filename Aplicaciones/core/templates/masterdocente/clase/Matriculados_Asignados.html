{% extends 'plantillas/MasterDocente.html' %}
{% load static %}
{% block title %}
Clases Docente
{% endblock %}

{% block css %}

{% endblock %}
{% block content %}
<div class="container-fluid ">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Clases</h1>
        <a href="{% url 'descargar_plantilla_estudiantes' %}" class="btn btn-primary">
            <i class="fas fa-download"></i> Plantilla Excel</a>

    </div>


    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="{% url 'core_docente' %}">Inicio</a></li>
        <li class="breadcrumb-item active"><a href="{% url 'clase_asignada'%}">Clases Asignadas</a></li>
        <li class="breadcrumb-item active">Tus Estudiantes</li>
    </ol>

    <div class="card mb-4">
      

        <div class="card-header bg-secondary text-white">
            <i class="fas fa-file-upload me-1"></i> Matricular Estudiantes Masivamente
        </div>
        <div class="card-body">
          <div id="mensaje-container" style="display: none;">
            <!-- Los mensajes se insertarán aquí dinámicamente -->
          </div>
             <form id="form-importar-excel" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="row">
                <div class="col-md-10">
                    <input type="hidden" name="cla_id" id="cla_id" value="{{ clase.cla_id }}">
                    <input type="file" name="archivo" id="archivo" class="form-control" accept=".xlsx" required>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-success">Importar</button>
                </div>
            </div>
        </form>
        </div>
    </div>


    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
    <div>
        <i class="fas fa-table me-1"></i>
        Lista de los estudiantes
    </div>
    <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#modalCrearEstudiante">
        <i class="fas fa-user-plus"></i> Agregar estudiante
    </button>
</div>

        <div class="card-body" id="contenedor-tabla-matriculados-docente" data-cla-id="{{ clase.cla_id }}">
            
        <!-- aqui va la tabla -->
        </div>
</div>
</div>



{% comment %} modal para crear un estudiante {% endcomment %}

<!-- Modal Crear Estudiante -->
<div class="modal fade" id="modalCrearEstudiante" tabindex="-1" aria-labelledby="modalCrearEstudianteLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <form method="POST" action="{% url 'crear_estudiante_docente' %}">
        {% csrf_token %}
        <input type="hidden" name="clase_id" value="{{ clase.cla_id }}">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="modalCrearEstudianteLabel">Registrar nuevo estudiante</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              {{ form.nombre.label_tag }}
              {{ form.nombre }}
              {% if form.nombre.errors %}
              <div class="text-danger">{{ form.nombre.errors.0 }}</div>
              {% endif %}
            </div>

            <div class="col-md-6">
              {{ form.segundo_nombre.label_tag }}
              {{ form.segundo_nombre }}
              {% if form.segundo_nombre.errors %}
              <div class="text-danger">{{ form.segundo_nombre.errors.0 }}</div>
              {% endif %}
            </div>

            <div class="col-md-6">
              {{ form.apellido.label_tag }}
              {{ form.apellido }}
              {% if form.apellido.errors %}
              <div class="text-danger">{{ form.apellido.errors.0 }}</div>
              {% endif %}
            </div>

            <div class="col-md-6">
              {{ form.segundo_apellido.label_tag }}
              {{ form.segundo_apellido }}
              {% if form.segundo_apellido.errors %}
              <div class="text-danger">{{ form.segundo_apellido.errors.0 }}</div>
              {% endif %}
            </div>

            <div class="col-md-6">
              {{ form.email.label_tag }}
              {{ form.email }}
              {% if form.email.errors %}
              <div class="text-danger">{{ form.email.errors.0 }}</div>
              {% endif %}
            </div>

            <div class="col-md-6">
              {{ form.cedula.label_tag }}
              {{ form.cedula }}
              {% if form.cedula.errors %}
              <div class="text-danger">{{ form.cedula.errors.0 }}</div>
              {% endif %}
            </div>

            <div class="col-md-6">
              {{ form.telefono.label_tag }}
              {{ form.telefono }}
            </div>

            <div class="col-md-6">
              {{ form.fecha_nacimiento.label_tag }}
              {{ form.fecha_nacimiento }}
            </div>

            <div class="col-md-6">
              {{ form.contacto_emergencia.label_tag }}
              {{ form.contacto_emergencia }}
            </div>

            <div class="col-md-6">
              {{ form.telefono_emergencia.label_tag }}
              {{ form.telefono_emergencia }}
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar Estudiante</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% if mostrar_modal %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const modal = new bootstrap.Modal(document.getElementById('modalCrearEstudiante'));
        modal.show();
    });
</script>
{% endif %}

{% if messages %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  

  const Toast = Swal.mixin({
    toast: true,
    position: 'top-end',
    showConfirmButton: false,
    timer: 3000,
    timerProgressBar: true,
    didOpen: (toast) => {
      toast.onmouseenter = Swal.stopTimer;
      toast.onmouseleave = Swal.resumeTimer;
    }
  });

  {% for message in messages %}
    Toast.fire({
      icon: '{% if "success" in message.tags %}success{% elif "error" in message.tags %}error{% elif "warning" in message.tags %}warning{% else %}info{% endif %}',
      title: '{{ message|escapejs }}'
    });
  {% endfor %}
</script>
{% endif %}

{% comment %} modal para editar  {% endcomment %}

<!-- Modal Editar Estudiante -->
<div class="modal fade" id="modalEditarEstudiante" tabindex="-1" aria-labelledby="modalEditarEstudianteLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <form method="POST" action="{% url 'editar_estudiante_docente' %}">
        {% csrf_token %}
        <input type="hidden" name="editar_matricula" value="1">
        <input type="hidden" name="matricula_id">
        <input type="hidden" name="clase_id" value="{{ clase.cla_id }}">

        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="modalEditarEstudianteLabel">Editar estudiante matriculado</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="row ">
            <div class="col-md-6">
              <label class="form-label" >Nombre</label>
              <input type="text" name="nombre" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">Segundo nombre</label>
              <input type="text" name="segundo_nombre" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">Apellido</label>
              <input type="text" name="apellido" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">Segundo apellido</label>
              <input type="text" name="segundo_apellido" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">Correo electrónico</label>
              <input type="email" name="email" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">Cédula</label>
              <input type="text" name="cedula" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">Teléfono</label>
              <input type="text" name="telefono" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">Fecha de nacimiento</label>
              <input type="date" name="fecha_nacimiento" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">Contacto de emergencia</label>
              <input type="text" name="contacto_emergencia" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">Teléfono de emergencia</label>
              <input type="text" name="telefono_emergencia" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label" for="edit_password">Contraseña (opcional)</label>
              <input type="password" name="password" id="edit_password" class="form-control">
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Actualizar</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% comment %} modal para eliminar de esta clase {% endcomment %}
 <!-- Modal de Confirmación para Eliminar -->
<div class="modal fade" id="modalEliminarMatricula" tabindex="-1" aria-labelledby="modalEliminarLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="{% url 'eliminar_matricula' %}">
        {% csrf_token %}
        <input type="hidden" name="matricula_id" id="eliminar_matricula_id">
        <input type="hidden" name="clase_id" value="{{ clase.cla_id }}">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="modalEliminarLabel">Confirmar eliminación</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          ¿Estás seguro de que deseas eliminar a este estudiante de la clase?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-danger">Eliminar</button>
        </div>
      </form>
    </div>
  </div>
</div>






{% block js %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    const contenedorTabla = document.getElementById("contenedor-tabla-matriculados-docente");
    const claId = contenedorTabla.dataset.claId;
    recargarTablaMatriculados(claId);
});

// FUNCION PARA CARGAR LA TABLA
function recargarTablaMatriculados(claseId) {
    const contenedorTabla = document.getElementById("contenedor-tabla-matriculados-docente");
    const scrollPosition = contenedorTabla.scrollTop;

    fetch(`/docente/clase/${claseId}/tabla-matriculados/`)
        .then(response => response.text())
        .then(html => {
            contenedorTabla.innerHTML = html;

            // Activar DataTable si está presente
            $('#tbl-matriculados-docente').DataTable({
                language: {
                    search: "Buscar:",
                    lengthMenu: "Mostrar _MENU_ registros",
                    info: "Mostrando del _START_ al _END_ de _TOTAL_ registros",
                    paginate: {
                        first: "Primero",
                        last: "Último",
                        next: "Siguiente",
                        previous: "Anterior"
                    }
                }
            });

            contenedorTabla.scrollTop = scrollPosition;
        })
        .catch(error => {
            contenedorTabla.innerHTML = `<div class="alert alert-danger">Error cargando tabla: ${error}</div>`;
        });
}

//funcion  para el modal de editar 
function abrirModalEditar(matriculaId) {
    fetch(`/ajax/estudiante/${matriculaId}/`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const estudiante = data.data;
            document.querySelector('#modalEditarEstudiante input[name="matricula_id"]').value = estudiante.matricula_id;
            document.querySelector('#modalEditarEstudiante input[name="nombre"]').value = estudiante.nombre;
            document.querySelector('#modalEditarEstudiante input[name="apellido"]').value = estudiante.apellido;
            document.querySelector('#modalEditarEstudiante input[name="email"]').value = estudiante.email;
            document.querySelector('#modalEditarEstudiante input[name="segundo_nombre"]').value = estudiante.segundo_nombre;
            document.querySelector('#modalEditarEstudiante input[name="segundo_apellido"]').value = estudiante.segundo_apellido;
            document.querySelector('#modalEditarEstudiante input[name="cedula"]').value = estudiante.cedula;
            document.querySelector('#modalEditarEstudiante input[name="telefono"]').value = estudiante.telefono;
            document.querySelector('#modalEditarEstudiante input[name="fecha_nacimiento"]').value = estudiante.fecha_nacimiento;
            document.querySelector('#modalEditarEstudiante input[name="contacto_emergencia"]').value = estudiante.contacto_emergencia;
            document.querySelector('#modalEditarEstudiante input[name="telefono_emergencia"]').value = estudiante.telefono_emergencia;

            new bootstrap.Modal(document.getElementById('modalEditarEstudiante')).show();
        } else {
            alert('No se pudo cargar el estudiante');
        }
    });
}

//funcion para el modal de eliminacion 
function abrirModalEliminar(matriculaId) {
    document.getElementById('eliminar_matricula_id').value = matriculaId;
    let modal = new bootstrap.Modal(document.getElementById('modalEliminarMatricula'));
    modal.show();
}

// ÚNICO CONTROLADOR DE IMPORTACIÓN - COMBINADO Y MEJORADO
document.getElementById('form-importar-excel').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const button = this.querySelector('button[type="submit"]');
    const mensajeContainer = document.getElementById('mensaje-container');
    const cla_id = document.getElementById("cla_id").value;
    
    // Verificar que se seleccionó un archivo
    const archivo = document.getElementById('archivo').files[0];
    if (!archivo) {
        mostrarMensaje(false, 'Por favor selecciona un archivo Excel');
        return;
    }
    
    // Verificar que es un archivo Excel
    if (!archivo.name.endsWith('.xlsx') && !archivo.name.endsWith('.xls')) {
        mostrarMensaje(false, 'El archivo debe ser un Excel (.xlsx o .xls)');
        return;
    }
    
    // Guardar texto original del botón
    const originalText = button.textContent;
    
    // Mostrar indicador de carga
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Procesando...';
    button.disabled = true;
    
    // Ocultar mensajes anteriores
    if (mensajeContainer) {
        mensajeContainer.style.display = 'none';
        mensajeContainer.innerHTML = '';
    }
    
    // Hacer la petición con la URL correcta de Django
    fetch("{% url 'importar_estudiantes_excel_docente' %}", {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers.get('content-type'));
        
        // Verificar si la respuesta es exitosa
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // Verificar que la respuesta es JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('La respuesta del servidor no es JSON válido');
        }
        
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        
        // Verificar que la respuesta tiene la estructura esperada
        if (typeof data.success === 'undefined' || typeof data.message === 'undefined') {
            throw new Error('Respuesta del servidor incompleta');
        }
        
        if (data.success) {
            // Si hay contenedor de mensajes, usarlo, sino usar alert como fallback
            if (mensajeContainer) {
                mostrarMensaje(data.success, data.message);
            } else {
                alert(data.message);
            }
            
            // Limpiar el formulario y recargar tabla
            this.reset();
            recargarTablaMatriculados(cla_id);
        } else {
            // Error desde el servidor
            if (mensajeContainer) {
                mostrarMensaje(data.success, data.message);
            } else {
                alert("Error: " + data.message);
            }
        }
    })
    .catch(error => {
        console.error('Error completo:', error);
        
        // Mostrar error específico
        let errorMessage = 'Error al procesar el archivo';
        
        if (error.message.includes('JSON')) {
            errorMessage = 'Error del servidor: La respuesta no es válida. Revisa los logs del servidor.';
        } else if (error.message.includes('HTTP error')) {
            errorMessage = `Error del servidor (${error.message}). Revisa los logs.`;
        } else {
            errorMessage = `Error: ${error.message}`;
        }
        
        // Si hay contenedor de mensajes, usarlo, sino usar alert
        if (mensajeContainer) {
            mostrarMensaje(false, errorMessage);
        } else {
            alert("Ocurrió un error al importar el archivo: " + errorMessage);
        }
    })
    .finally(() => {
        // SIEMPRE restaurar el botón, sin importar si fue éxito o error
        button.innerHTML = originalText;
        button.disabled = false;
    });
});

// Función para mostrar mensajes (solo si existe el contenedor)
function mostrarMensaje(success, message) {
    const container = document.getElementById('mensaje-container');
    
    // Si no existe el contenedor, usar alert como fallback
    if (!container) {
        alert(message);
        return;
    }
    
    // Determinar el tipo de alerta
    const alertType = success ? 'alert-success' : 'alert-danger';
    const icon = success ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle';
    
    // Convertir saltos de línea en elementos organizados
    let messageHtml = '';
    if (message.includes('\n')) {
        const lines = message.split('\n');
        const mainMessage = lines[0];
        const details = lines.slice(1).filter(line => line.trim());
        
        messageHtml = `
            <div class="alert ${alertType} alert-dismissible fade show" role="alert">
                <i class="${icon} me-2"></i>
                <strong>${mainMessage}</strong>
                ${details.length > 0 ? `
                    <hr class="my-2">
                    <div class="small">
                        ${details.map(detail => `<div class="mb-1"><i class="fas fa-info-circle me-1"></i>${detail}</div>`).join('')}
                    </div>
                ` : ''}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
    } else {
        messageHtml = `
            <div class="alert ${alertType} alert-dismissible fade show" role="alert">
                <i class="${icon} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
    }
    
    container.innerHTML = messageHtml;
    container.style.display = 'block';
    
    // Scroll hacia el mensaje suavemente
    container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    
    // Auto-cerrar mensaje de éxito después de 8 segundos
    if (success) {
        setTimeout(() => {
            const alert = container.querySelector('.alert');
            if (alert) {
                if (typeof bootstrap !== 'undefined' && bootstrap.Alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                } else {
                    alert.style.opacity = '0';
                    setTimeout(() => {
                        if (alert.parentNode) {
                            alert.parentNode.removeChild(alert);
                            container.style.display = 'none';
                        }
                    }, 150);
                }
            }
        }, 5000);
    }
}
</script>

{% endblock %}

{% endblock %}