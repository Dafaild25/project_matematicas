{% extends 'plantillas/MasterAdmin.html' %}
{% load static %}
{% block title %}
M√≥dulo 1 - N√∫meros M√°gicos
{% endblock %}

{% block css %}
    <style>
        body {
            background: linear-gradient(-45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #ffa726, #ef5350);
            background-size: 400% 400%;
            animation: rainbowShift 8s ease infinite;
            min-height: 100vh;
            font-family: 'Comic Sans MS', cursive, sans-serif;
            overflow-x: hidden;
        }

        @keyframes rainbowShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .main-container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .header-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            text-align: center;
            animation: bounceIn 1s ease-out;
            border: 5px solid #ff6b6b;
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }

        .header-card h1 {
            color: #ff6b6b;
            font-size: 3rem;
            font-weight: 900;
            margin-bottom: 15px;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.3);
            animation: wiggle 2s ease-in-out infinite;
        }

        @keyframes wiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(1deg); }
            75% { transform: rotate(-1deg); }
        }

        .header-card p {
            color: #333;
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .game-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            border: 5px solid #4ecdc4;
            animation: slideInUp 1s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(100px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .instruction-card {
            background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 100%);
            color: white;
            padding: 25px;
            border-radius: 25px;
            margin-bottom: 30px;
            text-align: center;
            font-size: 1.8rem;
            font-weight: 800;
            box-shadow: 0 15px 30px rgba(255, 107, 107, 0.4);
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { box-shadow: 0 15px 30px rgba(255, 107, 107, 0.4); }
            to { box-shadow: 0 15px 30px rgba(255, 107, 107, 0.8); }
        }

        .numbers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .number-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 100%);
            border: none;
            border-radius: 25px;
            padding: 30px 20px;
            font-size: 2.5rem;
            font-weight: 900;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 15px 30px rgba(255, 107, 107, 0.4);
            position: relative;
            overflow: hidden;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            animation: numberFloat 4s ease-in-out infinite;
        }

        @keyframes numberFloat {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            25% { transform: translateY(-5px) rotate(1deg); }
            75% { transform: translateY(5px) rotate(-1deg); }
        }

        .number-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.6s;
        }

        .number-btn:hover::before {
            left: 100%;
        }

        .number-btn:hover {
            transform: scale(1.2) translateY(-10px) rotate(5deg);
            box-shadow: 0 25px 50px rgba(255, 107, 107, 0.6);
            animation-play-state: paused;
        }

        .number-btn:active {
            transform: scale(1.1) translateY(-5px);
        }

        .number-btn.selected {
            background: linear-gradient(135deg, #ffa726 0%, #ff9800 100%);
            box-shadow: 0 15px 30px rgba(255, 167, 38, 0.6);
            transform: scale(1.1);
            border: 4px solid #fff;
        }

        .number-btn.correct-answer {
            background: linear-gradient(135deg, #96ceb4 0%, #45b7d1 100%);
            box-shadow: 0 15px 30px rgba(150, 206, 180, 0.6);
            animation: correctCelebration 1s ease;
        }

        .number-btn.incorrect-answer {
            background: linear-gradient(135deg, #ef5350 0%, #ffa726 100%);
            box-shadow: 0 15px 30px rgba(239, 83, 80, 0.6);
            animation: incorrectShake 0.6s ease;
        }

        @keyframes correctCelebration {
            0% { transform: scale(1); }
            25% { transform: scale(1.3) rotate(10deg); }
            50% { transform: scale(1.4) rotate(-10deg); }
            75% { transform: scale(1.3) rotate(10deg); }
            100% { transform: scale(1.2); }
        }

        @keyframes incorrectShake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-15px) rotate(-5deg); }
            20%, 40%, 60%, 80% { transform: translateX(15px) rotate(5deg); }
        }

        .answer-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 100%);
            color: white;
            border: none;
            padding: 20px 50px;
            border-radius: 50px;
            font-size: 1.8rem;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 15px 30px rgba(255, 107, 107, 0.4);
            display: block;
            margin: 0 auto;
            animation: rainbow 3s ease-in-out infinite;
        }

        @keyframes rainbow {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }

        .answer-btn:hover {
            transform: scale(1.1) translateY(-5px);
            box-shadow: 0 20px 40px rgba(255, 107, 107, 0.6);
        }

        .answer-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            animation: none;
        }

        .floating-elements {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .floating-element {
            position: absolute;
            font-size: 2rem;
            animation: floatAround 8s infinite ease-in-out;
            opacity: 0.7;
        }

        @keyframes floatAround {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.7; }
            25% { transform: translateY(-30px) rotate(90deg); opacity: 1; }
            50% { transform: translateY(-20px) rotate(180deg); opacity: 0.8; }
            75% { transform: translateY(-40px) rotate(270deg); opacity: 1; }
        }

        .confetti {
            position: fixed;
            top: -10px;
            background-color: #f0f0f0;
            width: 10px;
            height: 10px;
            animation: confetti 3s ease-in-out infinite;
            pointer-events: none;
            z-index: 1000;
        }

        @keyframes confetti {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .question-counter {
            background: linear-gradient(135deg, #45b7d1 0%, #96ceb4 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 20px;
            text-align: center;
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 20px;
            box-shadow: 0 10px 20px rgba(69, 183, 209, 0.3);
        }

        /* Estilo para la tabla de opciones m√∫ltiples */
        .multiple-choice-table {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .multiple-choice-table h3 {
            color: #ff6b6b;
            text-align: center;
            font-size: 1.8rem;
            margin-bottom: 20px;
            font-weight: 800;
        }

        .choice-row {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.7);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 3px solid transparent;
        }

        .choice-row:hover {
            background: rgba(255, 107, 107, 0.1);
            transform: translateX(10px);
        }

        .choice-row.selected {
            background: rgba(255, 167, 38, 0.2);
            border-color: #ffa726;
            transform: translateX(10px);
        }

        .choice-label {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
            margin-right: 20px;
            min-width: 200px;
        }

        .choice-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .choice-option {
            background: linear-gradient(135deg, #4ecdc4 0%, #45b7d1 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 15px;
            font-size: 1.3rem;
            font-weight: 700;
            min-width: 60px;
            text-align: center;
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .choice-option:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 16px rgba(78, 205, 196, 0.4);
        }

        .choice-option.selected {
            background: linear-gradient(135deg, #ffa726 0%, #ff9800 100%);
            border-color: #fff;
            transform: scale(1.1);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-card h1 { font-size: 2.5rem; }
            .header-card p { font-size: 1.5rem; }
            .numbers-grid { grid-template-columns: repeat(2, 1fr); gap: 20px; }
            .number-btn { font-size: 2rem; padding: 25px 15px; }
            .main-container { padding: 15px; }
            .choice-row { flex-direction: column; align-items: flex-start; }
            .choice-label { margin-bottom: 10px; min-width: auto; }
        }

        @media (max-width: 480px) {
            .header-card h1 { font-size: 2rem; }
            .header-card p { font-size: 1.3rem; }
            .number-btn { font-size: 1.8rem; padding: 20px 12px; }
            .instruction-card { font-size: 1.5rem; }
        }

        /* Estilos para drag and drop */
.drag-drop-question {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 30px;
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    display: none;
}

.drag-numbers-to-sort {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 30px;
    flex-wrap: wrap;
}

.drag-sortable-number {
    background: linear-gradient(45deg, #4CAF50, #45a049);
    color: white;
    padding: 15px 20px;
    border-radius: 10px;
    cursor: grab;
    font-weight: bold;
    font-size: 18px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
    user-select: none;
}

.drag-sortable-number:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.3);
}

.drag-sortable-number.dragging {
    opacity: 0.5;
    transform: rotate(5deg);
    cursor: grabbing;
}

.drag-drop-zone {
    background: #f1f3f4;
    border: 2px dashed #ddd;
    border-radius: 10px;
    padding: 20px;
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 20px;
    min-height: 80px;
    align-items: center;
    flex-wrap: wrap;
}

.drag-drop-slot {
    width: 80px;
    height: 60px;
    border: 2px dashed #ccc;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    background: white;
    transition: all 0.3s ease;
}

.drag-drop-slot::before {
    content: attr(data-position);
    position: absolute;
    top: -25px;
    font-size: 12px;
    color: #666;
    font-weight: bold;
}

.drag-drop-slot.drag-over {
    border-color: #4CAF50;
    background: #e8f5e8;
    transform: scale(1.05);
}

.drag-drop-slot.filled {
    border-color: #4CAF50;
    background: #e8f5e8;
}

.drag-dropped-number {
    background: linear-gradient(45deg, #2196F3, #1976D2);
    color: white;
    padding: 10px;
    border-radius: 6px;
    font-weight: bold;
    cursor: grab;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-sizing: border-box;
}
    </style>
{% endblock %}

{% block content %}
<div class="main-container">
    <div class="floating-elements" id="floating-elements"></div>
    
    <!-- Header Card -->
    <div class="header-card">
        <h1>üåà ¬°N√∫meros M√°gicos! üåà</h1>
        <p id="main-instruction">üîç ¬°Encuentra los n√∫meros que tengan 5, 6 y 7! üîç</p>
    </div>

    <!-- Game Card -->
    <div class="game-card">
        <!-- Question Counter -->
        <div class="question-counter" id="question-counter">
            <i class="fas fa-star mr-2"></i>
            Pregunta 1 de 3
            <i class="fas fa-star ml-2"></i>
        </div>

        <!-- Instructions -->
        <div class="instruction-card" id="instruction-card">
            <i class="fas fa-star mr-2"></i>
            ¬°Selecciona TODOS los n√∫meros que contengan <strong>5</strong>, <strong>6</strong> y <strong>7</strong>!
            <i class="fas fa-star ml-2"></i>
        </div>

        <!-- Numbers Grid (para preguntas normales) -->
        <div class="numbers-grid" id="numbers-container">
            <!-- Los n√∫meros se generar√°n con JavaScript -->
        </div>

        <!-- Multiple Choice Table (para la pregunta especial) -->
        <div class="multiple-choice-table" id="multiple-choice-container" style="display: none;">
            <h3>Presiona el n√∫mero que corresponde:</h3>
            
            <div class="choice-row" data-question="quinientos-ochenta-siete">
                <div class="choice-label">Quinientos ochenta y siete:</div>
                <div class="choice-options">
                    <div class="choice-option" data-value="578">578</div>
                    <div class="choice-option" data-value="687">687</div>
                    <div class="choice-option" data-value="587">587</div>
                </div>
            </div>

            <div class="choice-row" data-question="novecientos-dos">
                <div class="choice-label">Novecientos dos:</div>
                <div class="choice-options">
                    <div class="choice-option" data-value="902">902</div>
                    <div class="choice-option" data-value="900">900</div>
                    <div class="choice-option" data-value="912">912</div>
                </div>
            </div>

            <div class="choice-row" data-question="ciento-uno">
                <div class="choice-label">Ciento uno:</div>
                <div class="choice-options">
                    <div class="choice-option" data-value="110">110</div>
                    <div class="choice-option" data-value="101">101</div>
                    <div class="choice-option" data-value="100">100</div>
                </div>
            </div>

            <div class="choice-row" data-question="doscientos-doce">
                <div class="choice-label">Doscientos doce:</div>
                <div class="choice-options">
                    <div class="choice-option" data-value="202">202</div>
                    <div class="choice-option" data-value="212">212</div>
                    <div class="choice-option" data-value="122">122</div>
                </div>
            </div>
        </div>

        <!-- Drag and Drop Question -->
        <div class="drag-drop-question" id="drag-drop-container">
            <h3 style="color: #ff6b6b; text-align: center; font-size: 1.8rem; margin-bottom: 20px; font-weight: 800;">
                üìä ¬°Ordena los n√∫meros de mayor a menor! üìä
            </h3>
            <div class="drag-numbers-to-sort" id="drag-numbers-to-sort">
                <div class="drag-sortable-number" data-value="37" draggable="true">37</div>
                <div class="drag-sortable-number" data-value="10" draggable="true">10</div>  
                <div class="drag-sortable-number" data-value="25" draggable="true">25</div>
                <div class="drag-sortable-number" data-value="47" draggable="true">47</div>
                <div class="drag-sortable-number" data-value="15" draggable="true">15</div>
            </div>
            <div class="drag-drop-zone" id="drag-drop-zone">
                <div class="drag-drop-slot" data-position="1¬∞"></div>
                <div class="drag-drop-slot" data-position="2¬∞"></div>
                <div class="drag-drop-slot" data-position="3¬∞"></div>
                <div class="drag-drop-slot" data-position="4¬∞"></div>
                <div class="drag-drop-slot" data-position="5¬∞"></div>
            </div>
        </div>

        <!-- Answer Button -->
        <button class="answer-btn" id="answer-btn" onclick="checkAnswer()" disabled>
            <i class="fas fa-check mr-2"></i>
            ¬°RESPONDER!
        </button>
    </div>
</div>
{% endblock %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    let selectedNumbers = [];
    let currentNumbers = [];
    let currentQuestion = 1;
    let totalQuestions = 3; // Ahora son 11 preguntas
    let usedQuestions = new Set();
    let gameFinished = false;
    let multipleChoiceAnswers = {}; // Para almacenar las respuestas de opci√≥n m√∫ltiple

    // Respuestas correctas para la pregunta de opci√≥n m√∫ltiple
    const correctMultipleChoiceAnswers = {
        'quinientos-ochenta-siete': '587',
        'novecientos-dos': '902',
        'ciento-uno': '101',
        'doscientos-doce': '212'
    };

    // Crear elementos flotantes
    function createFloatingElements() {
        const container = document.getElementById('floating-elements');
        const elements = ['üåü', '‚≠ê', '‚ú®', 'üéà', 'üéâ', 'üéä', 'üåà', 'üí´', 'ü¶Ñ', 'üéØ'];
        
        for (let i = 0; i < 20; i++) {
            const element = document.createElement('div');
            element.className = 'floating-element';
            element.innerHTML = elements[Math.floor(Math.random() * elements.length)];
            element.style.left = Math.random() * 100 + '%';
            element.style.top = Math.random() * 100 + '%';
            element.style.animationDelay = Math.random() * 8 + 's';
            element.style.animationDuration = (Math.random() * 4 + 6) + 's';
            container.appendChild(element);
        }
    }

    // Verificar si un n√∫mero contiene los d√≠gitos 5, 6 y 7
    function containsDigits567(number) {
        const str = number.toString();
        return str.includes('5') && str.includes('6') && str.includes('7');
    }

    // Generar un conjunto √∫nico de n√∫meros para cada pregunta
    function generateUniqueNumbers() {
        let attempts = 0;
        let questionSet;
        
        do {
            questionSet = generateNumbers();
            attempts++;
        } while (usedQuestions.has(JSON.stringify(questionSet)) && attempts < 50);
        
        if (attempts < 50) {
            usedQuestions.add(JSON.stringify(questionSet));
        }
        
        return questionSet;
    }

    // Generar n√∫meros apropiados para ni√±os de 5 a√±os
    function generateNumbers() {
        // N√∫meros correctos que contengan 5, 6, 7
        const correctOptions = [
            567, 576, 657, 675, 756, 765,
            5671, 5672, 5673, 5674, 5675, 5676, 5677, 5678, 5679,
            6571, 6572, 6573, 6574, 6575, 6576, 6577, 6578, 6579,
            7561, 7562, 7563, 7564, 7565, 7566, 7567, 7568, 7569
        ];
        
        // Seleccionar 2-3 n√∫meros correctos aleatoriamente
        const numCorrect = Math.floor(Math.random() * 2) + 2; // 2 o 3
        const correctNumbers = [];
        const shuffledCorrect = [...correctOptions].sort(() => Math.random() - 0.5);
        
        for (let i = 0; i < numCorrect; i++) {
            correctNumbers.push(shuffledCorrect[i]);
        }

        // Generar n√∫meros incorrectos
        const incorrectNumbers = [];
        const incorrectOptions = [
            123, 234, 345, 456, 789, 890, 147, 258, 369, 
            159, 267, 348, 159, 753, 951, 357, 159, 753,
            125, 136, 147, 158, 169, 235, 246, 257, 268, 279,
            356, 367, 378, 389, 456, 467, 478, 489, 
            1234, 2345, 3456, 4567, 5678, 6789, 7890,
            1357, 2468, 1596, 2637, 3748, 4859
        ];
        
        const shuffledIncorrect = [...incorrectOptions].sort(() => Math.random() - 0.5);
        
        for (let i = 0; i < 6 - numCorrect; i++) {
            let num = shuffledIncorrect[i];
            if (!containsDigits567(num)) {
                incorrectNumbers.push(num);
            }
        }

        // Combinar y mezclar
        const allNumbers = [...correctNumbers, ...incorrectNumbers];
        return allNumbers.sort(() => Math.random() - 0.5);
    }

    // Mostrar la pregunta de opci√≥n m√∫ltiple
    // Funci√≥n corregida para la pregunta de opci√≥n m√∫ltiple
function showMultipleChoiceQuestion() {
    // Ocultar otros contenedores
    document.getElementById('numbers-container').style.display = 'none';
    document.getElementById('drag-drop-container').style.display = 'none';
    document.getElementById('multiple-choice-container').style.display = 'block';
    
    // Cambiar las instrucciones
    document.getElementById('main-instruction').innerHTML = 'üî¢ ¬°Identifica los n√∫meros escritos en palabras! üî¢';
    document.getElementById('instruction-card').innerHTML = `
        <i class="fas fa-star mr-2"></i>
        ¬°Presiona el n√∫mero que corresponde a cada palabra!
        <i class="fas fa-star ml-2"></i>
    `;

    // Limpiar respuestas anteriores
    multipleChoiceAnswers = {};
    
    // Limpiar selecciones visuales anteriores
    document.querySelectorAll('.choice-option').forEach(option => {
        option.classList.remove('selected');
        option.style.background = '';
        option.style.boxShadow = '';
    });
    
    document.querySelectorAll('.choice-row').forEach(row => {
        row.classList.remove('selected');
    });
    
    // Actualizar contador de preguntas
    document.getElementById('question-counter').innerHTML = `
        <i class="fas fa-star mr-2"></i>
        Pregunta ${currentQuestion} de ${totalQuestions}
        <i class="fas fa-star ml-2"></i>
    `;
    
    // Agregar event listeners a las opciones
    const choiceOptions = document.querySelectorAll('.choice-option');
    choiceOptions.forEach(option => {
        // Remover event listeners anteriores clonando el elemento
        const newOption = option.cloneNode(true);
        option.parentNode.replaceChild(newOption, option);
        
        newOption.addEventListener('click', function() {
            const row = this.closest('.choice-row');
            const question = row.dataset.question;
            const value = this.dataset.value;
            
            // Remover selecci√≥n anterior en esta fila
            row.querySelectorAll('.choice-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Seleccionar esta opci√≥n
            this.classList.add('selected');
            row.classList.add('selected');
            
            // Guardar respuesta
            multipleChoiceAnswers[question] = value;
            
            // Habilitar bot√≥n si todas las preguntas est√°n respondidas
            const totalQuestions = Object.keys(correctMultipleChoiceAnswers).length;
            const answeredQuestions = Object.keys(multipleChoiceAnswers).length;
            
            document.getElementById('answer-btn').disabled = answeredQuestions < totalQuestions;
        });
    });
    
    // Resetear bot√≥n de respuesta
    document.getElementById('answer-btn').disabled = true;
}

    // Mostrar n√∫meros en la pantalla
    function displayNumbers() {
    // Primero, ocultar TODOS los contenedores
    document.getElementById('numbers-container').style.display = 'none';
    document.getElementById('multiple-choice-container').style.display = 'none';
    document.getElementById('drag-drop-container').style.display = 'none';
    
    // Si es la √∫ltima pregunta (drag and drop)
    if (currentQuestion === totalQuestions) {
        showDragDropQuestion();
        return;
    }
    // Si es la segunda pregunta (opci√≥n m√∫ltiple)
    else if (currentQuestion === 2) {
        showMultipleChoiceQuestion();
        return;
    }
    
    // Pregunta normal (primera pregunta)
    document.getElementById('numbers-container').style.display = 'grid';
    
    const container = document.getElementById('numbers-container');
    container.innerHTML = '';
    selectedNumbers = [];
    
    currentNumbers = generateUniqueNumbers();
    
    currentNumbers.forEach((number, index) => {
        const button = document.createElement('button');
        button.className = 'number-btn';
        button.textContent = number;
        button.onclick = () => selectNumber(number, button);
        button.style.animationDelay = (index * 0.2) + 's';
        button.dataset.number = number;
        container.appendChild(button);
    });

    // Actualizar contador de preguntas
    document.getElementById('question-counter').innerHTML = `
        <i class="fas fa-star mr-2"></i>
        Pregunta ${currentQuestion} de ${totalQuestions}
        <i class="fas fa-star ml-2"></i>
    `;

    // Resetear bot√≥n de respuesta
    document.getElementById('answer-btn').disabled = true;
}

    // Seleccionar/deseleccionar n√∫mero
    function selectNumber(number, button) {
        if (gameFinished) return;

        const index = selectedNumbers.indexOf(number);
        
        if (index > -1) {
            // Deseleccionar
            selectedNumbers.splice(index, 1);
            button.classList.remove('selected');
        } else {
            // Seleccionar
            selectedNumbers.push(number);
            button.classList.add('selected');
        }

        // Habilitar/deshabilitar bot√≥n de respuesta
        document.getElementById('answer-btn').disabled = selectedNumbers.length === 0;
    }

    // Crear confeti
    function createConfetti() {
        const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffa726', '#ef5350'];
        
        for (let i = 0; i < 50; i++) {
            setTimeout(() => {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                document.body.appendChild(confetti);
                
                setTimeout(() => {
                    confetti.remove();
                }, 3000);
            }, i * 100);
        }
    }

// Mostrar la pregunta de drag and drop
function showDragDropQuestion() {
    // Ocultar otros contenedores
    document.getElementById('numbers-container').style.display = 'none';
    document.getElementById('multiple-choice-container').style.display = 'none';
    document.getElementById('drag-drop-container').style.display = 'block';
    
    // Cambiar las instrucciones
    document.getElementById('main-instruction').innerHTML = 'üìä ¬°Ordena los n√∫meros de p√°ginas de libros! üìä';
    document.getElementById('instruction-card').innerHTML = `
        <i class="fas fa-star mr-2"></i>
        ¬°Arrastra los n√∫meros para ordenarlos de MAYOR a MENOR seg√∫n las p√°ginas de los libros!
        <i class="fas fa-star ml-2"></i>
    `;

    // Actualizar contador de preguntas
    document.getElementById('question-counter').innerHTML = `
        <i class="fas fa-star mr-2"></i>
        Pregunta ${currentQuestion} de ${totalQuestions}
        <i class="fas fa-star ml-2"></i>
    `;

    // Resetear drag and drop
    resetDragDrop();
    
    // Inicializar drag and drop
    initDragDrop();
    
    // Deshabilitar bot√≥n hasta que se complete el ordenamiento
    document.getElementById('answer-btn').disabled = true;
}

// Variables para drag and drop
let draggedElement = null;
const correctDragOrder = [47,37,25, 15,10];

// Inicializar drag and drop
function initDragDrop() {
    const sortableNumbers = document.querySelectorAll('.drag-sortable-number');
    const dropSlots = document.querySelectorAll('.drag-drop-slot');

    // Limpiar slots
    dropSlots.forEach(slot => {
        const existing = slot.querySelector('.drag-dropped-number');
        if (existing) {
            existing.remove();
            slot.classList.remove('filled');
        }
    });

    // Restaurar n√∫meros originales
    sortableNumbers.forEach(number => {
        number.style.display = 'block';
        number.addEventListener('dragstart', handleDragStart);
        number.addEventListener('dragend', handleDragEnd);
    });

    // Event listeners para slots
    dropSlots.forEach(slot => {
        slot.addEventListener('dragover', handleDragOver);
        slot.addEventListener('drop', handleDrop);
        slot.addEventListener('dragenter', handleDragEnter);
        slot.addEventListener('dragleave', handleDragLeave);
    });
}

// Funciones de drag and drop
function handleDragStart(e) {
    draggedElement = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
}

function handleDragEnd(e) {
    this.classList.remove('dragging');
    draggedElement = null;
}

function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    return false;
}

function handleDragEnter(e) {
    if (!this.querySelector('.drag-dropped-number')) {
        this.classList.add('drag-over');
    }
}

function handleDragLeave(e) {
    this.classList.remove('drag-over');
}

// Funci√≥n mejorada para verificar si el drag and drop est√° completo
function checkDragDropComplete() {
    const dropSlots = document.querySelectorAll('.drag-drop-slot');
    let filledSlots = 0;
    
    dropSlots.forEach(slot => {
        if (slot.querySelector('.drag-dropped-number')) {
            filledSlots++;
        }
    });
    
    // Habilitar bot√≥n solo cuando todos los slots est√©n llenos
    document.getElementById('answer-btn').disabled = filledSlots < dropSlots.length;
}

function handleDrop(e) {
    e.stopPropagation();
    this.classList.remove('drag-over');

    if (this.querySelector('.drag-dropped-number')) {
        return false;
    }

    if (draggedElement) {
        const droppedNumber = document.createElement('div');
        droppedNumber.className = 'drag-dropped-number';
        droppedNumber.textContent = draggedElement.textContent;
        droppedNumber.setAttribute('data-value', draggedElement.getAttribute('data-value'));
        droppedNumber.draggable = true;

        droppedNumber.addEventListener('dragstart', handleDroppedDragStart);
        droppedNumber.addEventListener('dragend', handleDragEnd);

        this.appendChild(droppedNumber);
        this.classList.add('filled');
        draggedElement.style.display = 'none';
        
        // Verificar si el drag and drop est√° completo
        checkDragDropComplete();
    }
    return false;
}

function handleDroppedDragStart(e) {
    draggedElement = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    
    // Permitir arrastrar de vuelta al √°rea de n√∫meros
    const numbersArea = document.getElementById('drag-numbers-to-sort');
    numbersArea.addEventListener('dragover', handleNumbersAreaDragOver);
    numbersArea.addEventListener('drop', handleNumbersAreaDrop);
}

// Manejar drag over en el √°rea de n√∫meros
function handleNumbersAreaDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
}

// Manejar drop en el √°rea de n√∫meros (devolver n√∫mero)
function handleNumbersAreaDrop(e) {
    e.stopPropagation();
    
    if (draggedElement && draggedElement.classList.contains('drag-dropped-number')) {
        // Encontrar el n√∫mero original
        const originalNumbers = document.querySelectorAll('.drag-sortable-number');
        const value = draggedElement.getAttribute('data-value');
        
        originalNumbers.forEach(num => {
            if (num.getAttribute('data-value') === value) {
                num.style.display = 'block';
            }
        });
        
        // Remover de la slot
        const slot = draggedElement.parentNode;
        slot.classList.remove('filled');
        draggedElement.remove();
        
        // Verificar completitud
        checkDragDropComplete();
    }
}

// Verificar orden de drag and drop
function checkDragDropOrder() {
    const dropSlots = document.querySelectorAll('.drag-drop-slot');
    const userOrder = [];
    let hasEmptySlots = false;

    dropSlots.forEach(slot => {
        const droppedNumber = slot.querySelector('.drag-dropped-number');
        if (droppedNumber) {
            userOrder.push(parseInt(droppedNumber.getAttribute('data-value')));
        } else {
            hasEmptySlots = true;
        }
    });

    if (hasEmptySlots) {
        return { isCorrect: false, message: '¬°Completa todos los espacios antes de verificar!' };
    }

    const isCorrect = userOrder.every((value, index) => value === correctDragOrder[index]);
    
    return {
        isCorrect: isCorrect,
        message: isCorrect ? 
            'üéâ ¬°Excelente! Has ordenado correctamente los n√∫meros de mayor a menor.' :
            '‚ùå El orden no es correcto. Recuerda: debe ser de MAYOR a MENOR. ¬°Int√©ntalo de nuevo!'
    };
}

   // Verificar respuesta
function checkAnswer() {
    if (gameFinished) return;

    gameFinished = true;
    
    let isCorrect = false;
    let feedback = '';
    // Si es la pregunta de drag and drop
    if (currentQuestion === totalQuestions) {
        const dragResult = checkDragDropOrder();
        isCorrect = dragResult.isCorrect;
        feedback = dragResult.message;
    }

    // Si es la pregunta de opci√≥n m√∫ltiple
    else if (currentQuestion === 2) {
        let correctAnswers = 0;
        let totalQuestions = Object.keys(correctMultipleChoiceAnswers).length;
        
        // Verificar cada respuesta
        for (let question in correctMultipleChoiceAnswers) {
            const userAnswer = multipleChoiceAnswers[question];
            const correctAnswer = correctMultipleChoiceAnswers[question];
            
            // Marcar visualmente las respuestas
            const row = document.querySelector(`[data-question="${question}"]`);
            const options = row.querySelectorAll('.choice-option');
            
            options.forEach(option => {
                const value = option.dataset.value;
                if (value === correctAnswer) {
                    option.style.background = 'linear-gradient(135deg, #96ceb4 0%, #45b7d1 100%)';
                    option.style.boxShadow = '0 8px 16px rgba(150, 206, 180, 0.6)';
                } else if (value === userAnswer && value !== correctAnswer) {
                    option.style.background = 'linear-gradient(135deg, #ef5350 0%, #ffa726 100%)';
                    option.style.boxShadow = '0 8px 16px rgba(239, 83, 80, 0.6)';
                }
            });
            
            if (userAnswer === correctAnswer) {
                correctAnswers++;
            }
        }
        
        isCorrect = correctAnswers === totalQuestions;
        feedback = isCorrect ? 
            `¬°Perfecto! üéâ Identificaste correctamente todos los n√∫meros.` :
            `F√≠jate bien en el orden de las palabras. ¬°Sigue practicando! üòä`;
            
    } else {
        // Pregunta normal de n√∫meros con 5, 6, 7
        const correctNumbers = currentNumbers.filter(num => containsDigits567(num));
        
        // Verificar si la respuesta es correcta
        const selectedCorrect = selectedNumbers.filter(num => containsDigits567(num));
        const selectedIncorrect = selectedNumbers.filter(num => !containsDigits567(num));
        
        isCorrect = selectedCorrect.length === correctNumbers.length && 
                   selectedIncorrect.length === 0 && 
                   correctNumbers.every(num => selectedNumbers.includes(num));

        // Marcar visualmente los n√∫meros
        const buttons = document.querySelectorAll('.number-btn');
        buttons.forEach(button => {
            const number = parseInt(button.dataset.number);
            const wasSelected = selectedNumbers.includes(number);
            const shouldBeSelected = containsDigits567(number);
            
            if (shouldBeSelected && wasSelected) {
                // Correcto - seleccionado y deb√≠a ser seleccionado
                button.classList.add('correct-answer');
            } else if (shouldBeSelected && !wasSelected) {
                // Incorrecto - no seleccionado pero deb√≠a ser seleccionado
                button.classList.add('correct-answer');
                button.style.border = '4px solid #96ceb4';
            } else if (!shouldBeSelected && wasSelected) {
                // Incorrecto - seleccionado pero no deb√≠a ser seleccionado
                button.classList.add('incorrect-answer');
            }
        });

        // Generar feedback espec√≠fico
        if (isCorrect) {
            feedback = `¬°Excelente! üéâ Todos contienen los d√≠gitos 5, 6 y 7.`;
        } else {
            const missed = correctNumbers.filter(num => !selectedNumbers.includes(num));
            const wrong = selectedNumbers.filter(num => !containsDigits567(num));
            
            feedback = `¬°Buen intento! üòä `;
            if (missed.length > 0) {
                feedback += `Recuerda que deben tener TODOS los d√≠gitos: 5, 6 y 7. `;
            }
            
        }
    }

    // Mostrar resultado
    setTimeout(() => {
        if (isCorrect) {
            createConfetti();
            Swal.fire({
                icon: 'success',
                title: '¬°FANT√ÅSTICO! üåü',
                text: feedback,
                confirmButtonText: currentQuestion < totalQuestions ? '¬°Siguiente pregunta!' : '¬°Terminar juego!',
                allowOutsideClick: false,
                customClass: {
                    popup: 'animated bounceIn',
                    confirmButton: 'btn btn-success'
                }
            }).then(() => {
                nextQuestion();
            });
        } else {
            Swal.fire({
                icon: 'info',
                title: '¬°Sigue intentando! üí™',
                text: feedback,
                confirmButtonText: 'Continuar',
                allowOutsideClick: false,
                customClass: {
                    popup: 'animated shake',
                    confirmButton: 'btn btn-primary'
                }
            }).then(() => {
                nextQuestion();
            });
        }
    }, 1500);
}

// Pasar a la siguiente pregunta
function nextQuestion() {
    if (currentQuestion >= totalQuestions) {
        // Juego terminado
        showFinalResults();
    } else {
        // Siguiente pregunta
        currentQuestion++;
        gameFinished = false;
        displayNumbers();
    }
}

// Mostrar resultados finales
function showFinalResults() {
    Swal.fire({
        icon: 'success',
        title: '¬°JUEGO COMPLETADO! üèÜ',
        html: `
            <div style="font-size: 1.2em; margin: 20px 0;">
                <p>üéâ ¬°Felicitaciones por completar todos los desaf√≠os de n√∫meros m√°gicos! üéâ</p>
                
                <p>üìö ¬°Has aprendido mucho hoy sigue asi! üìö</p>
                <br>
                <p style="color: #ff6b6b; font-weight: bold;">¬°Eres incre√≠ble! ü¶Ñ</p>
            </div>
        `,
        confirmButtonText: 'üéÆ ¬°Jugar de nuevo!',
        cancelButtonText: 'üè† Volver al men√∫',
        showCancelButton: true,
        allowOutsideClick: false,
        customClass: {
            popup: 'animated tada',
            confirmButton: 'btn btn-success',
            cancelButton: 'btn btn-secondary'
        }
    }).then((result) => {
        if (result.isConfirmed) {
            resetGame();
        } else {
            // Aqu√≠ puedes agregar la l√≥gica para volver al men√∫ principal
            window.location.reload();
        }
    });
}

// Funci√≥n corregida para reiniciar el juego
function resetGame() {
    currentQuestion = 1;
    selectedNumbers = [];
    currentNumbers = [];
    usedQuestions.clear();
    gameFinished = false;
    multipleChoiceAnswers = {};
    
    // Ocultar TODOS los contenedores de preguntas
    document.getElementById('numbers-container').style.display = 'grid';
    document.getElementById('multiple-choice-container').style.display = 'none';
    document.getElementById('drag-drop-container').style.display = 'none';
    
    // Restaurar instrucciones originales
    document.getElementById('main-instruction').innerHTML = 'üîç ¬°Encuentra los n√∫meros que tengan 5, 6 y 7! üîç';
    document.getElementById('instruction-card').innerHTML = `
        <i class="fas fa-star mr-2"></i>
        ¬°Selecciona TODOS los n√∫meros que contengan <strong>5</strong>, <strong>6</strong> y <strong>7</strong>!
        <i class="fas fa-star ml-2"></i>
    `;
    
    // Limpiar selecciones de opci√≥n m√∫ltiple
    document.querySelectorAll('.choice-option').forEach(option => {
        option.classList.remove('selected');
        option.style.background = '';
        option.style.boxShadow = '';
    });
    
    document.querySelectorAll('.choice-row').forEach(row => {
        row.classList.remove('selected');
    });
    
    // Limpiar drag and drop
    resetDragDrop();
    
    // Iniciar nueva partida
    displayNumbers();
}

// Nueva funci√≥n para limpiar el drag and drop
function resetDragDrop() {
    const dropSlots = document.querySelectorAll('.drag-drop-slot');
    const sortableNumbers = document.querySelectorAll('.drag-sortable-number');
    
    // Limpiar slots
    dropSlots.forEach(slot => {
        const existing = slot.querySelector('.drag-dropped-number');
        if (existing) {
            existing.remove();
        }
        slot.classList.remove('filled', 'drag-over');
    });
    
    // Restaurar n√∫meros originales
    sortableNumbers.forEach(number => {
        number.style.display = 'block';
        number.classList.remove('dragging');
    });
}
// Funciones de utilidad adicionales
function playSound(type) {
    // Funci√≥n para reproducir sonidos (opcional)
    // Puedes implementar sonidos usando Web Audio API si lo deseas
    try {
        if (type === 'correct') {
            // Sonido de √©xito
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmYfCzef0fPNeyYELIjN8NSLORsP...');
            audio.play();
        } else if (type === 'incorrect') {
            // Sonido de error
        }
    } catch (e) {
        // Ignorar errores de audio
    }
}

// Agregar efectos de sonido al hacer clic
function addClickEffects() {
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('number-btn') || 
            e.target.classList.contains('choice-option')) {
            
            // Crear efecto visual de clic
            const ripple = document.createElement('div');
            ripple.style.cssText = `
                position: absolute;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.6);
                animation: ripple 0.6s linear;
                pointer-events: none;
                z-index: 1000;
            `;
            
            const rect = e.target.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = (rect.left + rect.width / 2 - size / 2) + 'px';
            ripple.style.top = (rect.top + rect.height / 2 - size / 2) + 'px';
            
            document.body.appendChild(ripple);
            
            setTimeout(() => {
                ripple.remove();
            }, 600);
        }
    });
}

// Agregar animaci√≥n de ripple en CSS
const rippleStyle = document.createElement('style');
rippleStyle.textContent = `
    @keyframes ripple {
        0% {
            transform: scale(0);
            opacity: 1;
        }
        100% {
            transform: scale(4);
            opacity: 0;
        }
    }
`;
document.head.appendChild(rippleStyle);

// Inicializar el juego cuando la p√°gina carga
document.addEventListener('DOMContentLoaded', function() {
    createFloatingElements();
    addClickEffects();
    displayNumbers();
    
    // Agregar atajo de teclado para responder (tecla Enter)
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !document.getElementById('answer-btn').disabled) {
            checkAnswer();
        }
    });
    
    // Configurar SweetAlert2 con estilos personalizados
    const swalStyle = document.createElement('style');
    swalStyle.textContent = `
        .swal2-popup {
            font-family: 'Comic Sans MS', cursive, sans-serif !important;
            border-radius: 20px !important;
        }
        .swal2-title {
            color: #ff6b6b !important;
            font-weight: 900 !important;
        }
        .swal2-confirm {
            background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 100%) !important;
            border: none !important;
            border-radius: 25px !important;
            font-weight: 700 !important;
            padding: 12px 30px !important;
        }
        .swal2-cancel {
            background: linear-gradient(135deg, #96ceb4 0%, #45b7d1 100%) !important;
            border: none !important;
            border-radius: 25px !important;
            font-weight: 700 !important;
            padding: 12px 30px !important;
        }
    `;
    document.head.appendChild(swalStyle);
});

// Funci√≥n para detectar si es un dispositivo m√≥vil
function isMobileDevice() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

// Ajustar el juego para dispositivos m√≥viles
if (isMobileDevice()) {
    document.addEventListener('DOMContentLoaded', function() {
        // Ajustar tama√±os para m√≥viles
        const style = document.createElement('style');
        style.textContent = `
            @media (max-width: 768px) {
                .number-btn:hover {
                    transform: scale(1.1) !important;
                }
                .choice-option:hover {
                    transform: scale(1.05) !important;
                }
            }
        `;
        document.head.appendChild(style);
    });
}
</script>
{% endblock %}